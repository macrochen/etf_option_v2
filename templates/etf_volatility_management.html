{% extends "base.html" %}

{% block content %}
    <div class="container mt-4">
        <h1 class="text-center mb-4">ETFæ³¢åŠ¨ç‡ç®¡ç†</h1>
        
        <!-- åŠ è½½åŠ¨ç”» -->
        <div class="loading" id="loading">
            <div class="loading-content">
                <div class="spinner-border" role="status">
                    <span class="sr-only">åŠ è½½ä¸­...</span>
                </div>
                <p>æ•°æ®åŠ è½½ä¸­ï¼Œè¯·ç¨å...</p>
            </div>
        </div>

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>ETFä»£ç </th>
                    <th>ETFåç§°</th>
                    <th>èµ·æ­¢æ—¶é—´</th>
                    <th>å½“å‰ä»·æ ¼</th>
                    <th>æ³¢åŠ¨ç‡</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="stockList">
                <!-- è¿™é‡Œå°†åŠ¨æ€å¡«å……ETFæ•°æ® -->
            </tbody>
        </table>

        <!-- ä¿®æ”¹ loadETFList å‡½æ•°ä¸­çš„è¡Œç”Ÿæˆä»£ç  -->
        <script>
            function loadETFList() {
                // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                document.getElementById('loading').style.display = 'flex';

                fetch('/api/etf_list')
                    .then(response => response.json())
                    .then(data => {
                        const stockList = document.getElementById('stockList');
                        stockList.innerHTML = '';
                        data.forEach(etf => {
                            const row = document.createElement('tr');
                            // ä¿®æ”¹æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ï¼Œä¼ é€’ETFåç§°
                            row.innerHTML = `
                                <td>${etf.etf_code}</td>
                                <td>${etf.etf_name}</td>
                                <td>${etf.start_date} è‡³ ${etf.end_date}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" 
                                            onclick="getCurrentPrice('${etf.etf_code}', this)">
                                        æ˜¾ç¤ºä»·æ ¼
                                    </button>
                                </td>
                                <td>
                                    <select class="form-control form-control-sm window-days">
                                        <option value="21">1ä¸ªæœˆ</option>
                                        <option value="42">2ä¸ªæœˆ</option>
                                        <option value="63">3ä¸ªæœˆ</option>
                                        <option value="84">4ä¸ªæœˆ</option>
                                    </select>
                                </td>
                                <td>
                                    <button class="btn btn-info show-volatility" 
                                            onclick="showVolatilityWithPrice('${etf.etf_code}', '${etf.etf_name}')">
                                        æ˜¾ç¤ºæ³¢åŠ¨ç‡
                                    </button>
                                </td>
                            `;
                            stockList.appendChild(row);
                        });
                    })
                    .catch(error => {
                        console.error('è·å–ETFåˆ—è¡¨å¤±è´¥:', error);
                        alert('è·å–ETFåˆ—è¡¨å¤±è´¥ï¼Œè¯·é‡è¯•');
                    })
                    .finally(() => {
                        // éšè—åŠ è½½åŠ¨ç”»
                        document.getElementById('loading').style.display = 'none';
                    });
            }

            // é¡µé¢åŠ è½½æ—¶è·å–ETFåˆ—è¡¨
            loadETFList();
        </script>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- åœ¨æ¨¡æ€æ¡†ä¸­æ·»åŠ æ³¢åŠ¨ç‡åˆ†æå†…å®¹ -->
        <!-- æ³¢åŠ¨ç‡åˆ†ææ¨¡æ€æ¡† -->
        <div class="modal fade" id="volatilityModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">æ³¢åŠ¨ç‡åˆ†æ</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="dashboard-container">
                            <!-- å·¦ä¾§ï¼šæ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡ -->
                            <div class="stats-panel">
                                <!-- æè¿°æ€§ç»Ÿè®¡å¡ç‰‡ -->
                                <div class="summary-card">
                                    <h6>ğŸ“Š æ”¶ç›Šåˆ†å¸ƒç‰¹å¾</h6>
                                    <div class="metric-grid">
                                        <div class="metric-item">
                                            <label>æ”¶ç›Šç‡</label>
                                            <div class="value" id="meanValue"></div>
                                            <small class="text-muted">æ­£å€¼è¡¨ç¤ºé•¿æœŸæŒæœ‰æœ‰ç›ˆåˆ©</small>
                                        </div>
                                        <div class="metric-item">
                                            <label>æ³¢åŠ¨ç‡</label>
                                            <div class="value" id="stdValue"></div>
                                            <small class="text-muted">68%çš„æœˆæ¶¨è·Œå¹…åœ¨Â±1ä¸ªæ ‡å‡†å·®å†…</small>
                                        </div>
                                        <div class="metric-item">
                                            <label>ååº¦</label>
                                            <div class="value" id="skewValue"></div>
                                            <small class="text-muted">è´Ÿå€¼è¡¨ç¤ºæš´è·Œæ¦‚ç‡å¤§äºæš´æ¶¨</small>
                                        </div>
                                        <div class="metric-item">
                                            <label>å³°åº¦</label>
                                            <div class="value" id="kurtValue"></div>
                                            <small class="text-muted">å¤§äº3è¡¨ç¤ºæç«¯è¡Œæƒ…è¾ƒå¤š</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- å¤šå‘¨æœŸæ³¢åŠ¨ç‡å¡ç‰‡ -->
                                <!-- ä¿®æ”¹å¤šå‘¨æœŸæ³¢åŠ¨ç‡å¡ç‰‡éƒ¨åˆ† -->
                                <div class="volatility-card mt-3">
                                    <h6>ğŸ“ˆ å¤šå‘¨æœŸæ³¢åŠ¨ç‡</h6>
                                    <div class="period-list">
                                        <div class="period-item" id="monthlyVol"></div>
                                        <div class="period-item" id="quarterlyVol"></div>
                                        <div class="period-item" id="yearlyVol"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- å³ä¾§ï¼šå›¾è¡¨åŒºåŸŸ -->
                            <div class="charts-panel">
                                <div class="chart-container">
                                    <div id="volTimelineChart" style="height: 300px;"></div>
                                </div>
                                <div class="chart-container mt-3">
                                    <div id="volConeChart" style="height: 300px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ æ ·å¼ -->
        <style>
        .dashboard-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            padding: 15px;
        }
        
        .summary-card, .volatility-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 10px;
        }
        
        .metric-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .metric-item label {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .metric-item .value {
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        .period-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        
        .period-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 768px) {
            .dashboard-container {
                grid-template-columns: 1fr;
            }
        }
        </style>
        
        <!-- ä¿®æ”¹JavaScriptä»£ç  -->
        <script>
        function showVolatilityWithPrice(etfCode, etfName) {
            fetch(`/api/volatility_analysis/${etfCode}`)
                .then(response => response.json())
                .then(data => {
                    // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜
                    document.querySelector('#volatilityModal .modal-title').innerHTML = 
                        `${etfName}ï¼ˆ${etfCode}ï¼‰æ³¢åŠ¨ç‡åˆ†æ`;
                        
                    // æ›´æ–°æè¿°æ€§ç»Ÿè®¡å¡ç‰‡ï¼ˆæ”¹ä¸ºæœˆåº¦æ•°æ®ï¼‰
                    document.getElementById('meanValue').innerHTML = `${data.stats.mean.toFixed(2)}% <span class="badge bg-primary">å¹´åŒ–æœˆå‡æ”¶ç›Š</span>`;
                    document.getElementById('stdValue').innerHTML = `${data.stats.std.toFixed(2)}% <span class="badge bg-warning">å¹´åŒ–æœˆæ³¢åŠ¨ç‡</span>`;
                    document.getElementById('skewValue').innerHTML = `${data.stats.skew.toFixed(2)} <span class="badge ${data.stats.skew < 0 ? 'bg-danger' : 'bg-success'}">ååº¦</span>`;
                    document.getElementById('kurtValue').innerHTML = `${data.stats.kurt.toFixed(2)} <span class="badge ${data.stats.kurt > 3 ? 'bg-danger' : 'bg-success'}">å³°åº¦</span>`;
        
                    // æ›´æ–°å¤šå‘¨æœŸæ³¢åŠ¨ç‡å¡ç‰‡ï¼ˆæ”¹ä¸ºæœˆåº¦æ•°æ®ï¼‰
                    updatePeriodCard('monthlyVol', 'å­£åº¦æ³¢åŠ¨ç‡', data.volatilities.monthly);
                    updatePeriodCard('quarterlyVol', 'å¹´åº¦æ³¢åŠ¨ç‡', data.volatilities.quarterly);
                    updatePeriodCard('yearlyVol', 'ä¸¤å¹´æ³¢åŠ¨ç‡', data.volatilities.yearly);
        
                    // æ˜¾ç¤ºæ¨¡æ€æ¡†å¹¶åœ¨æ˜¾ç¤ºååˆå§‹åŒ–å›¾è¡¨
                    const modalElement = document.getElementById('volatilityModal');
                    const modal = new bootstrap.Modal(modalElement);
                    
                    modalElement.addEventListener('shown.bs.modal', function () {
                        setTimeout(() => {
                            // é‡æ–°åˆå§‹åŒ–å›¾è¡¨
                            const timelineChart = echarts.init(document.getElementById('volTimelineChart'));
                            const coneChart = echarts.init(document.getElementById('volConeChart'));
                            
                            // è®¾ç½®å›¾è¡¨é…ç½®
                            drawVolTimeline(data, timelineChart);
                            drawVolCone(data.vol_cone, coneChart);
                        }, 100);
                    }, { once: true });
                    
                    modal.show();
                })
                .catch(error => {
                    console.error('è·å–æ³¢åŠ¨ç‡åˆ†ææ•°æ®å¤±è´¥:', error);
                    alert('è·å–æ³¢åŠ¨ç‡åˆ†ææ•°æ®å¤±è´¥');
                });
        }
        
        <!-- ä¿®æ”¹å¤šå‘¨æœŸæ³¢åŠ¨ç‡å¡ç‰‡çš„updatePeriodCardå‡½æ•° -->
        function updatePeriodCard(elementId, title, data) {
            const element = document.getElementById(elementId);
            const percentile = ((data.current - data.min) / (data.max - data.min) * 100).toFixed(0);
            const volatilityLevel = percentile > 75 ? 'é«˜æ³¢åŠ¨' : (percentile < 25 ? 'ä½æ³¢åŠ¨' : 'ä¸­ç­‰æ³¢åŠ¨');
            const badgeClass = percentile > 75 ? 'bg-danger' : (percentile < 25 ? 'bg-success' : 'bg-warning');
            
            element.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <strong>${title}</strong>
                    <div>
                        <span class="badge bg-primary">${data.current.toFixed(2)}%</span>
                        <span class="badge ${badgeClass}">${volatilityLevel}</span>
                    </div>
                </div>
                <div class="progress mt-2" style="height: 5px;">
                    <div class="progress-bar" role="progressbar" 
                         style="width: ${percentile}%">
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-1">
                    <small>${data.min.toFixed(2)}% (æœ€ä½)</small>
                    <small>${data.mean.toFixed(2)}% (å‡å€¼)</small>
                    <small>${data.max.toFixed(2)}% (æœ€é«˜)</small>
                </div>
                <div class="text-muted small mt-1">
                    ${title === 'æ—¥æ³¢åŠ¨ç‡' ? 'æœ€è¿‘1ä¸ªæœˆ' : (title === 'å‘¨æ³¢åŠ¨ç‡' ? 'æœ€è¿‘1å¹´' : 'æœ€è¿‘2å¹´')}çš„æ³¢åŠ¨ç‡æ°´å¹³
                    ${percentile > 75 ? 'ï¼Œå»ºè®®è°¨æ…æ“ä½œ' : (percentile < 25 ? 'ï¼Œå¯è€ƒè™‘ç§¯æç­–ç•¥' : 'ï¼Œå¯é‡‡å–ä¸­æ€§ç­–ç•¥')}
                </div>
            `;
        }
        
        function drawVolTimeline(data, chart) {
            try {
                const option = {
                    title: { 
                        text: 'æœˆåº¦æ€»ä½“ã€ä¸Šæ¶¨å’Œä¸‹è·Œæ³¢åŠ¨ç‡çš„åˆ†å¸ƒç‰¹å¾',
                        left: 'center',
                        top: '1%',
                        textStyle: {
                            fontSize: 14,
                            fontWeight: 'normal'
                        }
                    },
                    tooltip: { 
                        trigger: 'axis',
                        formatter: function(params) {
                            let result = params[0].axisValue + '<br/>';
                            params.forEach(param => {
                                let explanation = '';
                                switch(param.seriesName) {
                                    case 'æ€»ä½“æ³¢åŠ¨ç‡':
                                        explanation = 'ï¼ˆåæ˜ æ•´ä½“ä»·æ ¼æ³¢åŠ¨ï¼‰';
                                        break;
                                    case 'ä¸Šæ¶¨æ³¢åŠ¨ç‡':
                                        explanation = 'ï¼ˆåæ˜ ä¸Šæ¶¨æœˆä»½çš„æ³¢åŠ¨å¼ºåº¦ï¼‰';
                                        break;
                                    case 'ä¸‹è·Œæ³¢åŠ¨ç‡':
                                        explanation = 'ï¼ˆåæ˜ ä¸‹è·Œæœˆä»½çš„æ³¢åŠ¨å¼ºåº¦ï¼‰';
                                        break;
                                }
                                result += `${param.seriesName}${explanation}: ${param.value}%<br/>`;
                            });
                            return result;
                        }
                    },
                    legend: { 
                        data: ['æ€»ä½“æ³¢åŠ¨ç‡', 'ä¸Šæ¶¨æ³¢åŠ¨ç‡', 'ä¸‹è·Œæ³¢åŠ¨ç‡'],
                        selected: {
                            'æ€»ä½“æ³¢åŠ¨ç‡': true,
                            'ä¸Šæ¶¨æ³¢åŠ¨ç‡': true,
                            'ä¸‹è·Œæ³¢åŠ¨ç‡': true
                        },
                        top: '8%',
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: { 
                        type: 'category',
                        data: ['å½“å‰å€¼', 'å‡å€¼', 'æœ€å¤§å€¼', 'æœ€å°å€¼']
                    },
                    yAxis: { 
                        type: 'value',
                        name: 'å¹´åŒ–æ³¢åŠ¨ç‡(%)',
                        axisLabel: {
                            formatter: '{value}%'
                        }
                    },
                    series: [
                        {
                            name: 'æ€»ä½“æ³¢åŠ¨ç‡',
                            type: 'bar',
                            itemStyle: { color: '#5470C6' },
                            data: [
                                data.volatilities.monthly.current,
                                data.volatilities.monthly.mean,
                                data.volatilities.monthly.max,
                                data.volatilities.monthly.min
                            ]
                        },
                        {
                            name: 'ä¸Šæ¶¨æ³¢åŠ¨ç‡',
                            type: 'bar',
                            itemStyle: { color: '#91CC75' },
                            data: [
                                data.volatilities.monthly.up.current,
                                data.volatilities.monthly.up.mean,
                                data.volatilities.monthly.up.max,
                                data.volatilities.monthly.up.min
                            ]
                        },
                        {
                            name: 'ä¸‹è·Œæ³¢åŠ¨ç‡',
                            type: 'bar',
                            itemStyle: { color: '#EE6666' },
                            data: [
                                data.volatilities.monthly.down.current,
                                data.volatilities.monthly.down.mean,
                                data.volatilities.monthly.down.max,
                                data.volatilities.monthly.down.min
                            ]
                        }
                    ]
                };
                chart.setOption(option);
                
                // å…ˆæ¸…é™¤å·²æœ‰çš„è¯´æ˜
                const existingDesc = document.querySelector('.vol-timeline-description');
                if (existingDesc) {
                    existingDesc.remove();
                }

                // æ·»åŠ å›¾è¡¨è¯´æ˜
                const description = document.createElement('div');
                description.className = 'vol-timeline-description mt-2 text-muted small';
                description.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <p class="mb-0"><strong>æœˆåº¦æ³¢åŠ¨ç‡åˆ†è§£è¯´æ˜</strong></p>
                        <button class="btn btn-sm btn-outline-secondary" 
                                onclick="toggleDescription(this)">
                            å±•å¼€è¯´æ˜
                        </button>
                    </div>
                    <div class="description-content" style="display: none;">
                        <ul class="mt-2">
                            <li>æ€»ä½“æ³¢åŠ¨ç‡ï¼šåæ˜ ETFæ•´ä½“çš„æœˆåº¦ä»·æ ¼æ³¢åŠ¨å¹…åº¦
                                <ul>
                                    <li>å½“å‰å€¼é«˜äºå‡å€¼ï¼šè¡¨ç¤ºå¸‚åœºæ³¢åŠ¨åŠ å‰§ï¼Œéœ€è¦æ³¨æ„é£é™©</li>
                                    <li>å½“å‰å€¼ä½äºå‡å€¼ï¼šè¡¨ç¤ºå¸‚åœºç›¸å¯¹å¹³ç¨³</li>
                                </ul>
                            </li>
                            <li>ä¸Šæ¶¨æ³¢åŠ¨ç‡ï¼šä»…è€ƒè™‘ä¸Šæ¶¨æœˆä»½çš„æ³¢åŠ¨æƒ…å†µ
                                <ul>
                                    <li>é«˜äºæ€»ä½“æ³¢åŠ¨ç‡ï¼šè¡¨ç¤ºä¸Šæ¶¨æœˆä»½æ³¢åŠ¨è¾ƒå¤§ï¼Œæ¶¨åŠ¿å‰§çƒˆ</li>
                                    <li>ä½äºæ€»ä½“æ³¢åŠ¨ç‡ï¼šè¡¨ç¤ºä¸Šæ¶¨ç›¸å¯¹å¹³ç¼“</li>
                                </ul>
                            </li>
                            <li>ä¸‹è·Œæ³¢åŠ¨ç‡ï¼šä»…è€ƒè™‘ä¸‹è·Œæœˆä»½çš„æ³¢åŠ¨æƒ…å†µ
                                <ul>
                                    <li>é«˜äºæ€»ä½“æ³¢åŠ¨ç‡ï¼šè¡¨ç¤ºä¸‹è·Œæœˆä»½æ³¢åŠ¨è¾ƒå¤§ï¼Œè·ŒåŠ¿å‰§çƒˆ</li>
                                    <li>ä½äºæ€»ä½“æ³¢åŠ¨ç‡ï¼šè¡¨ç¤ºä¸‹è·Œç›¸å¯¹å¹³ç¼“</li>
                                </ul>
                            </li>
                            <li>ç­–ç•¥å»ºè®®ï¼š
                                <ul>
                                    <li>å½“ä¸‹è·Œæ³¢åŠ¨ç‡å¤§äºä¸Šæ¶¨æ³¢åŠ¨ç‡æ—¶ï¼Œå¸‚åœºå¯èƒ½å­˜åœ¨ææ…Œæƒ…ç»ªï¼Œéœ€è¦è°¨æ…</li>
                                    <li>å½“ä¸Šæ¶¨æ³¢åŠ¨ç‡å¤§äºä¸‹è·Œæ³¢åŠ¨ç‡æ—¶ï¼Œå¸‚åœºå¯èƒ½å¤„äºå¼ºåŠ¿ä¸Šæ¶¨é˜¶æ®µ</li>
                                    <li>æ³¢åŠ¨ç‡å‡è¡¡æ—¶ï¼Œå¸‚åœºæƒ…ç»ªç›¸å¯¹ç¨³å®š</li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                `;
                
                const chartContainer = document.getElementById('volTimelineChart').parentElement;
                chartContainer.appendChild(description);
                
                window.addEventListener('resize', () => chart.resize());
            } catch (error) {
                console.error('ç»˜åˆ¶æ—¶é—´åºåˆ—å›¾è¡¨å¤±è´¥:', error);
            }
        }
        
        function drawVolCone(volCone, chart) {
            try {
                const periods = Object.keys(volCone).sort((a, b) => {
                    return parseInt(a.match(/\d+/)[0]) - parseInt(b.match(/\d+/)[0]);
                });
                
                const option = {
                    title: { 
                        text: 'ä¸åŒè§‚å¯Ÿå‘¨æœŸçš„æ³¢åŠ¨ç‡åˆ†å¸ƒç‰¹å¾',
                        left: 'center',
                        top: '1%',
                        textStyle: {
                            fontSize: 14,
                            fontWeight: 'normal'
                        },
                        padding: [0, 0, 20, 0]  // ä¸Šå³ä¸‹å·¦çš„å†…è¾¹è·
                    },
                    tooltip: { 
                        trigger: 'axis',
                        formatter: function(params) {
                            let result = `${params[0].name}å‘¨æœŸ<br/>`;
                            params.forEach(param => {
                                let explanation = '';
                                switch(param.seriesName) {
                                    case 'å½“å‰å€¼':
                                        explanation = 'ï¼ˆå½“å‰å¸‚åœºç¯å¢ƒï¼‰';
                                        break;
                                    case '25%åˆ†ä½':
                                        explanation = 'ï¼ˆä½æ³¢åŠ¨åŒºé—´ï¼‰';
                                        break;
                                    case 'ä¸­ä½æ•°':
                                        explanation = 'ï¼ˆå†å²ä¸­ä½æ°´å¹³ï¼‰';
                                        break;
                                    case '75%åˆ†ä½':
                                        explanation = 'ï¼ˆé«˜æ³¢åŠ¨åŒºé—´ï¼‰';
                                        break;
                                }
                                result += `${param.seriesName}${explanation}: ${param.value.toFixed(2)}%<br/>`;
                            });
                            return result;
                        }
                    },
                    legend: { 
                        data: ['å½“å‰å€¼', '25%åˆ†ä½', 'ä¸­ä½æ•°', '75%åˆ†ä½'],
                        selected: {
                            'å½“å‰å€¼': true,
                            '25%åˆ†ä½': true,
                            'ä¸­ä½æ•°': true,
                            '75%åˆ†ä½': true
                        },
                        top: '10%',
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '15%',
                        containLabel: true
                    },
                    xAxis: { 
                        type: 'category',
                        data: periods,
                        name: 'è§‚å¯Ÿå¤©æ•°',
                        nameLocation: 'middle',
                        nameGap: 35,
                        axisLabel: {
                            interval: 0,
                            rotate: 30,
                            formatter: '{value}å¤©'
                        }
                    },
                    yAxis: { 
                        type: 'value',
                        name: 'æ³¢åŠ¨ç‡(%)',
                        axisLabel: {
                            formatter: '{value}%'
                        }
                    },
                    series: [
                        {
                            name: 'å½“å‰å€¼',
                            type: 'line',
                            symbol: 'circle',
                            symbolSize: 8,
                            lineStyle: {
                                color: '#FF4444',
                                width: 2
                            },
                            data: periods.map(p => volCone[p].current)
                        },
                        {
                            name: '25%åˆ†ä½',
                            type: 'line',
                            symbol: 'none',
                            lineStyle: { 
                                type: 'dashed',
                                color: '#91CC75'
                            },
                            data: periods.map(p => volCone[p].quantiles[0])
                        },
                        {
                            name: 'ä¸­ä½æ•°',
                            type: 'line',
                            symbol: 'none',
                            lineStyle: { 
                                type: 'dashed',
                                color: '#FAC858'
                            },
                            data: periods.map(p => volCone[p].quantiles[1])
                        },
                        {
                            name: '75%åˆ†ä½',
                            type: 'line',
                            symbol: 'none',
                            lineStyle: { 
                                type: 'dashed',
                                color: '#EE6666'
                            },
                            data: periods.map(p => volCone[p].quantiles[2])
                        }
                    ]
                };

                // å…ˆæ¸…é™¤å·²æœ‰çš„è¯´æ˜
                const existingDesc = document.querySelector('.vol-cone-description');
                if (existingDesc) {
                    existingDesc.remove();
                }
        
                // æ·»åŠ å›¾è¡¨è¯´æ˜
                const description = document.createElement('div');
                description.className = 'vol-cone-description mt-2 text-muted small';
                description.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <p class="mb-0"><strong>æ³¢åŠ¨ç‡é”¥è¯´æ˜</strong></p>
                        <button class="btn btn-sm btn-outline-secondary" 
                                onclick="toggleDescription(this)">
                            å±•å¼€è¯´æ˜
                        </button>
                    </div>
                    <div class="description-content" style="display: none;">
                        <ul class="mt-2">
                            <li>çº¢çº¿è¡¨ç¤ºå½“å‰å„å‘¨æœŸçš„æ³¢åŠ¨ç‡æ°´å¹³</li>
                            <li>è™šçº¿è¡¨ç¤ºå†å²æ³¢åŠ¨ç‡çš„åˆ†å¸ƒåŒºé—´ï¼š
                                <ul>
                                    <li>75%åˆ†ä½çº¿ä»¥ä¸Šï¼šé«˜æ³¢åŠ¨åŒºåŸŸï¼Œæ³¢åŠ¨ç‡å¤„äºå†å²é«˜ä½ï¼ŒæœŸæƒå¯èƒ½è¢«é«˜ä¼°ï¼Œå¯è€ƒè™‘å–å‡ºæœŸæƒç­–ç•¥</li>
                                    <li>25%-75%ä¹‹é—´ï¼šæ­£å¸¸æ³¢åŠ¨åŒºé—´ï¼Œå¯é‡‡ç”¨ä¸­æ€§ç­–ç•¥</li>
                                    <li>25%åˆ†ä½çº¿ä»¥ä¸‹ï¼šä½æ³¢åŠ¨åŒºåŸŸï¼Œæ³¢åŠ¨ç‡å¤„äºå†å²ä½ä½ï¼ŒæœŸæƒå¯èƒ½è¢«ä½ä¼°ï¼Œå¯è€ƒè™‘ä¹°å…¥æœŸæƒç­–ç•¥</li>
                                </ul>
                            </li>
                            <li>å½“å‰çº¿å½¢æ€ï¼š
                                ${getCurrentVolConePattern(periods, volCone)}
                            </li>
                            <li>ç­–ç•¥æç¤ºï¼š
                                <ul>
                                    <li>å½“æ³¢åŠ¨ç‡å¤„äºé«˜ä½æ—¶ï¼ŒæœŸæƒä»·æ ¼å¾€å¾€è¢«é«˜ä¼°ï¼Œæ­¤æ—¶å–å‡ºæœŸæƒå¯èƒ½è·å¾—è¾ƒå¥½æ”¶ç›Š</li>
                                    <li>å½“æ³¢åŠ¨ç‡å¤„äºä½ä½æ—¶ï¼ŒæœŸæƒä»·æ ¼å¾€å¾€è¢«ä½ä¼°ï¼Œæ­¤æ—¶ä¹°å…¥æœŸæƒå¯èƒ½è·å¾—è¾ƒå¥½æ”¶ç›Š</li>
                                    <li>æ³¨æ„ï¼šæ³¢åŠ¨ç‡åˆ†æä»…ä¾›å‚è€ƒï¼Œå®é™…äº¤æ˜“è¿˜éœ€è€ƒè™‘å…¶ä»–å¸‚åœºå› ç´ </li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                `;
                
                chart.setOption(option);
                
                // åœ¨å›¾è¡¨å®¹å™¨åæ’å…¥è¯´æ˜
                const chartContainer = document.getElementById('volConeChart').parentElement;
                chartContainer.appendChild(description);
                
                window.addEventListener('resize', () => chart.resize());
            } catch (error) {
                console.error('ç»˜åˆ¶æ³¢åŠ¨ç‡é”¥å›¾è¡¨å¤±è´¥:', error);
            }
        }

        // æ·»åŠ åˆ‡æ¢è¯´æ˜æ˜¾ç¤º/éšè—çš„å‡½æ•°
        function toggleDescription(button) {
            const content = button.parentElement.nextElementSibling;
            const isHidden = content.style.display === 'none';
            content.style.display = isHidden ? 'block' : 'none';
            button.textContent = isHidden ? 'æ”¶èµ·è¯´æ˜' : 'å±•å¼€è¯´æ˜';
        }
        
        // æ·»åŠ æ³¢åŠ¨ç‡é”¥å½¢æ€åˆ¤æ–­å‡½æ•°
        function getCurrentVolConePattern(periods, volCone) {
            try {
                const shortTerm = periods[0];
                const longTerm = periods[periods.length - 1];
                const shortTermVol = volCone[shortTerm].current;
                const longTermVol = volCone[longTerm].current;
                
                if (shortTermVol > longTermVol * 1.2) {
                    return 'çŸ­æœŸæ³¢åŠ¨ç‡æ˜¾è‘—é«˜äºé•¿æœŸï¼Œå¸‚åœºå¯èƒ½å¤„äºå‰§çƒˆæ³¢åŠ¨æœŸï¼Œå»ºè®®ä¿æŒè°¨æ…';
                } else if (shortTermVol < longTermVol * 0.8) {
                    return 'çŸ­æœŸæ³¢åŠ¨ç‡æ˜¾è‘—ä½äºé•¿æœŸï¼Œå¸‚åœºå¯èƒ½å³å°†è„±ç¦»å¹³é™æœŸï¼Œéœ€è¦è­¦æƒ•é£é™©';
                } else {
                    return 'çŸ­æœŸå’Œé•¿æœŸæ³¢åŠ¨ç‡è¾ƒä¸ºæ¥è¿‘ï¼Œå¸‚åœºæ³¢åŠ¨å¤„äºæ­£å¸¸æ°´å¹³';
                }
            } catch (error) {
                console.error('æ³¢åŠ¨ç‡é”¥å½¢æ€åˆ¤æ–­å¤±è´¥:', error);
                return 'æ³¢åŠ¨ç‡å½¢æ€åˆ¤æ–­å¤±è´¥';
            }
        }
        </script>
        {% endblock %}
