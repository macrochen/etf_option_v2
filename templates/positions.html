{% extends "base.html" %}

{% block title %}持仓信息{% endblock %}

{% block head %}
{{ super() }}
<!-- <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script> -->
<script type="text/javascript" src="{{ url_for('static', filename='js/stock-chart.js') }}"></script>
{% endblock %}

{% block content %}
<style>
    .nav-tabs .nav-link {
        color: #000000;  /* 未选中状态为黑色 */
    }
    .nav-tabs .nav-link.active {
        color: #0d6efd;  /* 选中状态为蓝色，使用 Bootstrap 默认的主题蓝色 */
    }
    .sortable {
        cursor: pointer;
        position: relative;
        padding-right: 20px !important;
    }
    
    /* 移除旧的排序图标样式 */
    .sort-icon::after {
        display: none;
    }
    
    /* 新的排序图标样式 */
    .sortable::after {
        content: '↕';
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
    }
    
    .sortable.sort-asc::after {
        content: '↑';
        color: #000;
    }
    
    .sortable.sort-desc::after {
        content: '↓';
        color: #000;
    }

    .modal-dialog-resizable {
        position: fixed !important;
        margin: 0 !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        height: 80vh;  /* 添加固定高度 */
        width: 80vw;   /* 添加固定宽度 */
    }

    .modal-dialog-resizable .modal-content {
        height: 100%;
        width: 100%;    /* 确保内容填满对话框 */
        display: flex;  /* 使用 flex 布局 */
        flex-direction: column;  /* 垂直方向排列 */
    }

    .modal-dialog-resizable .modal-body {
        flex: 1;        /* 让内容区域自动填充剩余空间 */
        overflow: auto; /* 添加滚动条 */
    }


    .table {
        border: none;
    }
    .table > :not(caption) > * > * {
        border-left: 1px solid #dee2e6;
        border-right: 1px solid #dee2e6;
        border-bottom: 1px solid #dee2e6;
        padding: 0.5rem;
    }
    .table > thead > tr > th {
        border-top: 1px solid #dee2e6;
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    .table-group-divider {
        background-color: #f1f3f5;
        border-bottom: 1px solid #dee2e6 !important;
    }
    .group-content tr td:first-child {
        padding-left: 2rem !important;
    }
    .group-content {
        transition: all 0.3s ease;
    }
    .group-content.collapsed {
        display: none;
    }
    .fa-chevron-down {
        transition: transform 0.3s ease;
    }
    .fa-chevron-down.collapsed {
        transform: rotate(-90deg);
    }
        
    .sortable {
        cursor: pointer;
        position: relative;
    }
    
    .sort-icon::after {
        content: '↕';
        position: absolute;
        right: 8px;
        color: #999;
    }
    
    .sort-icon.sort-asc::after {
        content: '↑';
        color: #000;
    }
    
    .sort-icon.sort-desc::after {
        content: '↓';
        color: #000;
    }

    @keyframes blink {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    /* .ui-resizable-handle {
        position: absolute;
        display: block;
        width: 10px;
        height: 10px;
        background: #f0f0f0;
        border: 1px solid #ccc;
    }

    .ui-resizable-se {
        cursor: se-resize;
        right: -5px;
        bottom: -5px;
    } */
</style>

<div class="container mt-4">
    <h2 class="mb-4">我的持仓</h2>
    <div class="card">
        <div class="card-body">
            <ul class="nav nav-tabs mb-3" id="positionTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="us-tab" data-bs-toggle="tab" data-bs-target="#us-positions" type="button" role="tab" aria-controls="us-positions" aria-selected="true">美股(老虎)</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="hk-tab" data-bs-toggle="tab" data-bs-target="#hk-positions" type="button" role="tab" aria-controls="hk-positions" aria-selected="false">港股(老虎)</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="futu-tab" data-bs-toggle="tab" data-bs-target="#futu-positions" type="button" role="tab" aria-controls="futu-positions" aria-selected="false">港股(富途)</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sim-tab" data-bs-toggle="tab" data-bs-target="#sim-positions" type="button" role="tab" aria-controls="sim-positions" aria-selected="false">模拟持仓</button>
                </li>
            </ul>
            <div class="tab-content" id="positionTabsContent">
                <!-- 美股持仓 -->
                <div class="tab-pane fade show active" id="us-positions" role="tabpanel" aria-labelledby="us-tab">
                    <div id="us-positions-container">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 港股持仓 -->
                <div class="tab-pane fade" id="hk-positions" role="tabpanel" aria-labelledby="hk-tab">
                    <!-- 添加更新按钮 -->
                    <div class="d-flex justify-content-end mb-3">
                        <button class="btn btn-primary btn-sm" onclick="updateHKPrevClose()">
                            更新港股收盘价
                        </button>
                    </div>
                    <div id="hk-positions-container">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 富途持仓 -->
                <div class="tab-pane fade" id="futu-positions" role="tabpanel" aria-labelledby="futu-tab">
                    <div class="d-flex justify-content-end mb-3 gap-2">
                        <button class="btn btn-primary btn-sm" onclick="getFutuPositions()">
                            获取富途持仓
                        </button>
                    </div>
                    <div id="futu-positions-container">
                        
                    </div>
                </div>

                <!-- 模拟持仓面板 -->
                <div class="tab-pane fade" id="sim-positions" role="tabpanel" aria-labelledby="sim-tab">
                    <div class="d-flex justify-content-end mb-3 gap-2">
                        <button class="btn btn-primary" onclick="loadSimPositions()">
                            加载持仓
                        </button>
                        <button class="btn btn-primary" onclick="openNewTradeModal()">
                            新建交易
                        </button>
                    </div>
                    <div id="sim-positions-container">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 新建交易模态框 -->
    <div class="modal fade" id="newTradeModal" tabindex="-1" aria-labelledby="newTradeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newTradeModalLabel">新建模拟交易</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 交易类型选择标签页 -->
                    <ul class="nav nav-tabs" id="tradeTypeTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="stock-trade-tab" data-bs-toggle="tab" 
                                    data-bs-target="#stock-trade" type="button" role="tab">股票交易</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="option-trade-tab" data-bs-toggle="tab" 
                                    data-bs-target="#option-trade" type="button" role="tab">期权交易</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-3" id="tradeTypeContent">
                        <!-- 股票交易表单 -->
                        <div class="tab-pane fade show active" id="stock-trade" role="tabpanel">
                            <form id="stockTradeForm">
                                <div class="mb-3">
                                    <label class="form-label">股票代码</label>
                                    <input type="text" class="form-control" id="stockSymbol" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">市场类型</label>
                                    <select class="form-select" id="stockMarket" required>
                                        <option value="US">美股</option>
                                        <option value="HK">港股</option>
                                    </select>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">交易方向</label>
                                        <select class="form-select" id="stockDirection" required>
                                            <option value="buy">买入</option>
                                            <option value="sell">卖出</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">数量</label>
                                        <input type="number" class="form-control" id="stockQuantity" required>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">价格</label>
                                        <input type="number" class="form-control" id="stockPrice" step="0.01" required>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <!-- 期权交易表单 -->
                        <div class="tab-pane fade" id="option-trade" role="tabpanel">
                            <form id="optionTradeForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">标的代码</label>
                                        <input type="text" class="form-control" id="optionUnderlying" required>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">市场类型</label>
                                        <select class="form-select" id="optionMarket" required>
                                            <option value="US">美股</option>
                                            <option value="HK">港股</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">到期日期</label>
                                        <input type="date" class="form-control" id="optionExpiry" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">行权价格</label>
                                        <input type="number" class="form-control" id="optionStrike" step="0.01" required>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">期权类型</label>
                                        <select class="form-select" id="optionType" required>
                                            <option value="call">认购 (Call)</option>
                                            <option value="put">认沽 (Put)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">交易方向</label>
                                        <select class="form-select" id="optionDirection" required>
                                            <option value="buy">买入</option>
                                            <option value="sell">卖出</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">数量</label>
                                        <input type="number" class="form-control" id="optionQuantity" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">价格</label>
                                        <input type="number" class="form-control" id="optionPrice" step="0.01" required>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitTrade()">提交交易</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Add Toast container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="updateToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">更新数据</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                正在更新股票数据，请稍候...
            </div>
        </div>
    </div>
</div>

<script>

// 打开新建交易模态框
function openNewTradeModal() {
    const modal = new bootstrap.Modal(document.getElementById('newTradeModal'));
    modal.show();
}



// 当选择到期日时更新行权价
document.getElementById('optionExpiry').addEventListener('change', function() {
    const expiry = this.value;
    const strikeSelect = document.getElementById('optionStrike');
    
    if (!expiry) {
        strikeSelect.innerHTML = '<option value="">请先选择到期日</option>';
        strikeSelect.disabled = true;
        return;
    }
    
});

// 提交交易
function submitTrade() {
    const activeTab = document.querySelector('#tradeTypeTabs .nav-link.active');
    const isStockTrade = activeTab.id === 'stock-trade-tab';
    
    let formData;
    if (isStockTrade) {
        formData = {
            type: 'stock',
            symbol: document.getElementById('stockSymbol').value,
            market: document.getElementById('stockMarket').value,  // 添加市场类型
            direction: document.getElementById('stockDirection').value,
            quantity: parseInt(document.getElementById('stockQuantity').value),
            price: parseFloat(document.getElementById('stockPrice').value)
        };
    } else {
        formData = {
            type: 'option',
            underlying: document.getElementById('optionUnderlying').value,
            market: document.getElementById('optionMarket').value,  // 添加市场类型
            expiry: document.getElementById('optionExpiry').value,
            strike: parseFloat(document.getElementById('optionStrike').value),
            optionType: document.getElementById('optionType').value,
            direction: document.getElementById('optionDirection').value,
            quantity: parseInt(document.getElementById('optionQuantity').value),
            price: parseFloat(document.getElementById('optionPrice').value)
        };
    }
    
    fetch('/api/sim_trade', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('交易提交成功');
            bootstrap.Modal.getInstance(document.getElementById('newTradeModal')).hide();
            // 刷新模拟持仓数据
            loadSimPositions();
        } else {
            alert('交易提交失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('交易提交失败，请重试');
    });
}

// 加载模拟持仓数据
function loadSimPositions() {
    const container = document.getElementById('sim-positions-container');
    container.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
        </div>
    `;
    
    fetch('/api/sim_positions')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                renderPositions(container, data.data.positions);
                initSorting(container);
            } else {
                container.innerHTML = '<div class="alert alert-danger">加载失败</div>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            container.innerHTML = '<div class="alert alert-danger">加载失败</div>';
        });
}


function getFutuPositions() {
    const button = document.querySelector('#futu-positions button');
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 获取中...';
    
    fetch('/api/futu_positions')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // 重新渲染富途持仓数据
                const futuContainer = document.getElementById('futu-positions-container');
                renderPositions(futuContainer, data.data.hk_positions, true);
                initSorting(futuContainer);
                // alert('成功获取富途持仓数据');
            } else {
                alert('获取失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('获取失败，请查看控制台了解详情');
        })
        .finally(() => {
            button.disabled = false;
            button.innerHTML = '获取富途持仓';
        });
}

function updateHKPrevClose() {
    const button = document.querySelector('#hk-positions button');
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 更新中...';
    
    fetch('/api/update_hk_prev_close')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // 显示成功消息
                alert(data.message);
            } else {
                alert('更新失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('更新失败，请查看控制台了解详情');
        })
        .finally(() => {
            button.disabled = false;
            button.innerHTML = '更新港股收盘价';
        });
}
// 修改格式化函数，添加 isDelta 参数
function formatNumber(value, isDelta = false) {
    if (value === null || value === undefined) return '-';
    
    // 将值转换为数字
    const num = Number(value);
    
    // 检查是否为整数（小数部分为0）
    if (Number.isInteger(num)) {
        // 如果是整数，直接使用千位分隔符格式化
        return num.toLocaleString('en-US');
    } else {
        // 如果有小数部分，按原来的方式格式化
        return num.toLocaleString('en-US', {
            minimumFractionDigits: isDelta ? 3 : 2,
            maximumFractionDigits: isDelta ? 3 : 2
        });
    }
}

function getEarliestExpiry(position) {
    if (!position.is_group || !position.options || position.options.length === 0) {
        return '9999-12-31'; // 没有期权的排在最后
    }
    
    // 获取所有期权的到期日
    const expiryDates = position.options.map(opt => opt.expiry);
    // 返回最早的到期日
    return expiryDates.sort()[0];
}

function sortByExpiry(button, isAsc) {
    // 获取当前激活的标签页
    const activeTab = document.querySelector('.tab-pane.active');
    const container = activeTab.querySelector('div[id$="-positions-container"]');
    const table = container.querySelector('table');
    
    // 获取所有组（包括分组和单独的股票行）
    const groups = [];
    const tbodies = Array.from(table.getElementsByTagName('tbody'));
    
    // 遍历所有tbody
    for (let i = 0; i < tbodies.length; i++) {
        const currentTbody = tbodies[i];
        const headerRow = currentTbody.querySelector('tr');
        
        if (headerRow.classList.contains('table-group-divider')) {
            // 这是一个分组
            const position = JSON.parse(headerRow.dataset.position || '{}');
            groups.push({
                header: currentTbody,
                content: tbodies[i + 1],  // 下一个tbody是内容
                position: position,
                expiry: getEarliestExpiry(position)
            });
            i++; // 跳过内容tbody
        } else {
            // 这是单独的股票行
            const position = JSON.parse(headerRow.dataset.position || '{}');
            groups.push({
                header: currentTbody,
                content: null,
                position: position,
                expiry: '9999-12-31'  // 股票行放在最后
            });
        }
    }
    
    // 按到期日排序
    groups.sort((a, b) => {
        // 首先按到期日排序
        const expiryCompare = isAsc ? 
            a.expiry.localeCompare(b.expiry) : 
            b.expiry.localeCompare(a.expiry);
            
        // 如果到期日相同，则按股票代码排序
        if (expiryCompare === 0) {
            const aSymbol = a.position.symbol || '';
            const bSymbol = b.position.symbol || '';
            return aSymbol.localeCompare(bSymbol);
        }
        
        return expiryCompare;
    });
    
    // 清空表格内容（保留表头）
    const thead = table.querySelector('thead');
    table.innerHTML = '';
    table.appendChild(thead);
    
    // 重新插入排序后的组
    groups.forEach(group => {
        table.appendChild(group.header);
        if (group.content) {
            table.appendChild(group.content);
        }
    });
    
    // 更新按钮状态
    const buttons = button.parentElement.querySelectorAll('button');
    buttons.forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
}

function toggleExpirySort(button) {
    // 检查当前排序状态
    const icon = button.querySelector('i');
    const isAsc = icon.classList.contains('fa-sort-amount-up');
    
    // 切换图标和排序方向
    if (isAsc) {
        icon.classList.remove('fa-sort-amount-up');
        icon.classList.add('fa-sort-amount-down');
    } else {
        icon.classList.remove('fa-sort-amount-down');
        icon.classList.add('fa-sort-amount-up');
    }
    
    // 调用原有的排序函数
    sortByExpiry(button, !isAsc);
}

// 在渲染完表格后初始化排序功能
document.addEventListener('DOMContentLoaded', function() {

    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('refresh-all-prev-close')) {
            const button = event.target;
            // 禁用按钮并显示加载状态
            button.disabled = true;
            const originalText = button.textContent;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 更新中...';
            
            fetch('/api/refresh_all_prev_close', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const successCount = data.data.updated_stocks.length;
                    const failedCount = data.data.failed_stocks.length;
                    
                    // 显示更新结果
                    let message = `更新完成\n成功：${successCount} 个`;
                    if (failedCount > 0) {
                        message += `\n失败：${failedCount} 个`;
                        // 显示失败详情
                        message += '\n\n失败详情：\n' + data.data.failed_stocks
                            .map(stock => `${stock.symbol}: ${stock.reason}`)
                            .join('\n');
                    }
                    alert(message);
                    
                    // 如果需要，可以在这里刷新页面或更新表格数据
                    if (successCount > 0) {
                        location.reload();  // 刷新页面以显示最新数据
                    }
                } else {
                    alert('更新失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('更新失败，请查看控制台了解详情');
            })
            .finally(() => {
                // 恢复按钮状态
                button.disabled = false;
                button.textContent = originalText;
            });
        }
    });

    const collapsedGroups = JSON.parse(localStorage.getItem('collapsedGroups') || '{}');
    Object.keys(collapsedGroups).forEach(groupId => {
        const group = document.getElementById(groupId);
        const button = group?.previousElementSibling?.querySelector('.fa-chevron-down');
        if (group && button) {
            group.classList.add('collapsed');
            button.classList.add('collapsed');
        }
    });

    // 添加 tab 切换事件监听
    const hkTab = document.getElementById('hk-tab');
    hkTab.addEventListener('shown.bs.tab', function (e) {
        // 重新初始化港股表格的排序功能
        const hkContainer = document.getElementById('hk-positions-container');
        const table = hkContainer.querySelector('table');
        if (table) {
            // 移除旧的事件监听器
            const headers = table.querySelectorAll('.sortable');
            headers.forEach(header => {
                const clone = header.cloneNode(true);
                header.parentNode.replaceChild(clone, header);
            });
            // 重新初始化排序
            initSorting(hkContainer);
        }
    });
    fetch('/positions')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const usContainer = document.getElementById('us-positions-container');
                renderPositions(usContainer, data.data.us_positions, false);
                initSorting(usContainer);

                const hkContainer = document.getElementById('hk-positions-container');
                renderPositions(hkContainer, data.data.hk_positions, false);
                initSorting(hkContainer);
            } else {
                showError('获取持仓信息失败');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('获取持仓信息失败');
        });
    
    // 使用事件委托来处理所有的更新Delta按钮
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('refresh-all-deltas')) {
            const button = event.target;
            // 禁用按钮并显示加载状态
            button.disabled = true;
            const originalText = button.textContent;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 更新中...';
            
            fetch('/api/refresh_all_deltas', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    let successCount = 0;
                    let failedCount = 0;
                    
                    // 更新页面上的delta值
                    if (data.data.updated_options) {
                        successCount = data.data.updated_options.length;
                        data.data.updated_options.forEach(option => {
                            // 找到对应的行
                            const rows = document.querySelectorAll('tr');
                            for (const row of rows) {
                                // 检查行中是否包含该期权的刷新按钮
                                const refreshButton = row.querySelector(`button[onclick*="${option.symbol}"]`);
                                if (refreshButton) {
                                    // 找到Delta单元格
                                    const deltaCell = row.cells[3]; // Delta列是第4列(索引为3)
                                    if (deltaCell) {
                                        const deltaSpan = deltaCell.querySelector('.badge');
                                        if (deltaSpan) {
                                            const deltaAbs = Math.abs(option.delta);
                                            let badgeClass = 'bg-info';
                                            
                                            if (deltaAbs >= 0.3) {
                                                badgeClass = 'bg-danger';  // 高风险红色
                                            } else if (deltaAbs >= 0.2) {
                                                badgeClass = 'bg-warning text-dark';  // 中风险黄色
                                            } else if (deltaAbs >= 0.15) {
                                                badgeClass = 'bg-secondary';  // 低风险灰色
                                            }
                                            
                                            deltaSpan.className = `badge ${badgeClass}`;
                                            deltaSpan.textContent = `${formatNumber(option.delta, true)}`;
                                        }
                                    }
                                    break;
                                }
                            }
                        });
                    }
                    
                    if (data.data.failed_options) {
                        failedCount = data.data.failed_options.length;
                    }
                    
                    alert(`更新完成\n成功：${successCount} 个\n失败：${failedCount} 个`);
                } else {
                    alert('更新失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('更新失败，请查看控制台了解详情');
            })
            .finally(() => {
                // 恢复按钮状态
                button.disabled = false;
                button.textContent = originalText;
            });
        }
    });
});

// 添加计算期权总数量的辅助函数
function calculateTotalOptionCount(positions) {
    return positions.reduce((total, position) => {
        if (position.is_group && position.options) {
            return total + position.options.length;
        }
        return total;
    }, 0);
}

// 添加计算期权总市值的辅助函数
function calculateTotalOptionValue(positions) {
    return positions.reduce((total, position) => {
        if (position.is_group && position.options) {
            return total + position.options.reduce((optionTotal, option) => 
                optionTotal + (option.market_value || 0), 0);
        }
        return total;
    }, 0);
}

// 添加计算期权总盈亏的辅助函数
function calculateTotalOptionPnL(positions) {
    return positions.reduce((total, position) => {
        if (position.is_group && position.options) {
            return total + position.options.reduce((optionTotal, option) => 
                optionTotal + (option.unrealized_pnl || 0), 0);
        }
        return total;
    }, 0);
}

function updatePriceAlerts(market = 'US', isFutu = false) {  // 默认为美股市场
    const button = event.target;
    button.disabled = true;
    const originalText = button.textContent;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 更新中...';
    
    fetch('/api/update_price_alerts', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ market: market,
            is_futu: isFutu })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert(`更新成功\n添加：${data.data.added_count} 个\n删除：${data.data.removed_count} 个`);
        } else {
            alert('更新失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('更新失败，请查看控制台了解详情');
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = originalText;
    });
}

function toggleAllGroups(button) {
    // 获取当前激活的标签页内的所有分组内容
    const activeTab = document.querySelector('.tab-pane.active');
    const groups = activeTab.querySelectorAll('.group-content');
    const buttons = activeTab.querySelectorAll('.fa-chevron-down');
    
    // 检查是否所有组都已折叠
    const allCollapsed = Array.from(groups).every(group => group.classList.contains('collapsed'));
    
    // 切换所有组的状态
    groups.forEach(group => {
        if (allCollapsed) {
            group.classList.remove('collapsed');
        } else {
            group.classList.add('collapsed');
        }
    });
    
    // 切换所有按钮的状态
    buttons.forEach(btn => {
        if (allCollapsed) {
            btn.classList.remove('collapsed');
        } else {
            btn.classList.add('collapsed');
        }
    });
    
    // 更新按钮图标状态
    const icon = button.querySelector('i');
    if (allCollapsed) {
        icon.classList.remove('collapsed');
    } else {
        icon.classList.add('collapsed');
    }
    
    // 保存折叠状态到 localStorage
    const collapsedGroups = JSON.parse(localStorage.getItem('collapsedGroups') || '{}');
    groups.forEach(group => {
        if (group.classList.contains('collapsed')) {
            collapsedGroups[group.id] = true;
        } else {
            delete collapsedGroups[group.id];
        }
    });
    localStorage.setItem('collapsedGroups', JSON.stringify(collapsedGroups));
}


function toggleMasking(button) {
    // 切换按钮图标
    const icon = button.querySelector('i');
    button.classList.toggle('active');
    const isMasked = button.classList.contains('active');
    
    // 切换眼睛图标
    if (isMasked) {
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
    
    // 获取当前激活的标签页内的表格和统计信息
    const activeTab = document.querySelector('.tab-pane.active');
    const table = activeTab.querySelector('table');
    const statsContainer = activeTab.querySelector('.text-end .small');
    
    // 处理统计信息
    if (statsContainer) {
        // 第一次点击时保存原始数据
        if (!statsContainer.hasAttribute('data-original-content')) {
            statsContainer.setAttribute('data-original-content', statsContainer.innerHTML);
        }
        
        if (isMasked) {
            // 脱敏显示：用*替换所有数字（包括千分号）、负号和百分号
            const content = statsContainer.getAttribute('data-original-content');
            const maskedContent = content.replace(/(-?[\d,]+(\.\d+)?%?)/g, match => {
                // 检查是否在class属性中
                if (content.includes(`class="${match}"`) || content.includes(`class='${match}'`)) {
                    return match;
                }
                return '✳️';
            });
            statsContainer.innerHTML = maskedContent;
        } else {
            // 恢复原始数据
            statsContainer.innerHTML = statsContainer.getAttribute('data-original-content');
        }
    }
    
    // 获取所有包含数字的单元格
    const cells = table.querySelectorAll('td.text-end, td.text-center');
    
    cells.forEach(cell => {
        // 如果单元格内容为空，跳过处理
        if (!cell.innerHTML.trim()) return;
        
        // 第一次点击时保存原始数据
        if (!cell.hasAttribute('data-original-content')) {
            cell.setAttribute('data-original-content', cell.innerHTML);
        }
        
        if (isMasked) {
            // 脱敏显示：用*替换所有数字（包括千分号）、负号和百分号
            const content = cell.getAttribute('data-original-content');
            const maskedContent = content.replace(/(-?[\d,]+(\.\d+)?%?)/g, match => {
                // 检查是否在class属性中
                if (content.includes(`class="${match}"`) || content.includes(`class='${match}'`)) {
                    return match;
                }
                return '✳️';
            });
            cell.innerHTML = maskedContent;
        } else {
            // 恢复原始数据
            cell.innerHTML = cell.getAttribute('data-original-content');
        }
    });
    
    // 保存遮罩状态到 localStorage
    localStorage.setItem('isMasked', isMasked);
}

function renderPositions(container, positions, isFutu = false) {
    if (!positions || positions.length === 0) {
        container.innerHTML = '<div class="alert alert-info">暂无持仓信息</div>';
        return;
    }

    let html = `
    <div class="table-responsive">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <button type="button" class="btn btn-secondary btn-sm" onclick="toggleMasking(this)" title="数据脱敏">
                    <i class="fas fa-eye"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleAllGroups(this)">
                    <i class="fas fa-chevron-down"></i> 全部折叠/展开
                </button>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="toggleExpirySort(this)">
                    <i class="fas fa-sort-amount-down"></i> 按到期日排序
                </button>
                <button class="btn btn-primary btn-sm refresh-all-deltas">
                    更新Delta
                </button>
                <button class="btn btn-info btn-sm refresh-all-prev-close">
                    更新前收价
                </button>
                <button class="btn btn-warning btn-sm" onclick="updatePriceAlerts('${positions[0]?.market || 'US'}', ${isFutu})">
                    更新到价提醒
                </button>
            </div>
            <div class="text-end">
                <div class="small">
                    <span class="me-3">期权数量: <strong>${calculateTotalOptionCount(positions)}</strong></span>
                    <span class="me-3">期权总市值: <strong class="${calculateTotalOptionValue(positions) >= 0 ? 'text-success' : 'text-danger'}">${formatNumber(calculateTotalOptionValue(positions))}</strong></span>
                    <span>期权总盈亏: <strong class="${calculateTotalOptionPnL(positions) >= 0 ? 'text-success' : 'text-danger'}">${formatNumber(calculateTotalOptionPnL(positions))}</strong></span>
                </div>
            </div>
        </div>
        <table class="table table-sm">
            <thead class="table-light">
                <tr>
                    <th class="sortable" data-sort="symbol">名称</th>
                    <th class="sortable text-end" data-sort="market_value">市值/数量</th>
                    <th class="sortable text-end" data-sort="latest_price">现价/成本</th>
                    <th class="sortable text-center" data-sort="delta">Delta</th>
                    <th class="sortable text-end" data-sort="unrealized_pnl">持仓盈亏</th>
                    <th class="sortable text-end" data-sort="daily_pnl">今日盈亏</th>
                    <th class="sortable text-end" data-sort="position_ratio">持仓占比</th>
                </tr>
            </thead>`;

    positions.forEach((position, index) => {// 添加分组的警示条件判断
        const showWarning = position.total_market_value < -2000 || position.total_unrealized_pnl < -1000;
        const warningIcon = showWarning ? '⚠️ ' : '';
        if (position.is_group) {
            // 添加折叠按钮和组 ID
            const groupId = `group-${index}`;
            html += `
                <tr class="table-group-divider" data-position='${JSON.stringify(position)}'>
                    <td>
                        <strong>
                            <button class="btn btn-link btn-sm p-0 me-2" 
                                    onclick="toggleGroup('${groupId}')" 
                                    title="展开/收起">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <a href="javascript:void(0)" class="text-decoration-none text-reset" 
                                onclick='stockChart.showChart("${isFutu && position.code ? position.code : position.symbol}", ${JSON.stringify(position.options).replace(/'/g, "&#39;")}, this, "${position.market}")'>
                                ${position.symbol}${warningIcon}
                            </a>
                            ${!isFutu ? 
                                `<button class="btn btn-link btn-sm p-0 ms-2" 
                                        onclick='event.stopPropagation(); redownloadStockData("${position.symbol}", "${position.market_type || 'US'}", this)'>
                                    <i class="fas fa-sync-alt"></i>
                                </button>` : 
                                ''
                            }
                        </strong>
                    </td>
                    <td class="text-end">
                        <strong class="${position.total_market_value >= 0 ? 'text-success' : 'text-danger'}">
                            ${formatNumber(position.total_market_value)}
                        </strong>
                    </td>
                    <td class="text-end">
                        ${!isFutu ? 
                            `<div class="d-flex align-items-center justify-content-end">
                                <span class="current-price me-2">-</span>
                                <button class="btn btn-link btn-sm p-0" 
                                        onclick="getCurrentPrice('${position.symbol}', '${position.market_type || 'US'}', this)">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>` : 
                            '-'
                        }
                    </td>
                    <td class="text-center">-</td>
                    <td class="text-end ${position.total_unrealized_pnl >= 0 ? 'text-success' : 'text-danger'}">
                        <strong>${formatNumber(position.total_unrealized_pnl)}</strong>
                    </td>
                    <td class="text-end ${position.total_daily_pnl >= 0 ? 'text-success' : 'text-danger'}">
                        <strong>${formatNumber(position.total_daily_pnl)}</strong>
                    </td>
                    <td class="text-end ${position.total_position_ratio >= 0 ? 'text-success' : 'text-danger'}">
                        <strong>${formatNumber(position.total_position_ratio)}%</strong>
                    </td>
                </tr>`;

            // 添加可折叠的内容区域
            html += `<tbody id="${groupId}" class="group-content">`;

            // 渲染股票行（如果有）
            if (position.stock) {
                html += renderStockRow(position.stock, true);
            }

            // 渲染期权行
            position.options.forEach(option => {
                html += renderOptionRow(option, true);
            });

            html += '</tbody>';
        } else {
            // 渲染单独的股票行
            html += `<tbody>` + renderStockRow(position, false) + `</tbody>`;
        }
    });

    html += '</table></div>';
    container.innerHTML = html;

}


// 添加切换组显示的函数
function toggleGroup(groupId) {
    const group = document.getElementById(groupId);
    const button = group.previousElementSibling.querySelector('.fa-chevron-down');
    
    if (group && button) {
        group.classList.toggle('collapsed');
        button.classList.toggle('collapsed');
        
        // 保存折叠状态到 localStorage
        const collapsedGroups = JSON.parse(localStorage.getItem('collapsedGroups') || '{}');
        if (group.classList.contains('collapsed')) {
            collapsedGroups[groupId] = true;
        } else {
            delete collapsedGroups[groupId];
        }
        localStorage.setItem('collapsedGroups', JSON.stringify(collapsedGroups));
    }
}

function getCurrentPrice(stockCode, marketType, buttonElement) {
    // 禁用按钮并显示加载状态
    buttonElement.disabled = true;
    const originalIcon = buttonElement.innerHTML;
    buttonElement.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

    // 获取价格显示元素
    const priceElement = buttonElement.closest('div').querySelector('.current-price');
    
    fetch(`/api/current_price/${stockCode}?market_type=${marketType}`)
        .then(response => response.json())
        .then(data => {
            // 更新价格显示
            priceElement.textContent = formatNumber(data.current_price);
        })
        .catch(error => {
            console.error('获取价格失败:', error);
            priceElement.textContent = '获取失败';
        })
        .finally(() => {
            // 恢复按钮状态
            buttonElement.disabled = false;
            buttonElement.innerHTML = originalIcon;
        });
}

function renderStockRow(stock, isGroupItem) {
    const showWarning = stock.market_value < -2000 || stock.unrealized_pnl < -1000;
    const warningIcon = showWarning ? '⚠️ ' : '';
    
    // 只在模拟交易持仓中显示平仓按钮
    const closeButton = stock.position_id ? 
        `<button class="btn btn-danger btn-sm ms-2" 
            onclick="closePosition(${stock.position_id}, '${stock.symbol}')">
            平仓
        </button>` : '';
    
    return `
    <tr data-position='${JSON.stringify(stock)}'>
        <td>${isGroupItem ? '&nbsp;&nbsp;' : ''}${stock.symbol}${warningIcon}${closeButton}</td>
        <td class="text-end">
            <span class="${stock.market_value >= 0 ? 'text-success' : 'text-danger'}">${formatNumber(stock.market_value)}</span>
            <br><small class="text-muted">${stock.quantity}</small>
        </td>
        <td class="text-end">${formatNumber(stock.latest_price)}\n<br><small class="text-muted">${formatNumber(stock.average_cost)}</small></td>
        <!-- 新增空的Delta列，保持表格结构一致 -->
        <td class="text-center">-</td>
        <td class="text-end ${stock.unrealized_pnl >= 0 ? 'text-success' : 'text-danger'}">
            ${formatNumber(stock.unrealized_pnl)}\n
            <br><small>${formatNumber(stock.unrealized_pnl_percentage)}%</small>
        </td>
        <td class="text-end ${stock.daily_pnl >= 0 ? 'text-success' : 'text-danger'}">
            ${formatNumber(stock.daily_pnl)}
        </td>
        <td class="text-end">${formatNumber(stock.position_ratio)}%</td>
    </tr>`;
}
// 添加刷新delta值的函数
function refreshOptionDelta(optionSymbol, button) {
    // 禁用按钮并显示加载状态
    button.disabled = true;
    const originalIcon = button.innerHTML;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
    
    fetch(`/api/refresh_option_delta/${optionSymbol}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // 获取当前行的Delta单元格
            const row = button.closest('tr');
            const deltaCell = row.cells[3]; // Delta列是第4列(索引为3)
            const deltaSpan = deltaCell.querySelector('.badge');
            
            if (deltaSpan) {
                const deltaAbs = Math.abs(data.data.delta);
                let badgeClass = 'bg-info';
                
                // 判断风险等级
                if (deltaAbs >= 0.3) {
                    badgeClass = 'bg-danger';  // 高风险红色
                } else if (deltaAbs >= 0.2) {
                    badgeClass = 'bg-warning text-dark';  // 中风险黄色
                } else if (deltaAbs >= 0.15) {
                    badgeClass = 'bg-secondary';  // 低风险灰色
                }
                
                deltaSpan.className = `badge ${badgeClass}`;
                deltaSpan.textContent = `${formatNumber(data.data.delta, true)}`;
            }
        } else {
            alert('刷新失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('刷新失败，请查看控制台了解详情');
    })
    .finally(() => {
        // 恢复按钮状态
        button.disabled = false;
        button.innerHTML = originalIcon;
    });
}


// ... 添加平仓功能的函数 ...
function closePosition(positionId, symbol) {
    if (!confirm(`确定要平掉 ${symbol} 的持仓吗？`)) {
        return;
    }
    
    fetch(`/api/sim_trade/${positionId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // 刷新模拟持仓数据
            loadSimPositions();
            alert('平仓成功');
        } else {
            alert('平仓失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('平仓失败，请重试');
    });
}

function renderOptionRow(option, isGroupItem) {
    const indent = isGroupItem ? '&nbsp;&nbsp;' : '';
    const showWarning = option.market_value < -2000 || option.unrealized_pnl < -1000;
    const warningIcon = showWarning ? '⚠️ ' : '';

    // 检查是否是本周到期
    const today = new Date();
    const expiryDate = new Date(option.expiry);
    const endOfWeek = new Date(today);
    endOfWeek.setDate(today.getDate() + (6 - today.getDay())); // 设置为本周五
    const isExpiringThisWeek = expiryDate <= endOfWeek;
    
    // 为本周到期的期权添加醒目的标识
    const expiryWarning = isExpiringThisWeek ? 
        '<span class="badge bg-danger" style="font-size: 10px; padding: 2px 5px; margin-right: 5px;">本周到期</span>' : '';
    
    // 添加delta值的风险评估和显示
    let deltaBadgeClass = 'bg-info';  // 默认蓝色
    const deltaAbs = Math.abs(option.delta || 0);
    
    // 对于卖期权（持仓为负）进行风险评估
    if (option.quantity < 0) {
        if (deltaAbs >= 0.3) {
            deltaBadgeClass = 'bg-danger';  // 高风险用红色
        } else if (deltaAbs >= 0.2) {
            deltaBadgeClass = 'bg-warning text-dark';  // 中等风险用黄色
        } else if (deltaAbs >= 0.15) {
            deltaBadgeClass = 'bg-secondary';  // 低风险用灰色
        }
    }

    // 只在模拟交易持仓中显示平仓按钮
    const closeButton = option.position_id && option.is_sim ? 
        `<button class="btn btn-danger btn-sm ms-2" 
            onclick="closePosition(${option.position_id}, '${option.symbol}')">
            平仓
        </button>` : '';

    const refreshOption = (option.delta !== undefined && option.market !== 'HK') ? `
        <button class="btn btn-link btn-sm p-0" style="font-size: 14px;" 
                onclick="event.stopPropagation(); refreshOptionDelta('${option.futu_symbol}', this)" 
                title="刷新Delta值">
            <i class="fas fa-sync-alt"></i>
        </button>` : '';
    
    // Delta显示移到单独的列
    const deltaDisplay = option.delta !== undefined ? 
        `<span class="badge ${deltaBadgeClass}" style="font-size: 16px; padding: 2px 5px;">${formatNumber(option.delta, true)}</span>` : '-';

    // 添加持仓占比的风险评估
    let ratioClass = '';
    const ratio = option.position_ratio || 0;
    if (ratio <= -1.5) {
        ratioClass = 'bg-danger';  // 最高风险红色
    } else if (ratio <= -1.0) {
        ratioClass = 'bg-warning text-dark';  // 高风险黄色
    } else if (ratio <= -0.5) {
        ratioClass = 'bg-secondary';  // 中等风险灰色
    } else {
        ratioClass = 'bg-info';  // 低风险蓝色
    }
    
    const ratioDisplay = option.position_ratio ? 
        `<span class="badge ${ratioClass}">${formatNumber(option.position_ratio)}%</span>` : 
        '-';

    return `
        <tr>
            <td>
                ${indent}${option.put_call} ${formatNumber(option.strike)} ${warningIcon}${closeButton}
                <br><small class="text-muted">
                    ${indent}${expiryWarning}${option.expiry}
                </small>
            </td>
            <td class="text-end">
                <span class="${option.market_value >= 0 ? 'text-success' : 'text-danger'}">${formatNumber(option.market_value)}</span>
                <br><small class="text-muted">${option.quantity}</small>
            </td>
            <td class="text-end">${formatNumber(option.latest_price)}<br><small class="text-muted">${formatNumber(option.average_cost)}</small></td>
            <!-- 新增Delta列 -->
            <td class="text-center">
                ${deltaDisplay}${refreshOption ? `${refreshOption}` : ''}
            </td>
             <td class="text-end ${option.unrealized_pnl >= 0 ? 'text-success' : 'text-danger'}">
                ${formatNumber(option.unrealized_pnl)}
                <br>
                <small>
                    ${option.unrealized_pnl_percentage >= 70 ? 
                        '<span class="badge bg-success blink ms-1" style="animation: blink 1s infinite" title="已达到70%获利">' +
                        '🎯</span>' : 
                        ''} ${formatNumber(option.unrealized_pnl_percentage)}%
                </small>
            </td>
            <td class="text-end ${option.daily_pnl >= 0 ? 'text-success' : 'text-danger'}">
                ${formatNumber(option.daily_pnl)}
            </td>
            <td class="text-end">${ratioDisplay}</td>
        </tr>`;
    }

    // 添加排序相关函数
    function initSorting(container) {
        const headers = container.querySelectorAll('.sortable');
        headers.forEach(header => {
            header.addEventListener('click', function() {
                const sortKey = this.dataset.sort;
                const table = this.closest('table');
                const isAsc = !this.classList.contains('sort-asc');
                
                // 清除所有排序状态
                headers.forEach(h => {
                    h.classList.remove('sort-asc', 'sort-desc');
                });
                
                // 设置当前排序状态
                this.classList.add(isAsc ? 'sort-asc' : 'sort-desc');
                
                // 获取所有组
                const groups = [];
                const tbodies = Array.from(table.getElementsByTagName('tbody'));
                
                // 遍历所有tbody
                for (let i = 0; i < tbodies.length; i++) {
                    const currentTbody = tbodies[i];
                    const headerRow = currentTbody.querySelector('tr');
                    
                    if (headerRow.classList.contains('table-group-divider')) {
                        // 从 data-position 属性中获取完整的position数据
                        const position = JSON.parse(headerRow.dataset.position || '{}');
                        let sortValue;
                        if (sortKey === 'delta') {
                            // 对于组，找出最大的delta绝对值
                            if (position.is_group && position.options) {
                                sortValue = Math.max(...position.options.map(opt => Math.abs(opt.delta || 0)));
                            } else {
                                sortValue = 0; // 股票没有delta值
                            }
                        } else {
                            sortValue = sortKey === 'symbol' ? position[sortKey] : (position[`total_${sortKey}`] || 0);
                        }
                        
                        groups.push({
                            header: currentTbody,
                            content: tbodies[i + 1],
                            position: position,
                            value: sortValue
                        });
                        i++; // 跳过下一个tbody
                    } else {
                        // 从 data-position 属性中获取股票数据
                        const position = JSON.parse(headerRow.dataset.position || '{}');
                        groups.push({
                            header: currentTbody,
                            content: null,
                            position: position,
                            value: position[sortKey] || 0
                        });
                    }
                }
                
                // 排序
                groups.sort((a, b) => {
                    const aValue = a.value;
                    const bValue = b.value;
                    
                    if (typeof aValue === 'number' && typeof bValue === 'number') {
                        return isAsc ? aValue - bValue : bValue - aValue;
                    }
                    
                    // 对于非数字值（如股票代码）进行字符串比较
                    return isAsc ? 
                        String(aValue).localeCompare(String(bValue)) : 
                        String(bValue).localeCompare(String(aValue));
                });
                
                // 重新插入排序后的组
                const thead = table.querySelector('thead');
                table.innerHTML = '';
                table.appendChild(thead);
                
                groups.forEach(group => {
                    table.appendChild(group.header);
                    if (group.content) {
                        table.appendChild(group.content);
                    }
                });
            });
        });
    }

    function extractGroupValue(headerRow, key) {
        switch(key) {
            case 'symbol':
                return headerRow.cells[0].textContent.trim();
            case 'market_value':
                return parseFloat(headerRow.cells[1].textContent.replace(/[^0-9.-]+/g, '')) || 0;
            case 'unrealized_pnl':
                return parseFloat(headerRow.cells[4].textContent.replace(/[^0-9.-]+/g, '')) || 0;
            case 'position_ratio':
                return parseFloat(headerRow.cells[5].textContent.replace(/[^0-9.-]+/g, '')) || 0;
            default:
                return 0;
        }
    }

    function extractValue(row, key) {
        let cell;
        switch(key) {
            case 'symbol':
                cell = row.cells[0];
                return cell.textContent.trim();
            case 'market_value':
                cell = row.cells[1];
                return parseFloat(cell.textContent.split('\n')[0].replace(/[^0-9.-]+/g, '')) || 0;
            case 'latest_price':
                cell = row.cells[2];
                return parseFloat(cell.textContent.split('\n')[0].replace(/[^0-9.-]+/g, '')) || 0;
            case 'unrealized_pnl':
                cell = row.cells[4];
                return parseFloat(cell.textContent.split('\n')[0].replace(/[^0-9.-]+/g, '')) || 0;
            case 'daily_pnl':
                cell = row.cells[5];
                return parseFloat(cell.textContent.replace(/[^0-9.-]+/g, '')) || 0;
            case 'position_ratio':
                cell = row.cells[6];
                // 移除所有非数字字符（包括百分号），只保留数字和小数点
                const value = cell.textContent.replace(/[^0-9.-]+/g, '');
                return parseFloat(value) || 0;
            default:
                return 0;
        }
    }

// 添加更新股票数据的函数
    function redownloadStockData(stockCode, marketType, button) {
        // 禁用按钮并添加旋转动画
        button.disabled = true;
        button.querySelector('i').classList.add('fa-spin');

        const endpoint = marketType === 'US' ? '/download' : '/download_hk';
        
        fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ stock_code: stockCode })
        })
        .then(response => response.json())
        .then(data => {
            // 显示成功消息
            alert(`${data.message}\n总记录数: ${data.total}\n成功保存: ${data.count}\n处理失败: ${data.errors}`);
        })
        .catch(error => {
            console.error('更新数据失败:', error);
            alert('更新数据失败，请重试');
        })
        .finally(() => {
            // 恢复按钮状态，移除旋转动画
            button.disabled = false;
            button.querySelector('i').classList.remove('fa-spin');
        });
    }

</script>
{% endblock %}