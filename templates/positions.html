{% extends "base.html" %}

{% block title %}持仓信息{% endblock %}

{% block head %}
{{ super() }}
<!-- <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script> -->
<script type="text/javascript" src="{{ url_for('static', filename='js/stock-chart.js') }}"></script>
{% endblock %}

{% block content %}
<style>
    .nav-tabs .nav-link {
        color: #000000;  /* 未选中状态为黑色 */
    }
    .nav-tabs .nav-link.active {
        color: #0d6efd;  /* 选中状态为蓝色，使用 Bootstrap 默认的主题蓝色 */
    }
    .sortable {
        cursor: pointer;
    }
    .sortable:hover {
        background-color: #f8f9fa;
    }
    .sort-icon::after {
        content: '↕️';
        font-size: 12px;
        margin-left: 5px;
    }
    .sort-asc::after {
        content: '↑';
    }
    .sort-desc::after {
        content: '↓';
    }
    .modal-dialog-resizable {
        position: fixed !important;
        margin: 0 !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        height: 80vh;  /* 添加固定高度 */
        width: 80vw;   /* 添加固定宽度 */
    }

    .modal-dialog-resizable .modal-content {
        height: 100%;
        width: 100%;    /* 确保内容填满对话框 */
        display: flex;  /* 使用 flex 布局 */
        flex-direction: column;  /* 垂直方向排列 */
    }

    .modal-dialog-resizable .modal-body {
        flex: 1;        /* 让内容区域自动填充剩余空间 */
        overflow: auto; /* 添加滚动条 */
    }

    /* .ui-resizable-handle {
        position: absolute;
        display: block;
        width: 10px;
        height: 10px;
        background: #f0f0f0;
        border: 1px solid #ccc;
    }

    .ui-resizable-se {
        cursor: se-resize;
        right: -5px;
        bottom: -5px;
    } */
</style>

<div class="container mt-4">
    <h2 class="mb-4">我的持仓</h2>
    <div class="card">
        <div class="card-body">
            <ul class="nav nav-tabs mb-3" id="positionTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="us-tab" data-bs-toggle="tab" data-bs-target="#us-positions" type="button" role="tab" aria-controls="us-positions" aria-selected="true">美股持仓</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="hk-tab" data-bs-toggle="tab" data-bs-target="#hk-positions" type="button" role="tab" aria-controls="hk-positions" aria-selected="false">港股持仓</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="futu-tab" data-bs-toggle="tab" data-bs-target="#futu-positions" type="button" role="tab" aria-controls="futu-positions" aria-selected="false">富途持仓</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sim-tab" data-bs-toggle="tab" data-bs-target="#sim-positions" type="button" role="tab" aria-controls="sim-positions" aria-selected="false">模拟持仓</button>
                </li>
            </ul>
            <div class="tab-content" id="positionTabsContent">
                <!-- 美股持仓 -->
                <div class="tab-pane fade show active" id="us-positions" role="tabpanel" aria-labelledby="us-tab">
                    <div id="us-positions-container">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 港股持仓 -->
                <div class="tab-pane fade" id="hk-positions" role="tabpanel" aria-labelledby="hk-tab">
                    <!-- 添加更新按钮 -->
                    <div class="d-flex justify-content-end mb-3">
                        <button class="btn btn-primary btn-sm" onclick="updateHKPrevClose()">
                            更新港股收盘价
                        </button>
                    </div>
                    <div id="hk-positions-container">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 富途持仓 -->
                <div class="tab-pane fade" id="futu-positions" role="tabpanel" aria-labelledby="futu-tab">
                    <div class="d-flex justify-content-end mb-3 gap-2">
                        <button class="btn btn-primary btn-sm" onclick="getFutuPositions()">
                            获取富途持仓
                        </button>
                    </div>
                    <div id="futu-positions-container">
                        
                    </div>
                </div>

                <!-- 模拟持仓面板 -->
                <div class="tab-pane fade" id="sim-positions" role="tabpanel" aria-labelledby="sim-tab">
                    <div class="d-flex justify-content-end mb-3 gap-2">
                        <button class="btn btn-primary" onclick="loadSimPositions()">
                            加载持仓
                        </button>
                        <button class="btn btn-primary" onclick="openNewTradeModal()">
                            新建交易
                        </button>
                    </div>
                    <div id="sim-positions-container">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 新建交易模态框 -->
    <div class="modal fade" id="newTradeModal" tabindex="-1" aria-labelledby="newTradeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newTradeModalLabel">新建模拟交易</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 交易类型选择标签页 -->
                    <ul class="nav nav-tabs" id="tradeTypeTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="stock-trade-tab" data-bs-toggle="tab" 
                                    data-bs-target="#stock-trade" type="button" role="tab">股票交易</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="option-trade-tab" data-bs-toggle="tab" 
                                    data-bs-target="#option-trade" type="button" role="tab">期权交易</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-3" id="tradeTypeContent">
                        <!-- 股票交易表单 -->
                        <div class="tab-pane fade show active" id="stock-trade" role="tabpanel">
                            <form id="stockTradeForm">
                                <div class="mb-3">
                                    <label class="form-label">股票代码</label>
                                    <input type="text" class="form-control" id="stockSymbol" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">市场类型</label>
                                    <select class="form-select" id="stockMarket" required>
                                        <option value="US">美股</option>
                                        <option value="HK">港股</option>
                                    </select>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">交易方向</label>
                                        <select class="form-select" id="stockDirection" required>
                                            <option value="buy">买入</option>
                                            <option value="sell">卖出</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">数量</label>
                                        <input type="number" class="form-control" id="stockQuantity" required>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">价格</label>
                                        <input type="number" class="form-control" id="stockPrice" step="0.01" required>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <!-- 期权交易表单 -->
                        <div class="tab-pane fade" id="option-trade" role="tabpanel">
                            <form id="optionTradeForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">标的代码</label>
                                        <input type="text" class="form-control" id="optionUnderlying" required>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">市场类型</label>
                                        <select class="form-select" id="optionMarket" required>
                                            <option value="US">美股</option>
                                            <option value="HK">港股</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">到期日期</label>
                                        <input type="date" class="form-control" id="optionExpiry" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">行权价格</label>
                                        <input type="number" class="form-control" id="optionStrike" step="0.01" required>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">期权类型</label>
                                        <select class="form-select" id="optionType" required>
                                            <option value="call">认购 (Call)</option>
                                            <option value="put">认沽 (Put)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">交易方向</label>
                                        <select class="form-select" id="optionDirection" required>
                                            <option value="buy">买入</option>
                                            <option value="sell">卖出</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">数量</label>
                                        <input type="number" class="form-control" id="optionQuantity" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">价格</label>
                                        <input type="number" class="form-control" id="optionPrice" step="0.01" required>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitTrade()">提交交易</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Add Toast container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="updateToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">更新数据</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                正在更新股票数据，请稍候...
            </div>
        </div>
    </div>
</div>

<script>

// 打开新建交易模态框
function openNewTradeModal() {
    const modal = new bootstrap.Modal(document.getElementById('newTradeModal'));
    modal.show();
}



// 当选择到期日时更新行权价
document.getElementById('optionExpiry').addEventListener('change', function() {
    const expiry = this.value;
    const strikeSelect = document.getElementById('optionStrike');
    
    if (!expiry || !window.optionChainData) {
        strikeSelect.innerHTML = '<option value="">请先选择到期日</option>';
        strikeSelect.disabled = true;
        return;
    }
    
    // 更新行权价选择框
    const strikes = window.optionChainData.strikes[expiry] || [];
    strikeSelect.innerHTML = '<option value="">请选择行权价</option>';
    strikes.forEach(strike => {
        strikeSelect.innerHTML += `<option value="${strike}">${strike}</option>`;
    });
    strikeSelect.disabled = false;
});

// 提交交易
function submitTrade() {
    const activeTab = document.querySelector('#tradeTypeTabs .nav-link.active');
    const isStockTrade = activeTab.id === 'stock-trade-tab';
    
    let formData;
    if (isStockTrade) {
        formData = {
            type: 'stock',
            symbol: document.getElementById('stockSymbol').value,
            market: document.getElementById('stockMarket').value,  // 添加市场类型
            direction: document.getElementById('stockDirection').value,
            quantity: parseInt(document.getElementById('stockQuantity').value),
            price: parseFloat(document.getElementById('stockPrice').value)
        };
    } else {
        formData = {
            type: 'option',
            underlying: document.getElementById('optionUnderlying').value,
            market: document.getElementById('optionMarket').value,  // 添加市场类型
            expiry: document.getElementById('optionExpiry').value,
            strike: parseFloat(document.getElementById('optionStrike').value),
            optionType: document.getElementById('optionType').value,
            direction: document.getElementById('optionDirection').value,
            quantity: parseInt(document.getElementById('optionQuantity').value),
            price: parseFloat(document.getElementById('optionPrice').value)
        };
    }
    
    fetch('/api/sim_trade', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('交易提交成功');
            bootstrap.Modal.getInstance(document.getElementById('newTradeModal')).hide();
            // 刷新模拟持仓数据
            loadSimPositions();
        } else {
            alert('交易提交失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('交易提交失败，请重试');
    });
}

// 加载模拟持仓数据
function loadSimPositions() {
    const container = document.getElementById('sim-positions-container');
    container.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
        </div>
    `;
    
    fetch('/api/sim_positions')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                renderPositions(container, data.data.positions);
                initSorting(container);
            } else {
                container.innerHTML = '<div class="alert alert-danger">加载失败</div>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            container.innerHTML = '<div class="alert alert-danger">加载失败</div>';
        });
}


function getFutuPositions() {
    const button = document.querySelector('#futu-positions button');
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 获取中...';
    
    fetch('/api/futu_positions')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // 重新渲染富途持仓数据
                const futuContainer = document.getElementById('futu-positions-container');
                renderPositions(futuContainer, data.data.hk_positions, true);
                initSorting(futuContainer);
                // alert('成功获取富途持仓数据');
            } else {
                alert('获取失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('获取失败，请查看控制台了解详情');
        })
        .finally(() => {
            button.disabled = false;
            button.innerHTML = '获取富途持仓';
        });
}

function updateHKPrevClose() {
    const button = document.querySelector('#hk-positions button');
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 更新中...';
    
    fetch('/api/update_hk_prev_close')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // 显示成功消息
                alert(data.message);
            } else {
                alert('更新失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('更新失败，请查看控制台了解详情');
        })
        .finally(() => {
            button.disabled = false;
            button.innerHTML = '更新港股收盘价';
        });
}
// 修改格式化函数，添加 isDelta 参数
function formatNumber(value, isDelta = false) {
    if (value === null || value === undefined) return '-';
    
    // 将值转换为数字
    const num = Number(value);
    
    // 检查是否为整数（小数部分为0）
    if (Number.isInteger(num)) {
        // 如果是整数，直接使用千位分隔符格式化
        return num.toLocaleString('en-US');
    } else {
        // 如果有小数部分，按原来的方式格式化
        return num.toLocaleString('en-US', {
            minimumFractionDigits: isDelta ? 3 : 2,
            maximumFractionDigits: isDelta ? 3 : 2
        });
    }
}

function getEarliestExpiry(position) {
    if (!position.is_group || !position.options || position.options.length === 0) {
        return '9999-12-31'; // 没有期权的排在最后
    }
    
    // 获取所有期权的到期日
    const expiryDates = position.options.map(opt => opt.expiry);
    // 返回最早的到期日
    return expiryDates.sort()[0];
}

function sortByExpiry(button, isAsc) {
    // 获取当前激活的标签页
    const activeTab = document.querySelector('.tab-pane.active');
    const container = activeTab.querySelector('div[id$="-positions-container"]');
    const tbody = container.querySelector('tbody');
    
    // 获取所有分组
    const groups = [];
    let currentGroup = null;
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    rows.forEach(row => {
        if (row.classList.contains('table-group-divider')) {
            if (currentGroup) {
                groups.push(currentGroup);
            }
            currentGroup = {
                header: row,
                rows: [],
                position: JSON.parse(row.dataset.position || '{}')
            };
        } else if (currentGroup && row.querySelector('td:first-child').innerHTML.includes('&nbsp;&nbsp;')) {
            currentGroup.rows.push(row);
        } else {
            if (currentGroup) {
                groups.push(currentGroup);
            }
            // 单独的股票行作为没有期权的分组处理
            groups.push({
                header: row,
                rows: [],
                position: JSON.parse(row.dataset.position || '{}')
            });
            currentGroup = null;
        }
    });
    
    if (currentGroup) {
        groups.push(currentGroup);
    }
    
    // 按到期日排序
    groups.sort((a, b) => {
        const aExpiry = getEarliestExpiry(a.position);
        const bExpiry = getEarliestExpiry(b.position);
        
        // 首先按到期日排序
        const expiryCompare = isAsc ? 
            aExpiry.localeCompare(bExpiry) : 
            bExpiry.localeCompare(aExpiry);
            
        // 如果到期日相同，则按股票代码排序
        if (expiryCompare === 0) {
            const aSymbol = a.position.symbol || '';
            const bSymbol = b.position.symbol || '';
            return aSymbol.localeCompare(bSymbol);  // 股票代码永远按升序排列
        }
        
        return expiryCompare;
    });
    
    // 清空表格
    tbody.innerHTML = '';
    
    // 重新插入排序后的分组
    groups.forEach(group => {
        tbody.appendChild(group.header);
        group.rows.forEach(row => tbody.appendChild(row));
    });
    
    // 更新按钮状态
    const buttons = button.parentElement.querySelectorAll('button');
    buttons.forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
}

function toggleExpirySort(button) {
    // 检查当前排序状态
    const icon = button.querySelector('i');
    const isAsc = icon.classList.contains('fa-sort-amount-up');
    
    // 切换图标和排序方向
    if (isAsc) {
        icon.classList.remove('fa-sort-amount-up');
        icon.classList.add('fa-sort-amount-down');
    } else {
        icon.classList.remove('fa-sort-amount-down');
        icon.classList.add('fa-sort-amount-up');
    }
    
    // 调用原有的排序函数
    sortByExpiry(button, !isAsc);
}

// 在渲染完表格后初始化排序功能
document.addEventListener('DOMContentLoaded', function() {
    // 添加 tab 切换事件监听
    const hkTab = document.getElementById('hk-tab');
    hkTab.addEventListener('shown.bs.tab', function (e) {
        // 重新初始化港股表格的排序功能
        const hkContainer = document.getElementById('hk-positions-container');
        const table = hkContainer.querySelector('table');
        if (table) {
            // 移除旧的事件监听器
            const headers = table.querySelectorAll('.sortable');
            headers.forEach(header => {
                const clone = header.cloneNode(true);
                header.parentNode.replaceChild(clone, header);
            });
            // 重新初始化排序
            initSorting(hkContainer);
        }
    });
    fetch('/positions')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const usContainer = document.getElementById('us-positions-container');
                renderPositions(usContainer, data.data.us_positions, false);
                initSorting(usContainer);

                const hkContainer = document.getElementById('hk-positions-container');
                renderPositions(hkContainer, data.data.hk_positions, false);
                initSorting(hkContainer);
            } else {
                showError('获取持仓信息失败');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('获取持仓信息失败');
        });
    
    // 使用事件委托来处理所有的更新Delta按钮
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('refresh-all-deltas')) {
            const button = event.target;
            // 禁用按钮并显示加载状态
            button.disabled = true;
            const originalText = button.textContent;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 更新中...';
            
            fetch('/api/refresh_all_deltas', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    let successCount = 0;
                    let failedCount = 0;
                    
                    // 更新页面上的delta值
                    if (data.data.updated_options) {
                        successCount = data.data.updated_options.length;
                        data.data.updated_options.forEach(option => {
                            // 找到对应的行
                            const rows = document.querySelectorAll('tr');
                            for (const row of rows) {
                                // 检查行中是否包含该期权的刷新按钮
                                const refreshButton = row.querySelector(`button[onclick*="${option.symbol}"]`);
                                if (refreshButton) {
                                    // 找到Delta单元格
                                    const deltaCell = row.cells[3]; // Delta列是第4列(索引为3)
                                    if (deltaCell) {
                                        const deltaSpan = deltaCell.querySelector('.badge');
                                        if (deltaSpan) {
                                            const deltaAbs = Math.abs(option.delta);
                                            let badgeClass = 'bg-info';
                                            
                                            if (deltaAbs >= 0.3) {
                                                badgeClass = 'bg-danger';  // 高风险红色
                                            } else if (deltaAbs >= 0.2) {
                                                badgeClass = 'bg-warning text-dark';  // 中风险黄色
                                            } else if (deltaAbs >= 0.15) {
                                                badgeClass = 'bg-secondary';  // 低风险灰色
                                            }
                                            
                                            deltaSpan.className = `badge ${badgeClass}`;
                                            deltaSpan.textContent = `${formatNumber(option.delta, true)}`;
                                        }
                                    }
                                    break;
                                }
                            }
                        });
                    }
                    
                    if (data.data.failed_options) {
                        failedCount = data.data.failed_options.length;
                    }
                    
                    alert(`更新完成\n成功：${successCount} 个\n失败：${failedCount} 个`);
                } else {
                    alert('更新失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('更新失败，请查看控制台了解详情');
            })
            .finally(() => {
                // 恢复按钮状态
                button.disabled = false;
                button.textContent = originalText;
            });
        }
    });
});

// 添加计算期权总数量的辅助函数
function calculateTotalOptionCount(positions) {
    return positions.reduce((total, position) => {
        if (position.is_group && position.options) {
            return total + position.options.length;
        }
        return total;
    }, 0);
}

// 添加计算期权总市值的辅助函数
function calculateTotalOptionValue(positions) {
    return positions.reduce((total, position) => {
        if (position.is_group && position.options) {
            return total + position.options.reduce((optionTotal, option) => 
                optionTotal + (option.market_value || 0), 0);
        }
        return total;
    }, 0);
}

// 添加计算期权总盈亏的辅助函数
function calculateTotalOptionPnL(positions) {
    return positions.reduce((total, position) => {
        if (position.is_group && position.options) {
            return total + position.options.reduce((optionTotal, option) => 
                optionTotal + (option.unrealized_pnl || 0), 0);
        }
        return total;
    }, 0);
}

function updatePriceAlerts(market = 'US') {  // 默认为美股市场
    const button = event.target;
    button.disabled = true;
    const originalText = button.textContent;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 更新中...';
    
    fetch('/api/update_price_alerts', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ market: market })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert(`更新成功\n添加：${data.data.added_count} 个\n删除：${data.data.removed_count} 个`);
        } else {
            alert('更新失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('更新失败，请查看控制台了解详情');
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = originalText;
    });
}

function renderPositions(container, positions, isFutu = false) {
    if (!positions || positions.length === 0) {
        container.innerHTML = '<div class="alert alert-info">暂无持仓信息</div>';
        return;
    }

    let html = `
    <div class="table-responsive">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="toggleExpirySort(this)">
                    <i class="fas fa-sort-amount-down"></i> 按到期日排序
                </button>
                <button class="btn btn-primary btn-sm refresh-all-deltas">
                    更新Delta
                </button>
                <button class="btn btn-warning btn-sm" onclick="updatePriceAlerts()">
                    更新到价提醒
                </button>
            </div>
            <div class="text-end">
                <div class="small">
                    <span class="me-3">期权数量: <strong>${calculateTotalOptionCount(positions)}</strong></span>
                    <span class="me-3">期权总市值: <strong class="${calculateTotalOptionValue(positions) >= 0 ? 'text-success' : 'text-danger'}">${formatNumber(calculateTotalOptionValue(positions))}</strong></span>
                    <span>期权总盈亏: <strong class="${calculateTotalOptionPnL(positions) >= 0 ? 'text-success' : 'text-danger'}">${formatNumber(calculateTotalOptionPnL(positions))}</strong></span>
                </div>
            </div>
        </div>
        <table class="table table-sm">
            <thead class="table-light">
                <tr>
                    <th class="sortable" data-sort="symbol">名称<span class="sort-icon"></span></th>
                    <th class="sortable text-end" data-sort="market_value">市值/数量<span class="sort-icon"></span></th>
                    <th class="sortable text-end" data-sort="latest_price">现价/成本<span class="sort-icon"></span></th>
                    <th class="sortable text-center" >Delta</th>
                    <th class="sortable text-end" data-sort="unrealized_pnl">持仓盈亏<span class="sort-icon"></span></th>
                    <th class="sortable text-end" data-sort="daily_pnl">今日盈亏<span class="sort-icon"></span></th>
                    <th class="sortable text-end" data-sort="position_ratio">持仓占比<span class="sort-icon"></span></th>
                </tr>
            </thead>
            <tbody>`;

    positions.forEach(position => {
        if (position.is_group) {
            // 添加分组的警示条件判断
            const showWarning = position.total_market_value < -2000 || position.total_unrealized_pnl < -1000;
            const warningIcon = showWarning ? '⚠️ ' : '';
            
            // 渲染分组标题
            html += `
                <tr class="table-group-divider" data-position='${JSON.stringify(position)}'>
                    <td>
                        <strong>
                                <a href="javascript:void(0)" class="text-decoration-none text-reset" 
                                    onclick='stockChart.showChart("${isFutu && position.code ? position.code : position.symbol}", ${JSON.stringify(position.options).replace(/'/g, "&#39;")}, this, "${position.market}")'>
                                    ${position.symbol}${warningIcon}
                                </a>

                            ${!isFutu ? 
                                `<button class="btn btn-link btn-sm p-0 ms-2" 
                                        onclick='event.stopPropagation(); redownloadStockData("${position.symbol}", "${position.market_type || 'US'}", this)'>
                                    <i class="fas fa-sync-alt"></i>
                                </button>` : 
                                ''
                            }
                        </strong>
                    </td>
                    <td class="text-end"><strong>${formatNumber(position.total_market_value)}</strong></td>
                    <td class="text-end">
                        ${!isFutu ? 
                            `<div class="d-flex align-items-center justify-content-end">
                                <span class="current-price me-2">-</span>
                                <button class="btn btn-link btn-sm p-0" 
                                        onclick="getCurrentPrice('${position.symbol}', '${position.market_type || 'US'}', this)">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>` : 
                            '-'
                        }
                    </td>
                    <td class="text-center">-</td>
                    <td class="text-end ${position.total_unrealized_pnl >= 0 ? 'text-success' : 'text-danger'}">
                        <strong>${formatNumber(position.total_unrealized_pnl)}</strong>
                    </td>
                    <td class="text-end ${position.total_daily_pnl >= 0 ? 'text-success' : 'text-danger'}">
                        <strong>${formatNumber(position.total_daily_pnl)}</strong>
                    </td>
                    <td class="text-end ${position.total_position_ratio >= 0 ? 'text-success' : 'text-danger'}">
                        <strong>${formatNumber(position.total_position_ratio)}%</strong>
                    </td>
                </tr>`;

            // 渲染股票行（如果有）
            if (position.stock) {
                html += renderStockRow(position.stock, true);
            }

            // 渲染期权行
            position.options.forEach(option => {
                html += renderOptionRow(option, true);
            });
        } else {
            // 渲染单独的股票行
            html += renderStockRow(position, false);
        }
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function getCurrentPrice(stockCode, marketType, buttonElement) {
    // 禁用按钮并显示加载状态
    buttonElement.disabled = true;
    const originalIcon = buttonElement.innerHTML;
    buttonElement.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

    // 获取价格显示元素
    const priceElement = buttonElement.closest('div').querySelector('.current-price');
    
    fetch(`/api/current_price/${stockCode}?market_type=${marketType}`)
        .then(response => response.json())
        .then(data => {
            // 更新价格显示
            priceElement.textContent = formatNumber(data.current_price);
        })
        .catch(error => {
            console.error('获取价格失败:', error);
            priceElement.textContent = '获取失败';
        })
        .finally(() => {
            // 恢复按钮状态
            buttonElement.disabled = false;
            buttonElement.innerHTML = originalIcon;
        });
}

function renderStockRow(stock, isGroupItem) {
    const showWarning = stock.market_value < -2000 || stock.unrealized_pnl < -1000;
    const warningIcon = showWarning ? '⚠️ ' : '';
    
    // 只在模拟交易持仓中显示平仓按钮
    const closeButton = stock.position_id ? 
        `<button class="btn btn-danger btn-sm ms-2" 
            onclick="closePosition(${stock.position_id}, '${stock.symbol}')">
            平仓
        </button>` : '';
    
    return `
    <tr>
        <td>${isGroupItem ? '&nbsp;&nbsp;' : ''}${stock.symbol}${warningIcon}${closeButton}</td>
        <td class="text-end">${formatNumber(stock.market_value)}<br><small class="text-muted">${stock.quantity}</small></td>
        <td class="text-end">${formatNumber(stock.latest_price)}<br><small class="text-muted">${formatNumber(stock.average_cost)}</small></td>
        <!-- 新增空的Delta列，保持表格结构一致 -->
        <td class="text-center">-</td>
        <td class="text-end ${stock.unrealized_pnl >= 0 ? 'text-success' : 'text-danger'}">
            ${formatNumber(stock.unrealized_pnl)}
            <br><small>${formatNumber(stock.unrealized_pnl_percentage)}%</small>
        </td>
        <td class="text-end ${stock.daily_pnl >= 0 ? 'text-success' : 'text-danger'}">
            ${formatNumber(stock.daily_pnl)}
        </td>
        <td class="text-end">${formatNumber(stock.position_ratio)}%</td>
    </tr>`;
}
// 添加刷新delta值的函数
function refreshOptionDelta(optionSymbol, button) {
    // 禁用按钮并显示加载状态
    button.disabled = true;
    const originalIcon = button.innerHTML;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
    
    fetch(`/api/refresh_option_delta/${optionSymbol}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // 获取当前行的Delta单元格
            const row = button.closest('tr');
            const deltaCell = row.cells[3]; // Delta列是第4列(索引为3)
            const deltaSpan = deltaCell.querySelector('.badge');
            
            if (deltaSpan) {
                const deltaAbs = Math.abs(data.data.delta);
                let badgeClass = 'bg-info';
                
                // 判断风险等级
                if (deltaAbs >= 0.3) {
                    badgeClass = 'bg-danger';  // 高风险红色
                } else if (deltaAbs >= 0.2) {
                    badgeClass = 'bg-warning text-dark';  // 中风险黄色
                } else if (deltaAbs >= 0.15) {
                    badgeClass = 'bg-secondary';  // 低风险灰色
                }
                
                deltaSpan.className = `badge ${badgeClass}`;
                deltaSpan.textContent = `${formatNumber(data.data.delta, true)}`;
            }
        } else {
            alert('刷新失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('刷新失败，请查看控制台了解详情');
    })
    .finally(() => {
        // 恢复按钮状态
        button.disabled = false;
        button.innerHTML = originalIcon;
    });
}


// ... 添加平仓功能的函数 ...
function closePosition(positionId, symbol) {
    if (!confirm(`确定要平掉 ${symbol} 的持仓吗？`)) {
        return;
    }
    
    fetch(`/api/sim_trade/${positionId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // 刷新模拟持仓数据
            loadSimPositions();
            alert('平仓成功');
        } else {
            alert('平仓失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('平仓失败，请重试');
    });
}

function renderOptionRow(option, isGroupItem) {
    const indent = isGroupItem ? '&nbsp;&nbsp;' : '';
    const showWarning = option.market_value < -2000 || option.unrealized_pnl < -1000;
    const warningIcon = showWarning ? '⚠️ ' : '';

    // 检查是否是本周到期
    const today = new Date();
    const expiryDate = new Date(option.expiry);
    const endOfWeek = new Date(today);
    endOfWeek.setDate(today.getDate() + (6 - today.getDay())); // 设置为本周五
    const isExpiringThisWeek = expiryDate <= endOfWeek;
    
    // 为本周到期的期权添加醒目的标识
    const expiryWarning = isExpiringThisWeek ? 
        '<span class="badge bg-danger" style="font-size: 10px; padding: 2px 5px; margin-right: 5px;">本周到期</span>' : '';
    
    // 添加delta值的风险评估和显示
    let deltaBadgeClass = 'bg-info';  // 默认蓝色
    const deltaAbs = Math.abs(option.delta || 0);
    
    // 对于卖期权（持仓为负）进行风险评估
    if (option.quantity < 0) {
        if (deltaAbs >= 0.3) {
            deltaBadgeClass = 'bg-danger';  // 高风险用红色
        } else if (deltaAbs >= 0.2) {
            deltaBadgeClass = 'bg-warning text-dark';  // 中等风险用黄色
        } else if (deltaAbs >= 0.15) {
            deltaBadgeClass = 'bg-secondary';  // 低风险用灰色
        }
    }

    // 只在模拟交易持仓中显示平仓按钮
    const closeButton = option.position_id && option.is_sim ? 
        `<button class="btn btn-danger btn-sm ms-2" 
            onclick="closePosition(${option.position_id}, '${option.symbol}')">
            平仓
        </button>` : '';

    const refreshOption = option.delta !== undefined ? `
        <button class="btn btn-link btn-sm p-0" style="font-size: 14px;" 
                onclick="event.stopPropagation(); refreshOptionDelta('${option.futu_symbol}', this)" 
                title="刷新Delta值">
            <i class="fas fa-sync-alt"></i>
        </button>` : '';
    
    // Delta显示移到单独的列
    const deltaDisplay = option.delta !== undefined ? 
        `<span class="badge ${deltaBadgeClass}" style="font-size: 16px; padding: 2px 5px;">${formatNumber(option.delta, true)}</span>` : '-';
        
    return `
        <tr>
            <td>
                ${indent}${option.put_call} ${formatNumber(option.strike)} ${warningIcon}${closeButton}
                <br><small class="text-muted">
                    ${indent}${expiryWarning}${option.expiry}
                </small>
            </td>
            <td class="text-end">${formatNumber(option.market_value)}<br><small class="text-muted">${option.quantity}</small></td>
            <td class="text-end">${formatNumber(option.latest_price)}<br><small class="text-muted">${formatNumber(option.average_cost)}</small></td>
            <!-- 新增Delta列 -->
            <td class="text-center">
                ${deltaDisplay}${refreshOption ? `${refreshOption}` : ''}
            </td>
            <td class="text-end ${option.unrealized_pnl >= 0 ? 'text-success' : 'text-danger'}">
                ${formatNumber(option.unrealized_pnl)}
                <br><small>${formatNumber(option.unrealized_pnl_percentage)}%</small>
            </td>
            <td class="text-end ${option.daily_pnl >= 0 ? 'text-success' : 'text-danger'}">
                ${formatNumber(option.daily_pnl)}
            </td>
            <td class="text-end">${option.position_ratio ? formatNumber(option.position_ratio) : '-'}%</td>
        </tr>`;
    }

    // 添加排序相关函数
    function initSorting(container) {
        const headers = container.querySelectorAll('.sortable');
        headers.forEach(header => {
            header.addEventListener('click', () => {
                const sortKey = header.dataset.sort;
                const tbody = header.closest('table').querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr:not(.table-group-divider)'));
                
                // 获取所有行并按分组组织
                const allRows = Array.from(tbody.querySelectorAll('tr'));
                const groups = [];
                let currentGroup = null;
                
                allRows.forEach(row => {
                    if (row.classList.contains('table-group-divider')) {
                        // 如果遇到新的分组标题行
                        if (currentGroup) {
                            groups.push(currentGroup);
                        }
                        currentGroup = {
                            header: row,
                            rows: []
                        };
                    } else {
                        if (currentGroup && row.querySelector('td:first-child').innerHTML.includes('&nbsp;&nbsp;')) {
                            // 只有当行是缩进的（属于组合的子项）时才添加到当前组
                            currentGroup.rows.push(row);
                        } else {
                            // 否则作为独立行处理
                            groups.push({ header: null, rows: [row] });
                        }
                    }
                });
                
                if (currentGroup) {
                    groups.push(currentGroup);
                }
                
                // 移除其他列的排序标记
                headers.forEach(h => {
                    if (h !== header) {
                        const sortIcon = h.querySelector('.sort-icon');
                        if (sortIcon) { // 添加检查，确保元素存在
                            sortIcon.className = 'sort-icon';
                        }
                    }
                });
                
                // 切换排序方向
                const sortIcon = header.querySelector('.sort-icon');
                const isAsc = !sortIcon.classList.contains('sort-asc');
                sortIcon.className = `sort-icon ${isAsc ? 'sort-asc' : 'sort-desc'}`;
                
                // 对分组进行排序
                groups.sort((a, b) => {
                    let aVal, bVal;
                    
                    // 分别处理 a 和 b 的取值
                    aVal = a.header ? 
                        extractGroupValue(a.header, sortKey) : 
                        extractValue(a.rows[0], sortKey);
                    
                    bVal = b.header ? 
                        extractGroupValue(b.header, sortKey) : 
                        extractValue(b.rows[0], sortKey);
                    
                    if (typeof aVal === 'number' && typeof bVal === 'number') {
                        return isAsc ? aVal - bVal : bVal - aVal;
                    }
                    return isAsc ? 
                        String(aVal).localeCompare(String(bVal)) : 
                        String(bVal).localeCompare(String(aVal));
                });
                
                // 清空表格
                tbody.innerHTML = '';
                
                // 重新插入排序后的分组
                groups.forEach(group => {
                    if (group.header) {
                        tbody.appendChild(group.header);
                    }
                    group.rows.forEach(row => tbody.appendChild(row));
                });
            });
        });
    }

    function extractGroupValue(headerRow, key) {
        switch(key) {
            case 'symbol':
                return headerRow.cells[0].textContent.trim();
            case 'market_value':
                return parseFloat(headerRow.cells[1].textContent.replace(/[^0-9.-]+/g, '')) || 0;
            case 'unrealized_pnl':
                return parseFloat(headerRow.cells[3].textContent.replace(/[^0-9.-]+/g, '')) || 0;
            case 'position_ratio':
                return parseFloat(headerRow.cells[5].textContent.replace(/[^0-9.-]+/g, '')) || 0;
            default:
                return 0;
        }
    }

    function extractValue(row, key) {
        let cell;
        switch(key) {
            case 'symbol':
                cell = row.cells[0];
                return cell.textContent.trim();
            case 'market_value':
                cell = row.cells[1];
                return parseFloat(cell.textContent.split('\n')[0].replace(/[^0-9.-]+/g, '')) || 0;
            case 'latest_price':
                cell = row.cells[2];
                return parseFloat(cell.textContent.split('\n')[0].replace(/[^0-9.-]+/g, '')) || 0;
            case 'unrealized_pnl':
                cell = row.cells[3];
                return parseFloat(cell.textContent.split('\n')[1].replace(/[^0-9.-]+/g, '')) || 0;
            case 'daily_pnl':
                cell = row.cells[4];
                return parseFloat(cell.textContent.replace(/[^0-9.-]+/g, '')) || 0;
            case 'position_ratio':
                cell = row.cells[5];
                // 移除所有非数字字符（包括百分号），只保留数字和小数点
                const value = cell.textContent.replace(/[^0-9.-]+/g, '');
                return parseFloat(value) || 0;
            default:
                return 0;
        }
    }

// 添加更新股票数据的函数
    function redownloadStockData(stockCode, marketType, button) {
        // 禁用按钮并添加旋转动画
        button.disabled = true;
        button.querySelector('i').classList.add('fa-spin');

        const endpoint = marketType === 'US' ? '/download' : '/download_hk';
        
        fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ stock_code: stockCode })
        })
        .then(response => response.json())
        .then(data => {
            // 显示成功消息
            alert(`${data.message}\n总记录数: ${data.total}\n成功保存: ${data.count}\n处理失败: ${data.errors}`);
        })
        .catch(error => {
            console.error('更新数据失败:', error);
            alert('更新数据失败，请重试');
        })
        .finally(() => {
            // 恢复按钮状态，移除旋转动画
            button.disabled = false;
            button.querySelector('i').classList.remove('fa-spin');
        });
    }

</script>
{% endblock %}