{% extends "base.html" %}

{% block title %}èµ„äº§å…¨æ™¯ä»ªè¡¨ç›˜{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <h2>èµ„äº§å…¨æ™¯ä»ªè¡¨ç›˜</h2>
            <div>
                <button class="btn btn-warning me-2 text-dark" data-bs-toggle="modal" data-bs-target="#importModal">
                    <i class="fas fa-file-import"></i> æ‰¹é‡å¯¼å…¥
                </button>
                <button class="btn btn-info me-2 text-white" data-bs-toggle="modal" data-bs-target="#accountListModal">
                    <i class="fas fa-wallet"></i> è´¦æˆ·ç®¡ç†
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#assetModal">
                    <i class="fas fa-plus"></i> æ–°å¢èµ„äº§
                </button>
                <button class="btn btn-secondary ms-2" id="btnRefreshPrices" onclick="refreshPrices()">
                    <i class="fas fa-cloud-download-alt"></i> æ›´æ–°è¡Œæƒ…
                </button>
                <button class="btn btn-secondary ms-2" onclick="refreshData()">
                    <i class="fas fa-sync"></i> åˆ·æ–°æ•°æ®
                </button>
            </div>
        </div>
    </div>

    <!-- æ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡ -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-white bg-primary mb-3">
                <div class="card-body">
                    <h5 class="card-title">æ€»èµ„äº§</h5>
                    <h3 class="card-text" id="totalAssets">Loading...</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-success mb-3">
                <div class="card-body">
                    <h5 class="card-title">æ€»ç›ˆäº</h5>
                    <h3 class="card-text" id="totalPnL">Loading...</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-info mb-3">
                <div class="card-body">
                    <h5 class="card-title">æ€»æœ¬é‡‘</h5>
                    <h3 class="card-text" id="totalCost">Loading...</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾è¡¨åŒºåŸŸ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>èµ„äº§åˆ†å¸ƒ</span>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary active" onclick="switchChart('category_1')">ä¸€çº§åˆ†ç±»</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="switchChart('category_2')">äºŒçº§åˆ†ç±»</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="switchChart('account')">è´¦æˆ·</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="portfolioChart" style="height: 400px; width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- èµ„äº§æ˜ç»†è¡¨ -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>èµ„äº§æ˜ç»†</span>
                    <button class="btn btn-danger btn-sm" id="btnBatchDelete" onclick="batchDeleteAssets()" style="display: none;">
                        <i class="fas fa-trash"></i> æ‰¹é‡åˆ é™¤
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="assetTable">
                            <thead>
                                <tr>
                                    <th width="40"><input class="form-check-input" type="checkbox" id="selectAllAssets"></th>
                                    <th style="cursor:pointer" data-sort="account_name">è´¦æˆ· <i class="fas fa-sort"></i></th>
                                    <th style="cursor:pointer" data-sort="name">åç§°/ä»£ç  <i class="fas fa-sort"></i></th>
                                    <th style="cursor:pointer" data-sort="category_1">ä¸€çº§åˆ†ç±» <i class="fas fa-sort"></i></th>
                                    <th style="cursor:pointer" data-sort="category_2">äºŒçº§åˆ†ç±» <i class="fas fa-sort"></i></th>
                                    <th style="cursor:pointer" data-sort="quantity">æŒæœ‰æ•°é‡ <i class="fas fa-sort"></i></th>
                                    <th style="cursor:pointer" data-sort="cost_price">æˆæœ¬ä»· <i class="fas fa-sort"></i></th>
                                    <th style="cursor:pointer" data-sort="current_price">ç°ä»· <i class="fas fa-sort"></i></th>
                                    <th style="cursor:pointer" data-sort="market_value">å¸‚å€¼ <i class="fas fa-sort"></i></th>
                                    <th style="cursor:pointer" data-sort="pnl">ç›ˆäº <i class="fas fa-sort"></i></th>
                                    <th>æ“ä½œ</th>
                                </tr>
                                <tr class="filter-row bg-light">
                                    <th></th>
                                    <th>
                                        <select class="form-select form-select-sm column-filter" data-col="account_name" id="filterAccount">
                                            <option value="">å…¨éƒ¨</option>
                                            <!-- JS populated -->
                                        </select>
                                    </th>
                                    <th><input type="text" class="form-control form-control-sm column-filter" data-col="name" placeholder="ç­›é€‰..."></th>
                                    <th>
                                        <select class="form-select form-select-sm column-filter" data-col="category_1">
                                            <option value="">å…¨éƒ¨</option>
                                            <option value="æƒç›Šç±»">æƒç›Šç±»</option>
                                            <option value="å›ºæ”¶ç±»">å›ºæ”¶ç±»</option>
                                            <option value="å•†å“ç±»">å•†å“ç±»</option>
                                            <option value="ç°é‡‘ç±»">ç°é‡‘ç±»</option>
                                            <option value="å…¶ä»–">å…¶ä»–</option>
                                        </select>
                                    </th>
                                    <th><input type="text" class="form-control form-control-sm column-filter" data-col="category_2" placeholder="ç­›é€‰..."></th>
                                    <th></th><th></th><th></th><th></th><th></th><th></th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ–°å¢/ç¼–è¾‘èµ„äº§æ¨¡æ€æ¡† -->
<div class="modal fade" id="assetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">æ–°å¢èµ„äº§</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assetForm">
                    <input type="hidden" id="assetId">
                    <div class="mb-3">
                        <label class="form-label">è´¦æˆ·åç§°</label>
                        <select class="form-select" id="accountName" required>
                            <!-- JS populated -->
                        </select>
                    </div>
                    <div class="mb-3" style="display:none;">
                        <label class="form-label">èµ„äº§ç±»å‹ (è‡ªåŠ¨æ¨æ–­)</label>
                        <select class="form-select" id="assetType">
                            <option value="stock">è‚¡ç¥¨</option>
                            <option value="etf">ETF</option>
                            <option value="fund">åœºå¤–åŸºé‡‘</option>
                            <option value="cash">ç°é‡‘</option>
                            <option value="other">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">ä¸€çº§åˆ†ç±»</label>
                            <select class="form-select" id="category1">
                                <option value="">è¯·é€‰æ‹©...</option>
                                <option value="æƒç›Šç±»">æƒç›Šç±» (è‚¡ç¥¨/è‚¡åŸº)</option>
                                <option value="å›ºæ”¶ç±»">å›ºæ”¶ç±» (å€ºåˆ¸/ç†è´¢)</option>
                                <option value="å•†å“ç±»">å•†å“ç±» (é»„é‡‘/REITs)</option>
                                <option value="ç°é‡‘ç±»">ç°é‡‘ç±» (è´§å¸åŸºé‡‘/å­˜æ¬¾)</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">äºŒçº§åˆ†ç±»</label>
                            <input type="text" class="form-control" id="category2" list="cat2List">
                            <datalist id="cat2List">
                                <option value="å®½åŸº">
                                <option value="è¡Œä¸š">
                                <option value="çº¢åˆ©">
                                <option value="ç­–ç•¥">
                                <option value="QDII">
                                <option value="å€ºåˆ¸">
                                <option value="è´§å¸">
                            </datalist>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">ä»£ç </label>
                            <input type="text" class="form-control" id="symbol" placeholder="æŠ•é¡¾å¯ä¸å¡«ï¼Œè‡ªåŠ¨ç”Ÿæˆ">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">åç§°</label>
                            <input type="text" class="form-control" id="name">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">æŒæœ‰æ•°é‡</label>
                            <input type="number" step="any" class="form-control" id="quantity" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">æˆæœ¬ä»·</label>
                            <input type="number" step="any" class="form-control" id="costPrice" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">ç°ä»·</label>
                            <input type="number" step="any" class="form-control" id="currentPrice" placeholder="ä¸å¡«åˆ™è‡ªåŠ¨è·å–">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveAsset()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<!-- è´¦æˆ·åˆ—è¡¨ç®¡ç†æ¨¡æ€æ¡† -->
<div class="modal fade" id="accountListModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">è´¦æˆ·ç®¡ç†</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <button class="btn btn-success btn-sm" onclick="showAddAccountModal()">
                        <i class="fas fa-plus"></i> æ–°å¢è´¦æˆ·
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm" id="accountTable">
                        <thead>
                            <tr>
                                <th>åç§°</th>
                                <th>ç±»å‹</th>
                                <th>æè¿°</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Account list -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ–°å¢/ç¼–è¾‘è´¦æˆ·æ¨¡æ€æ¡† -->
<div class="modal fade" id="accountEditModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="accountModalTitle">æ–°å¢è´¦æˆ·</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="accountForm">
                    <input type="hidden" id="accountId">
                    <div class="mb-3">
                        <label class="form-label">è´¦æˆ·åç§°</label>
                        <input type="text" class="form-control" id="accName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">è´¦æˆ·ç±»å‹</label>
                        <select class="form-select" id="accType">
                            <option value="åˆ¸å•†">åˆ¸å•†</option>
                            <option value="é“¶è¡Œå¡">é“¶è¡Œå¡</option>
                            <option value="æ”¯ä»˜å®">æ”¯ä»˜å®</option>
                            <option value="å¾®ä¿¡">å¾®ä¿¡</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æè¿°</label>
                        <input type="text" class="form-control" id="accDesc">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveAccount()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<!-- æˆªå›¾å¯¼å…¥æ¨¡æ€æ¡† -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ‰¹é‡å¯¼å…¥èµ„äº§</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- æç¤ºåŒºåŸŸ -->
                <div class="alert alert-info py-2 small">
                    <i class="fas fa-info-circle"></i> æ¨èä½¿ç”¨ ChatGPT / Claude å°†æŒä»“æˆªå›¾è½¬æ¢ä¸º Markdown è¡¨æ ¼åç²˜è´´ã€‚
                    <br><strong>è¡¨å¤´éœ€åŒ…å«ï¼š</strong>ä»£ç ã€åç§°ã€æ•°é‡ã€æˆæœ¬ã€ç°ä»·ã€äºŒçº§åˆ†ç±»ï¼ˆå¯é€‰ï¼‰ã€‚
                </div>

                <!-- è¾“å…¥åŒºåŸŸ -->
                <div class="mb-3">
                    <label class="form-label fw-bold">1. ç²˜è´´ Markdown è¡¨æ ¼æ•°æ®</label>
                    <textarea class="form-control font-monospace" id="mdInput" rows="6" placeholder="| ä»£ç  | åç§° | äºŒçº§åˆ†ç±» | æ•°é‡ | æˆæœ¬ | ç°ä»· |
|---|---|---|---|---|---|
| 510300 | æ²ªæ·±300ETF | å®½åŸº | 10000 | 3.50 | 3.65 |"></textarea>
                </div>
                
                <div class="d-grid gap-2 mb-4">
                    <button class="btn btn-secondary" type="button" onclick="parseMarkdownInput()">
                        <i class="fas fa-magic"></i> è§£æè¡¨æ ¼æ•°æ®
                    </button>
                </div>
                
                <!-- æ‰¹é‡è®¾ç½® (å¯é€‰) -->
                <div class="card mb-3 bg-light border-0">
                    <div class="card-body py-2">
                        <div class="row g-2 align-items-center">
                            <div class="col-auto"><small class="fw-bold">ç»Ÿä¸€è®¾ç½®ï¼š</small></div>
                            <div class="col-md-4">
                                <select class="form-select form-select-sm" id="batchAccount">
                                    <!-- JSå¡«å…… -->
                                </select>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select form-select-sm" id="batchCategory1">
                                    <option value="æƒç›Šç±»">æƒç›Šç±»</option>
                                    <option value="å›ºæ”¶ç±»">å›ºæ”¶ç±»</option>
                                    <option value="å•†å“ç±»">å•†å“ç±»</option>
                                    <option value="ç°é‡‘ç±»">ç°é‡‘ç±»</option>
                                    <option value="å…¶ä»–">å…¶ä»–</option>
                                </select>
                            </div>
                            <div class="col-auto text-muted small">(ä»…å¯¹æ–°è§£æçš„æ•°æ®ç”Ÿæ•ˆ)</div>
                        </div>
                    </div>
                </div>

                <!-- å¾…å¯¼å…¥åˆ—è¡¨ -->
                <div id="ocrResult" style="display: none;">
                    <label class="form-label fw-bold">2. ç¡®è®¤å¾…å¯¼å…¥åˆ—è¡¨</label>
                    <div class="table-responsive border rounded" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-striped mb-0" id="ocrTable">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width: 20%">åç§°</th>
                                    <th style="width: 15%">ä»£ç </th>
                                    <th style="width: 15%">äºŒçº§åˆ†ç±»</th>
                                    <th style="width: 15%">æ•°é‡</th>
                                    <th style="width: 15%">æˆæœ¬</th>
                                    <th style="width: 15%">ç°ä»·</th>
                                    <th style="width: 5%">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="d-grid gap-2 mt-3">
                        <button class="btn btn-primary btn-lg" onclick="importAllAssets()">
                            <i class="fas fa-file-import"></i> å…¨éƒ¨å¯¼å…¥å¹¶ä¿å­˜
                        </button>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let portfolioData = null;
let currentChartType = 'category_1';
let myChart = null;
let allAccounts = [];
let currentSort = { field: 'update_time', asc: false }; // é»˜è®¤æŒ‰æ›´æ–°æ—¶é—´é™åºæ’åˆ—
let currentFilters = {}; // å­˜å‚¨è¿‡æ»¤æ¡ä»¶ { col: value }

$(document).ready(function() {
    refreshData();
    initChart();
    refreshAccountOptions(); // Load accounts for filter immediately
    
    // Table Header Click for Sorting
    $('#assetTable thead th[data-sort]').on('click', function() {
        const field = $(this).data('sort');
        if (currentSort.field === field) {
            currentSort.asc = !currentSort.asc;
        } else {
            currentSort.field = field;
            currentSort.asc = true;
        }
        
        // Update Sort Icons
        $('#assetTable thead th i').removeClass('fa-sort-up fa-sort-down').addClass('fa-sort');
        $(this).find('i').removeClass('fa-sort').addClass(currentSort.asc ? 'fa-sort-up' : 'fa-sort-down');
        
        sortAndRenderTable();
    });
    
    // Column Filter Logic
    $('.column-filter').on('input change', function() {
        const col = $(this).data('col');
        const val = $(this).val().toLowerCase().trim();
        currentFilters[col] = val;
        sortAndRenderTable();
    });
    
    // Checkbox Logic
    $('#selectAllAssets').change(function() {
        $('.asset-select').prop('checked', $(this).is(':checked'));
        toggleBatchDeleteBtn();
    });

    $('#assetTable tbody').on('change', '.asset-select', function() {
        const allChecked = $('.asset-select:checked').length === $('.asset-select').length;
        $('#selectAllAssets').prop('checked', allChecked);
        toggleBatchDeleteBtn();
    });
    
    // Load accounts when modal is opened
    $('#accountListModal').on('show.bs.modal', function () {
        loadAccounts();
    });
    
    // Refresh account datalist when asset modal is opened
    $('#assetModal').on('show.bs.modal', function() {
        refreshAccountOptions();
    });

    // Refresh account list when import modal is opened
    $('#importModal').on('show.bs.modal', function() {
        refreshAccountOptions();
    });
    
    // Paste event listener for import modal
    const importModal = document.getElementById('importModal');
    const fileInput = document.getElementById('screenshotFile');
    const imgPreview = document.getElementById('imagePreview');
    
    // OCR Data State
    let ocrData = null; // { rawTexts: [], imgSize: {width, height} }

    // Monitor symbol input to toggle add button
    $('#ocr-symbol').on('input', function() {
        const val = $(this).val().trim();
        $('#btn-add-ocr-asset').prop('disabled', !val);
    });

    // Helper to preview image
    function previewImage(file) {
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                imgPreview.src = e.target.result;
                imgPreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            imgPreview.style.display = 'none';
        }
    }

    // Manual selection handler
    fileInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            previewImage(this.files[0]);
        }
    });

    importModal.addEventListener('paste', function(e) {
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let index in items) {
            const item = items[index];
            if (item.kind === 'file' && item.type.indexOf('image/') !== -1) {
                const blob = item.getAsFile();
                
                // Create a DataTransfer to set the file input
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(blob);
                fileInput.files = dataTransfer.files;
                
                // Show preview
                previewImage(blob);
                
                fileInput.classList.add('is-valid');
                setTimeout(() => fileInput.classList.remove('is-valid'), 1000);
                break;
            }
        }
    });
});

function loadAccounts() {
    $.get('/api/portfolio/accounts', function(res) {
        allAccounts = res;
        const tbody = $('#accountTable tbody');
        tbody.empty();
        
        res.forEach(acc => {
            const row = `
                <tr>
                    <td>${acc.name}</td>
                    <td>${acc.type || '-'}</td>
                    <td>${acc.description || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick='editAccount(${JSON.stringify(acc)})'>
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteAccount(${acc.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });
    });
}

function showAddAccountModal() {
    $('#accountModalTitle').text('æ–°å¢è´¦æˆ·');
    $('#accountId').val('');
    document.getElementById('accountForm').reset();
    $('#accountListModal').modal('hide');
    new bootstrap.Modal(document.getElementById('accountEditModal')).show();
}

function editAccount(acc) {
    $('#accountModalTitle').text('ç¼–è¾‘è´¦æˆ·');
    $('#accountId').val(acc.id);
    $('#accName').val(acc.name);
    $('#accType').val(acc.type);
    $('#accDesc').val(acc.description);
    
    $('#accountListModal').modal('hide');
    new bootstrap.Modal(document.getElementById('accountEditModal')).show();
}

function saveAccount() {
    const data = {
        id: $('#accountId').val() || null,
        name: $('#accName').val(),
        type: $('#accType').val(),
        description: $('#accDesc').val()
    };
    
    $.ajax({
        url: '/api/portfolio/account',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(res) {
            $('#accountEditModal').modal('hide');
            // Re-open list modal
            new bootstrap.Modal(document.getElementById('accountListModal')).show();
            loadAccounts(); // Reload list
        },
        error: function(err) {
            alert('ä¿å­˜å¤±è´¥: ' + err.responseJSON.message);
        }
    });
}

function deleteAccount(id) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè´¦æˆ·å—ï¼Ÿ')) {
        $.ajax({
            url: `/api/portfolio/account/${id}`,
            type: 'DELETE',
            success: function() {
                loadAccounts();
            },
            error: function() {
                alert('åˆ é™¤å¤±è´¥');
            }
        });
    }
}

function determineAssetType(cat1, symbol) {
    if (cat1 === 'ç°é‡‘ç±»') return 'cash';
    if (cat1 === 'æƒç›Šç±»' || cat1 === 'å›ºæ”¶ç±»' || cat1 === 'å•†å“ç±»') {
        // Simple guess based on symbol
        if (symbol.startsWith('1') || symbol.startsWith('5')) return 'etf';
        if (symbol.length === 6 && (symbol.startsWith('6') || symbol.startsWith('0') || symbol.startsWith('3') || symbol.startsWith('8') || symbol.startsWith('4'))) return 'stock';
        return 'fund'; // Default to fund/other
    }
    return 'other';
}

function refreshAccountOptions() {
    // Load accounts for select
    $.get('/api/portfolio/accounts', function(res) {
        allAccounts = res;
        
        // Populate Asset Modal Select
        const assetSelect = $('#accountName');
        const currentVal = assetSelect.val(); 
        assetSelect.empty();
        
        // Populate Batch Import Select
        const batchSelect = $('#batchAccount');
        const batchVal = batchSelect.val();
        batchSelect.empty();
        
        // Populate Filter Select
        const filterSelect = $('#filterAccount');
        const filterVal = filterSelect.val();
        filterSelect.empty();
        filterSelect.append('<option value="">å…¨éƒ¨</option>'); // Reset default
        
        if (res.length === 0) {
            const noOpt = '<option value="">æ— è´¦æˆ·ï¼Œè¯·å…ˆåˆ›å»º</option>';
            assetSelect.append(noOpt);
            batchSelect.append(noOpt);
        } else {
            res.forEach(acc => {
                const opt = `<option value="${acc.name}">${acc.name}</option>`;
                assetSelect.append(opt);
                
                const batchOpt = `<option value="${acc.name}">${acc.name} (${acc.type || '-'})</option>`;
                batchSelect.append(batchOpt);
                
                filterSelect.append(`<option value="${acc.name}">${acc.name}</option>`);
            });
        }
        
        // Restore selection if valid
        if (currentVal) assetSelect.val(currentVal);
        if (batchVal) batchSelect.val(batchVal);
        if (filterVal) filterSelect.val(filterVal);
    });
}

function initChart() {
    myChart = echarts.init(document.getElementById('portfolioChart'));
    window.addEventListener('resize', function() {
        myChart.resize();
    });
}

function refreshPrices() {
    const btn = $('#btnRefreshPrices');
    const originalContent = btn.html();
    btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> æ›´æ–°ä¸­...');
    
    $.ajax({
        url: '/api/portfolio/refresh_prices',
        type: 'POST',
        success: function(res) {
            alert(`è¡Œæƒ…æ›´æ–°å®Œæˆï¼\næˆåŠŸæ›´æ–°äº† ${res.updated_count} ä¸ªèµ„äº§çš„ä»·æ ¼ã€‚`);
            refreshData(); // Reload data from DB
        },
        error: function(err) {
            alert('æ›´æ–°å¤±è´¥: ' + (err.responseJSON ? err.responseJSON.message : err.statusText));
        },
        complete: function() {
            btn.prop('disabled', false).html(originalContent);
        }
    });
}

function refreshData() {
    $.get('/api/portfolio/data', function(res) {
        portfolioData = res;
        updateDashboard();
        sortAndRenderTable(); // ä½¿ç”¨å½“å‰çš„æ’åºçŠ¶æ€æ¸²æŸ“è¡¨æ ¼
        updateChart();
        updateDatalists();
    }).fail(function(err) {
        console.error("Load data failed", err);
        // alert("è·å–èµ„äº§æ•°æ®å¤±è´¥: " + (err.responseJSON ? err.responseJSON.message : err.statusText));
        $('#totalAssets, #totalPnL, #totalCost').text('åŠ è½½å¤±è´¥');
    });
}

function sortAndRenderTable() {
    if (!portfolioData || !portfolioData.assets) return;
    
    // 1. Copy and Filter
    let data = portfolioData.assets.filter(item => {
        for (const [col, filterVal] of Object.entries(currentFilters)) {
            if (!filterVal) continue;
            
            // Special handling for 'name' to search both name and symbol
            if (col === 'name') {
                const name = (item.name || '').toLowerCase();
                const symbol = (item.symbol || '').toLowerCase();
                if (!name.includes(filterVal) && !symbol.includes(filterVal)) return false;
            } else {
                const val = String(item[col] || '').toLowerCase();
                if (!val.includes(filterVal)) return false;
            }
        }
        return true;
    });
    
    // 2. Sort
    const field = currentSort.field;
    const isAsc = currentSort.asc;
    
    data.sort((a, b) => {
        let valA = a[field];
        let valB = b[field];
        
        if (valA === null || valA === undefined) valA = '';
        if (valB === null || valB === undefined) valB = '';
        
        if (typeof valA === 'string') {
            return isAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
        }
        return isAsc ? valA - valB : valB - valA;
    });
    
    updateTable(data);
}

function updateDashboard() {
    const sum = portfolioData.summary;
    $('#totalAssets').text(formatCurrency(sum.total_assets));
    $('#totalCost').text(formatCurrency(sum.total_cost));
    $('#totalPnL').text(formatCurrency(sum.total_pnl));
    
    // Set color for PnL
    const pnlClass = sum.total_pnl >= 0 ? 'bg-success' : 'bg-danger';
    $('#totalPnL').parent().parent().removeClass('bg-success bg-danger').addClass(pnlClass);
}

function updateTable(data) {
    const tbody = $('#assetTable tbody');
    tbody.empty();
    
    // Reset selection state
    $('#selectAllAssets').prop('checked', false);
    toggleBatchDeleteBtn();
    
    const assets = data || (portfolioData ? portfolioData.assets : []);
    if (!assets || assets.length === 0) {
        tbody.html('<tr><td colspan="11" class="text-center text-muted">æ— æ•°æ®</td></tr>');
        return;
    }
    
    assets.forEach(asset => {
        const pnlClass = asset.pnl >= 0 ? 'text-success' : 'text-danger';
        const row = `
            <tr>
                <td><input class="form-check-input asset-select" type="checkbox" value="${asset.id}"></td>
                <td>${asset.account_name}</td>
                <td>
                    <div>${asset.name || '-'}</div>
                    <small class="text-muted">${asset.symbol}</small>
                </td>
                <td>${asset.category_1 || '-'}</td>
                <td>${asset.category_2 || '-'}</td>
                <td>${asset.quantity}</td>
                <td>${formatNumber(asset.cost_price)}</td>
                <td>${formatNumber(asset.current_price)}</td>
                <td>${formatNumber(asset.market_value)}</td>
                <td class="${pnlClass}">
                    <div>${formatNumber(asset.pnl)}</div>
                    <small>(${asset.pnl_percent.toFixed(2)}%)</small>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick='editAsset(${JSON.stringify(asset)})'>
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.append(row);
    });
}

function updateChart() {
    if (!portfolioData) return;
    
    let data = [];
    let title = '';
    
    switch(currentChartType) {
        case 'category_1':
            data = portfolioData.summary.by_category_1;
            title = 'æŒ‰ä¸€çº§åˆ†ç±»';
            break;
        case 'category_2':
            data = portfolioData.summary.by_category_2;
            title = 'æŒ‰äºŒçº§åˆ†ç±»';
            break;
        case 'account':
            data = portfolioData.summary.by_account;
            title = 'æŒ‰è´¦æˆ·åˆ†å¸ƒ';
            break;
        case 'asset_type':
            data = portfolioData.summary.by_asset_type;
            title = 'æŒ‰èµ„äº§å½¢æ€';
            break;
    }
    
    const option = {
        title: {
            text: title,
            left: 'center'
        },
        tooltip: {
            trigger: 'item',
            formatter: function(params) {
                return `${params.name}<br/>å¸‚å€¼: <b>Â¥${params.value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</b> (${params.percent}%)`;
            }
        },
        legend: {
            orient: 'vertical',
            left: 'left'
        },
        series: [
            {
                name: 'èµ„äº§åˆ†å¸ƒ',
                type: 'pie',
                radius: ['40%', '70%'],
                avoidLabelOverlap: false,
                itemStyle: {
                    borderRadius: 10,
                    borderColor: '#fff',
                    borderWidth: 2
                },
                label: {
                    show: false,
                    position: 'center'
                },
                emphasis: {
                    label: {
                        show: true,
                        fontSize: 20,
                        fontWeight: 'bold',
                        formatter: function(params) {
                            return `${params.name}\nÂ¥${params.value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                        }
                    }
                },
                labelLine: {
                    show: false
                },
                data: data
            }
        ]
    };
    
    myChart.setOption(option);
}

function switchChart(type) {
    currentChartType = type;
    // Update button states
    $('.btn-group .btn').removeClass('active');
    $(`.btn-group .btn[onclick="switchChart('${type}')"]`).addClass('active');
    updateChart();
}

function saveAsset() {
    const cat1 = $('#category1').val();
    let symbol = $('#symbol').val().trim();
    const name = $('#name').val().trim();
    
    // Auto-generate symbol for investment advisors/others if missing
    if (!symbol && name) {
        const hash = name.split('').reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);
        symbol = 'TG_' + Math.abs(hash).toString(16).toUpperCase();
    }
    
    // Auto-determine asset type ONLY if value is missing (New mode)
    // In Edit mode, val() is populated by editAsset, so we keep it.
    let aType = $('#assetType').val();
    if (!aType) {
        aType = determineAssetType(cat1, symbol);
    }

    const data = {
        id: $('#assetId').val() || null,
        account_name: $('#accountName').val(),
        asset_type: aType,
        category_1: cat1,
        category_2: $('#category2').val(),
        symbol: symbol,
        name: name,
        quantity: parseFloat($('#quantity').val()),
        cost_price: parseFloat($('#costPrice').val()),
        last_price: parseFloat($('#currentPrice').val()) || 0
    };
    
    $.ajax({
        url: '/api/portfolio/asset',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(res) {
            $('#assetModal').modal('hide');
            refreshData();
            document.getElementById('assetForm').reset();
            $('#assetId').val(''); // Clear ID for next add
        },
        error: function(err) {
            alert('ä¿å­˜å¤±è´¥: ' + err.responseJSON.message);
        }
    });
}

function deleteAsset(id) {
    // å·²åºŸå¼ƒï¼Œä¿ç•™ä½œä¸ºå•è¡Œåˆ é™¤çš„é€»è¾‘å‚è€ƒ
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡èµ„äº§è®°å½•å—ï¼Ÿ')) {
        $.ajax({
            url: `/api/portfolio/asset/${id}`,
            type: 'DELETE',
            success: function() {
                refreshData();
            },
            error: function() {
                alert('åˆ é™¤å¤±è´¥');
            }
        });
    }
}

function toggleBatchDeleteBtn() {
    const count = $('.asset-select:checked').length;
    const btn = $('#btnBatchDelete');
    if (count > 0) {
        btn.show().html(`<i class="fas fa-trash"></i> æ‰¹é‡åˆ é™¤ (${count})`);
    } else {
        btn.hide();
    }
}

function batchDeleteAssets() {
    const ids = [];
    $('.asset-select:checked').each(function() {
        ids.push($(this).val());
    });
    
    if (ids.length === 0) return;
    
    if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${ids.length} æ¡èµ„äº§è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) return;
    
    const btn = $('#btnBatchDelete');
    btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> åˆ é™¤ä¸­...');
    
    let completed = 0;
    let failed = 0;
    
    // ä½¿ç”¨ Promise.allSettled æˆ–ç®€å•è®¡æ•°
    const promises = ids.map(id => {
        return new Promise(resolve => {
            $.ajax({
                url: `/api/portfolio/asset/${id}`,
                type: 'DELETE',
                success: () => resolve(true),
                error: () => {
                    failed++;
                    resolve(false);
                }
            });
        });
    });
    
    Promise.all(promises).then(() => {
        btn.prop('disabled', false);
        if (failed > 0) {
            alert(`åˆ é™¤å®Œæˆã€‚æˆåŠŸ: ${ids.length - failed}, å¤±è´¥: ${failed}`);
        }
        refreshData();
    });
}

function editAsset(asset) {
    $('#modalTitle').text('ç¼–è¾‘èµ„äº§');
    $('#assetId').val(asset.id);
    $('#accountName').val(asset.account_name);
    $('#assetType').val(asset.asset_type);
    $('#category1').val(asset.category_1);
    $('#category2').val(asset.category_2);
    $('#symbol').val(asset.symbol);
    $('#name').val(asset.name);
    $('#quantity').val(asset.quantity);
    $('#costPrice').val(asset.cost_price);
    $('#currentPrice').val(asset.last_price || ''); 
    
    const modal = new bootstrap.Modal(document.getElementById('assetModal'));
    modal.show();
}

// Helper: Populate datalists for autocomplete
function updateDatalists() {
    if (!portfolioData) return;
    
    // Default options based on new classification
    const defaultCat2 = [
        // æƒç›Šç±»
        'å®½åŸº', 'è¡Œä¸š', 'çº¢åˆ©', 'ç­–ç•¥', 'QDII', 'ä¸ªè‚¡', 'ç§‘æŠ€', 'æ¶ˆè´¹', 'åŒ»è¯', 'é‡‘è', 'æ–°èƒ½æº',
        // å›ºæ”¶ç±»
        'åˆ©ç‡å€º', 'ä¿¡ç”¨å€º', 'å¯è½¬å€º', 'ç†è´¢',
        // å•†å“/å¦ç±»
        'é»„é‡‘', 'åŸæ²¹', 'REITs', 'è±†ç²•',
        // ç°é‡‘
        'è´§å¸', 'å­˜æ¬¾'
    ];
    const cat2s = new Set(defaultCat2);
    
    portfolioData.assets.forEach(a => {
        if (a.category_2) cat2s.add(a.category_2);
    });
    
    populateDatalist('cat2List', cat2s);
}

function populateDatalist(id, set) {
    const list = $(`#${id}`);
    list.empty();
    set.forEach(val => {
        list.append(`<option value="${val}">`);
    });
}

// Helper: Formatting
function formatCurrency(num) {
    return new Intl.NumberFormat('zh-CN', { style: 'currency', currency: 'CNY' }).format(num);
}

function formatNumber(num) {
    return new Intl.NumberFormat('zh-CN', { maximumFractionDigits: 2 }).format(num);
}

// æˆªå›¾ä¸Šä¼ é€»è¾‘
let ocrCurrentStep = 'name'; // name -> symbol -> qty -> cost

// uploadScreenshot removed

// renderOcrItems removed

function resetOcrForm() {
    // Only used to clear inputs, though inputs are now driven by markdown parsing
    // But we might need it if we keep manual add? No, manual add is removed from UI.
    // So this function is actually unused, but parseMarkdown calls it?
    // Wait, parseMarkdownInput calls appendAssetRow, which doesn't need reset.
    // Let's check parseMarkdownInput... it doesn't call resetOcrForm.
    // So we can remove all these.
}

// Removed: setOcrStep, focus listener, onChipClick, addOcrAssetToTable

function appendAssetRow(asset) {
    const index = Date.now() + Math.floor(Math.random() * 1000); // Ensure unique
    const row = `
        <tr id="ocr-row-${index}">
            <td><input type="text" class="form-control form-control-sm asset-name" value="${asset.name || ''}"></td>
            <td><input type="text" class="form-control form-control-sm asset-symbol" value="${asset.symbol || ''}"></td>
            <td><input type="text" class="form-control form-control-sm asset-cat2" value="${asset.cat2 || ''}" placeholder="äºŒçº§åˆ†ç±»" list="cat2List"></td>
            <td><input type="number" class="form-control form-control-sm asset-qty" value="${asset.qty || ''}"></td>
            <td><input type="number" class="form-control form-control-sm asset-cost" value="${asset.cost || ''}"></td>
            <td><input type="number" class="form-control form-control-sm asset-last-price" value="${asset.lastPrice || ''}"></td>
            <td>
                <button class="btn btn-sm btn-outline-danger border-0" onclick="$(this).closest('tr').remove()" title="åˆ é™¤">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        </tr>
    `;
    $('#ocrTable tbody').append(row);
}

function parseMarkdownInput() {
    const text = $('#mdInput').val().trim();
    if (!text) return alert('è¯·ç²˜è´´ Markdown è¡¨æ ¼å†…å®¹');
    
    const lines = text.split('\n').filter(line => line.trim() && line.includes('|'));
    if (lines.length < 2) return alert('æœªè¯†åˆ«åˆ°æœ‰æ•ˆçš„ Markdown è¡¨æ ¼');
    
    // 1. Parse Header
    const headerLine = lines[0];
    const headers = headerLine.split('|').map(h => h.trim()).filter(h => h);
    
    // Mapping: header text -> field key
    const mapping = {};
    headers.forEach((h, index) => {
        if (h.includes('ä»£ç ') || h.includes('Symbol')) mapping[index] = 'symbol';
        else if (h.includes('åç§°') || h.includes('Name')) mapping[index] = 'name';
        else if (h.includes('æ•°é‡') || h.includes('Qty') || h.includes('æŒä»“')) mapping[index] = 'qty';
        else if (h.includes('æˆæœ¬') || h.includes('Cost')) mapping[index] = 'cost';
        else if (h.includes('ç°ä»·') || h.includes('Price') || h.includes('æœ€æ–°')) mapping[index] = 'lastPrice';
        else if (h.includes('äºŒçº§') || h.includes('åˆ†ç±»') || h.includes('Type')) mapping[index] = 'cat2';
    });
    
    if (!Object.values(mapping).includes('symbol')) {
        alert('è­¦å‘Šï¼šæœªè¯†åˆ«åˆ°â€œä»£ç â€åˆ—ï¼Œè¯·æ£€æŸ¥è¡¨å¤´æ˜¯å¦åŒ…å«â€œä»£ç â€å­—æ ·');
    }
    
    // 2. Parse Data Rows
    let addedCount = 0;
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (line.includes('---')) continue; // Skip separator line
        
        const cols = line.split('|').map(c => c.trim()).filter(c => c !== ''); // simple split, might need regex for escaped pipes
        // Note: .split('|') might produce empty strings at start/end if line starts/ends with |
        // Better way: remove leading/trailing |, then split
        
        const cleanLine = line.replace(/^\||\|$/g, '');
        const values = cleanLine.split('|').map(c => c.trim());
        
        if (values.length < headers.length) continue; // Skip incomplete lines
        
        const asset = {};
        let hasData = false;
        
        Object.keys(mapping).forEach(colIndex => {
            if (values[colIndex]) {
                // Remove currency symbols, commas for numeric fields
                let val = values[colIndex];
                const field = mapping[colIndex];
                
                if (['qty', 'cost', 'lastPrice'].includes(field)) {
                    val = val.replace(/[Â¥$,]/g, '');
                }
                
                asset[field] = val;
                hasData = true;
            }
        });
        
        if (hasData) {
            // å¦‚æœæ²¡æœ‰ä»£ç ä½†æœ‰åç§°ï¼Œç”Ÿæˆè™šæ‹Ÿä»£ç  (æŠ•é¡¾/ç†è´¢)
            if (!asset.symbol && asset.name) {
                // Generate simple hash or timestamp
                const hash = asset.name.split('').reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);
                asset.symbol = 'TG_' + Math.abs(hash).toString(16).toUpperCase();
            }
            
            if (asset.symbol) {
                appendAssetRow(asset);
                addedCount++;
            }
        }
    }
    
    if (addedCount > 0) {
        alert(`ğŸ‰ æˆåŠŸè§£æå¹¶æ·»åŠ äº† ${addedCount} æ¡èµ„äº§è®°å½•ï¼\nè¯·åœ¨ä¸‹æ–¹åˆ—è¡¨ç¡®è®¤æ— è¯¯åï¼Œç‚¹å‡»â€œå…¨éƒ¨å¯¼å…¥â€æŒ‰é’®ä¿å­˜ã€‚`);
        $('#mdInput').val(''); // Clear input
        $('#ocrResult').show(); // Ensure table is visible
        $('#markdownArea').collapse('hide');
    } else {
        alert('æœªè§£æåˆ°æœ‰æ•ˆæ•°æ®ï¼Œè¯·æ£€æŸ¥ Markdown æ ¼å¼');
    }
}

function importAllAssets() {
    const rows = $('#ocrTable tbody tr');
    if (rows.length === 0) {
        return alert('åˆ—è¡¨ä¸ºç©ºï¼Œè¯·å…ˆæ·»åŠ èµ„äº§');
    }
    
    // è·å–å…¬å…±å­—æ®µ
    const accountName = $('#batchAccount').val(); // From select
    const cat1 = $('#batchCategory1').val();
    
    if (!accountName) {
        return alert('è¯·å…ˆè®¾ç½®ã€å½’å±è´¦æˆ·ã€‘');
    }
    
    const assets = [];
    rows.each(function() {
        const row = $(this);
        const symbol = row.find('.asset-symbol').val().trim();
        const cat2 = row.find('.asset-cat2').val().trim();
        
        assets.push({
            account_name: accountName,
            category_1: cat1,
            category_2: cat2, // From row
            symbol: symbol,
            name: row.find('.asset-name').val().trim(),
            quantity: parseFloat(row.find('.asset-qty').val()) || 0,
            cost_price: parseFloat(row.find('.asset-cost').val()) || 0,
            last_price: parseFloat(row.find('.asset-last-price').val()) || 0,
            asset_type: determineAssetType(cat1, symbol)
        });
    });
    
    if (!confirm(`ç¡®è®¤å¯¼å…¥è¿™ ${assets.length} æ¡èµ„äº§åˆ°è´¦æˆ· [${accountName}] å—ï¼Ÿ`)) return;
    
    const btn = $('button[onclick="importAllAssets()"]');
    const originalText = btn.html();
    btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> æ­£åœ¨å¯¼å…¥...');
    
    // ä¸²è¡Œæäº¤ï¼ˆå› ä¸ºåç«¯ç›®å‰åªæ”¯æŒå•æ¡æ·»åŠ ï¼‰
    let successCount = 0;
    let failCount = 0;
    
    // ä½¿ç”¨ Promise é“¾æˆ– async/await
    // è¿™é‡Œç®€å•ç”¨ reduce æ¥ä¸²è¡Œæ‰§è¡Œ Promise
    assets.reduce((promise, asset) => {
        return promise.then(() => {
            return new Promise((resolve) => {
                $.ajax({
                    url: '/api/portfolio/asset',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(asset),
                    success: function() {
                        successCount++;
                        resolve();
                    },
                    error: function() {
                        failCount++;
                        resolve(); // ç»§ç»­ä¸‹ä¸€ä¸ª
                    }
                });
            });
        });
    }, Promise.resolve()).then(() => {
        btn.prop('disabled', false).html(originalText);
        alert(`å¯¼å…¥å®Œæˆï¼æˆåŠŸ: ${successCount}, å¤±è´¥: ${failCount}`);
        
        if (successCount > 0) {
            $('#importModal').modal('hide');
            refreshData(); // åˆ·æ–°ä¸»åˆ—è¡¨
            
            // æ¸…ç©ºè¡¨æ ¼
            $('#ocrTable tbody').empty();
        }
    });
}

// Reset form when modal closes
$('#assetModal').on('hidden.bs.modal', function () {
    $('#modalTitle').text('æ–°å¢èµ„äº§');
    $('#assetId').val('');
    $('#assetType').val(''); // Clear hidden field
    document.getElementById('assetForm').reset();
});
</script>
{% endblock %}
