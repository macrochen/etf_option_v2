{% extends "base.html" %}

{% block title %}资产全景仪表盘{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <h2>资产全景仪表盘 <button class="btn btn-sm btn-outline-secondary ms-2 border-0" id="toggleSensitiveBtn" onclick="toggleSensitivity()"><i class="fas fa-eye-slash"></i></button></h2>
            <div>
                <button class="btn btn-warning me-2 text-dark" data-bs-toggle="modal" data-bs-target="#importModal">
                    <i class="fas fa-file-import"></i> 批量导入
                </button>
                <button class="btn btn-info me-2 text-white" data-bs-toggle="modal" data-bs-target="#accountListModal">
                    <i class="fas fa-wallet"></i> 账户管理
                </button>
                <button class="btn btn-success me-2" onclick="showLedgerModal()">
                    <i class="fas fa-file-invoice-dollar"></i> 导出账本
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#assetModal">
                    <i class="fas fa-plus"></i> 新增资产
                </button>
                <button class="btn btn-secondary ms-2" id="btnRefreshPrices" onclick="refreshPrices()">
                    <i class="fas fa-cloud-download-alt"></i> 更新行情
                </button>
                <button class="btn btn-secondary ms-2" onclick="refreshData()">
                    <i class="fas fa-sync"></i> 刷新数据
                </button>
            </div>
        </div>
    </div>

    <!-- 核心指标卡片 -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-white bg-primary mb-3">
                <div class="card-body">
                    <h5 class="card-title">总资产</h5>
                    <h3 class="card-text" id="totalAssets">Loading...</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-success mb-3">
                <div class="card-body">
                    <h5 class="card-title">总盈亏</h5>
                    <h3 class="card-text" id="totalPnL">Loading...</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-info mb-3">
                <div class="card-body">
                    <h5 class="card-title">总本金</h5>
                    <h3 class="card-text" id="totalCost">Loading...</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- 资产趋势图 & 异动分析 -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header">
                    资产周趋势分析 (每周记录)
                </div>
                <div class="card-body">
                    <div id="trendChart" style="height: 300px; width: 100%;"></div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header">
                    重点关注 (累计盈亏)
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush" id="topMoversList">
                        <!-- JS Populated -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 图表区域 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>资产分布</span>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary active" onclick="switchChart('category_1')">一级分类</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="switchChart('category_2')">二级分类</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="switchChart('account')">账户</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="portfolioChart" style="height: 400px; width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 资产明细表 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>资产明细</span>
                    <button class="btn btn-danger btn-sm" id="btnBatchDelete" onclick="batchDeleteAssets()" style="display: none;">
                        <i class="fas fa-trash"></i> 批量删除
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-striped table-hover mb-0" id="assetTable">
                            <thead class="sticky-top bg-white" style="z-index: 1;">
                                <tr>
                                    <th width="40"><input class="form-check-input" type="checkbox" id="selectAllAssets"></th>
                                    <th style="cursor:pointer" data-sort="account_name">账户 <i class="fas fa-sort"></i></th>
                                    <th style="cursor:pointer" data-sort="name">名称/代码 <i class="fas fa-sort"></i></th>
                                    <th style="cursor:pointer" data-sort="category_1">一级分类 <i class="fas fa-sort"></i></th>
                                    <th style="cursor:pointer" data-sort="category_2">二级分类 <i class="fas fa-sort"></i></th>
                                    <th style="cursor:pointer" data-sort="quantity">持有数量 <i class="fas fa-sort"></i></th>
                                    <th style="cursor:pointer" data-sort="cost_price">成本价 <i class="fas fa-sort"></i></th>
                                    <th style="cursor:pointer" data-sort="current_price">现价 <i class="fas fa-sort"></i></th>
                                    <th style="cursor:pointer" data-sort="market_value">市值 <i class="fas fa-sort"></i></th>
                                    <th style="cursor:pointer" data-sort="pnl">盈亏 <i class="fas fa-sort"></i></th>
                                    <th>操作</th>
                                </tr>
                                <tr class="filter-row bg-light">
                                    <th></th>
                                    <th>
                                        <select class="form-select form-select-sm column-filter" data-col="account_name" id="filterAccount">
                                            <option value="">全部</option>
                                            <!-- JS populated -->
                                        </select>
                                    </th>
                                    <th><input type="text" class="form-control form-control-sm column-filter" data-col="name" placeholder="筛选..."></th>
                                    <th>
                                        <select class="form-select form-select-sm column-filter" data-col="category_1">
                                            <option value="">全部</option>
                                            <option value="权益类">权益类</option>
                                            <option value="固收类">固收类</option>
                                            <option value="商品类">商品类</option>
                                            <option value="现金类">现金类</option>
                                            <option value="其他">其他</option>
                                        </select>
                                    </th>
                                    <th><input type="text" class="form-control form-control-sm column-filter" data-col="category_2" placeholder="筛选..."></th>
                                    <th></th><th></th><th></th><th></th><th></th><th></th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 新增/编辑资产模态框 -->
<div class="modal fade" id="assetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">新增资产</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assetForm">
                    <input type="hidden" id="assetId">
                    <div class="mb-3">
                        <label class="form-label">账户名称</label>
                        <select class="form-select" id="accountName" required>
                            <!-- JS populated -->
                        </select>
                    </div>
                    <div class="mb-3" style="display:none;">
                        <label class="form-label">资产类型 (自动推断)</label>
                        <select class="form-select" id="assetType">
                            <option value="stock">股票</option>
                            <option value="etf">ETF</option>
                            <option value="fund">场外基金</option>
                            <option value="cash">现金</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">一级分类</label>
                            <select class="form-select" id="category1">
                                <option value="">请选择...</option>
                                <option value="权益类">权益类 (股票/股基)</option>
                                <option value="固收类">固收类 (债券/理财)</option>
                                <option value="商品类">商品类 (黄金/REITs)</option>
                                <option value="现金类">现金类 (货币基金/存款)</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">二级分类</label>
                            <input type="text" class="form-control" id="category2" list="cat2List">
                            <datalist id="cat2List">
                                <option value="宽基">
                                <option value="行业">
                                <option value="红利">
                                <option value="策略">
                                <option value="QDII">
                                <option value="债券">
                                <option value="货币">
                            </datalist>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">代码</label>
                            <input type="text" class="form-control" id="symbol" placeholder="投顾可不填，自动生成">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">名称</label>
                            <input type="text" class="form-control" id="name">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">持有数量</label>
                            <input type="number" step="any" class="form-control" id="quantity" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">成本价</label>
                            <input type="number" step="any" class="form-control" id="costPrice" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">现价</label>
                            <input type="number" step="any" class="form-control" id="currentPrice" placeholder="不填则自动获取">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveAsset()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 账户列表管理模态框 -->
<div class="modal fade" id="accountListModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">账户管理</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <button class="btn btn-success btn-sm" onclick="showAddAccountModal()">
                        <i class="fas fa-plus"></i> 新增账户
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm" id="accountTable">
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>类型</th>
                                <th>描述</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Account list -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 新增/编辑账户模态框 -->
<div class="modal fade" id="accountEditModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="accountModalTitle">新增账户</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="accountForm">
                    <input type="hidden" id="accountId">
                    <div class="mb-3">
                        <label class="form-label">账户名称</label>
                        <input type="text" class="form-control" id="accName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">账户类型</label>
                        <select class="form-select" id="accType">
                            <option value="券商">券商</option>
                            <option value="银行卡">银行卡</option>
                            <option value="支付宝">支付宝</option>
                            <option value="微信">微信</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">描述</label>
                        <input type="text" class="form-control" id="accDesc">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveAccount()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 截图导入模态框 -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">批量导入资产</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- 提示区域 -->
                <div class="alert alert-info py-2 small">
                    <i class="fas fa-info-circle"></i> 推荐使用 ChatGPT / Claude 将持仓截图转换为 Markdown 表格后粘贴。
                    <br><strong>表头需包含：</strong>代码、名称、数量、成本、现价、二级分类（可选）。
                </div>

                <!-- 输入区域 -->
                <div class="mb-3">
                    <label class="form-label fw-bold">1. 粘贴 Markdown 表格数据</label>
                    <textarea class="form-control font-monospace" id="mdInput" rows="6" placeholder="| 代码 | 名称 | 二级分类 | 数量 | 成本 | 现价 |
|---|---|---|---|---|---|
| 510300 | 沪深300ETF | 宽基 | 10000 | 3.50 | 3.65 |"></textarea>
                </div>
                
                <div class="d-grid gap-2 mb-4">
                    <button class="btn btn-secondary" type="button" onclick="parseMarkdownInput()">
                        <i class="fas fa-magic"></i> 解析表格数据
                    </button>
                </div>
                
                <!-- 批量设置 (可选) -->
                <div class="card mb-3 bg-light border-0">
                    <div class="card-body py-2">
                        <div class="row g-2 align-items-center">
                            <div class="col-auto"><small class="fw-bold">统一设置：</small></div>
                            <div class="col-md-4">
                                <select class="form-select form-select-sm" id="batchAccount">
                                    <!-- JS填充 -->
                                </select>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select form-select-sm" id="batchCategory1">
                                    <option value="权益类">权益类</option>
                                    <option value="固收类">固收类</option>
                                    <option value="商品类">商品类</option>
                                    <option value="现金类">现金类</option>
                                    <option value="其他">其他</option>
                                </select>
                            </div>
                            <div class="col-auto text-muted small">(仅对新解析的数据生效)</div>
                        </div>
                    </div>
                </div>

                <!-- 待导入列表 -->
                <div id="ocrResult" style="display: none;">
                    <label class="form-label fw-bold">2. 确认待导入列表</label>
                    <div class="table-responsive border rounded" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-striped mb-0" id="ocrTable">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width: 20%">名称</th>
                                    <th style="width: 15%">代码</th>
                                    <th style="width: 15%">二级分类</th>
                                    <th style="width: 15%">数量</th>
                                    <th style="width: 15%">成本</th>
                                    <th style="width: 15%">现价</th>
                                    <th style="width: 5%">操作</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="d-grid gap-2 mt-3">
                        <button class="btn btn-primary btn-lg" onclick="importAllAssets()">
                            <i class="fas fa-file-import"></i> 全部导入并保存
                        </button>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>
</div>

<!-- 账本导出模态框 -->
<div class="modal fade" id="ledgerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">账户资金快照 (抹零至百位)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="ledgerTable">
                        <thead>
                            <tr>
                                <th>账户名称</th>
                                <th class="text-end">同步金额</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot class="table-light fw-bold">
                            <tr>
                                <td>总计</td>
                                <td class="text-end" id="ledgerTotal"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let portfolioData = null;
let currentChartType = 'category_1';
let myChart = null;
let trendChart = null; // 新增趋势图实例
let allAccounts = [];
let currentSort = { field: 'update_time', asc: false }; // 默认按更新时间降序排列
let currentFilters = {}; // 存储过滤条件 { col: value }
let isSensitiveHidden = true; // 默认脱敏显示

function toggleSensitivity() {
    isSensitiveHidden = !isSensitiveHidden;
    const btn = $('#toggleSensitiveBtn');
    if (isSensitiveHidden) {
        btn.html('<i class="fas fa-eye-slash"></i>');
    } else {
        btn.html('<i class="fas fa-eye"></i>');
    }
    updateDashboard();
}

$(document).ready(function() {
    // 1. 初始化数据和图表
    refreshData();
    initChart();
    refreshAccountOptions(); // 关键：页面加载即加载账户列表
    
    // 2. 表头排序监听
    $('#assetTable thead th[data-sort]').on('click', function() {
        const field = $(this).data('sort');
        if (currentSort.field === field) {
            currentSort.asc = !currentSort.asc;
        } else {
            currentSort.field = field;
            currentSort.asc = true;
        }
        $('#assetTable thead th i').removeClass('fa-sort-up fa-sort-down').addClass('fa-sort');
        $(this).find('i').removeClass('fa-sort').addClass(currentSort.asc ? 'fa-sort-up' : 'fa-sort-down');
        sortAndRenderTable();
    });
    
    // 3. 列过滤监听
    $('.column-filter').on('input change', function() {
        const col = $(this).data('col');
        const val = $(this).val().toLowerCase().trim();
        currentFilters[col] = val;
        sortAndRenderTable();
    });
    
    // 4. 复选框逻辑
    $('#selectAllAssets').change(function() {
        $('.asset-select').prop('checked', $(this).is(':checked'));
        toggleBatchDeleteBtn();
    });

    $('#assetTable tbody').on('change', '.asset-select', function() {
        const allChecked = $('.asset-select:checked').length === $('.asset-select').length;
        $('#selectAllAssets').prop('checked', allChecked);
        toggleBatchDeleteBtn();
    });
    
    // 5. 模态框事件
    $('#accountListModal').on('show.bs.modal', function () {
        loadAccounts();
    });
    
    $('#assetModal').on('show.bs.modal', function() {
        refreshAccountOptions();
    });

    $('#importModal').on('show.bs.modal', function() {
        refreshAccountOptions();
    });
});

function initChart() {
    myChart = echarts.init(document.getElementById('portfolioChart'));
    trendChart = echarts.init(document.getElementById('trendChart')); // 初始化趋势图
    
    window.addEventListener('resize', function() {
        myChart.resize();
        trendChart.resize();
    });
}

// Duplicate refreshData removed

function updateTrendChart() {
    if (!portfolioData || !portfolioData.history) return;
    
    const dates = portfolioData.history.map(h => h.week); // 使用周号作为X轴
    const assets = portfolioData.history.map(h => h.total_assets);
    const costs = portfolioData.history.map(h => h.total_cost);
    
    const option = {
        tooltip: {
            trigger: 'axis',
            formatter: function(params) {
                let res = params[0].name + '<br/>';
                params.forEach(item => {
                    res += item.marker + item.seriesName + ': ' + formatCurrency(item.value) + '<br/>';
                });
                return res;
            }
        },
        legend: {
            data: ['总资产', '总本金'],
            bottom: 0
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '10%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            boundaryGap: false,
            data: dates
        },
        yAxis: {
            type: 'value',
            axisLabel: {
                formatter: function(value) {
                    return (value / 10000).toFixed(0) + '万';
                }
            }
        },
        series: [
            {
                name: '总资产',
                type: 'line',
                data: assets,
                smooth: true,
                areaStyle: { opacity: 0.1 },
                itemStyle: { color: '#0d6efd' }
            },
            {
                name: '总本金',
                type: 'line',
                data: costs,
                smooth: true,
                itemStyle: { color: '#0dcaf0' },
                lineStyle: { type: 'dashed' }
            }
        ]
    };
    
    trendChart.setOption(option);
}

// Event listeners moved to ready block

function loadAccounts() {
    $.get('/api/portfolio/accounts', function(res) {
        allAccounts = res;
        const tbody = $('#accountTable tbody');
        tbody.empty();
        
        res.forEach(acc => {
            const row = `
                <tr>
                    <td>${acc.name}</td>
                    <td>${acc.type || '-'}</td>
                    <td>${acc.description || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick='editAccount(${JSON.stringify(acc)})'>
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteAccount(${acc.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });
    });
}

function showAddAccountModal() {
    $('#accountModalTitle').text('新增账户');
    $('#accountId').val('');
    document.getElementById('accountForm').reset();
    $('#accountListModal').modal('hide');
    new bootstrap.Modal(document.getElementById('accountEditModal')).show();
}

function editAccount(acc) {
    $('#accountModalTitle').text('编辑账户');
    $('#accountId').val(acc.id);
    $('#accName').val(acc.name);
    $('#accType').val(acc.type);
    $('#accDesc').val(acc.description);
    
    $('#accountListModal').modal('hide');
    new bootstrap.Modal(document.getElementById('accountEditModal')).show();
}

function saveAccount() {
    const data = {
        id: $('#accountId').val() || null,
        name: $('#accName').val(),
        type: $('#accType').val(),
        description: $('#accDesc').val()
    };
    
    $.ajax({
        url: '/api/portfolio/account',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(res) {
            $('#accountEditModal').modal('hide');
            // Re-open list modal
            new bootstrap.Modal(document.getElementById('accountListModal')).show();
            loadAccounts(); // Reload list
        },
        error: function(err) {
            alert('保存失败: ' + err.responseJSON.message);
        }
    });
}

function deleteAccount(id) {
    if (confirm('确定要删除这个账户吗？')) {
        $.ajax({
            url: `/api/portfolio/account/${id}`,
            type: 'DELETE',
            success: function() {
                loadAccounts();
            },
            error: function() {
                alert('删除失败');
            }
        });
    }
}

function showLedgerModal() {
    if (!portfolioData || !portfolioData.summary) return alert('请先加载数据');
    
    const accounts = portfolioData.summary.by_account;
    const tbody = $('#ledgerTable tbody');
    tbody.empty();
    
    let totalSynced = 0;
    
    // 按金额降序排列
    const sortedAccounts = [...accounts].sort((a, b) => b.value - a.value);
    
    sortedAccounts.forEach(acc => {
        // 抹零逻辑：向下取整到 100
        const rawValue = acc.value;
        const syncedValue = Math.floor(rawValue / 100) * 100;
        
        totalSynced += syncedValue;
        
        // 格式化金额 (无小数位)
        const displayValue = syncedValue.toLocaleString('zh-CN', { maximumFractionDigits: 0 });
        
        tbody.append(`
            <tr>
                <td>${acc.name}</td>
                <td class="text-end font-monospace fs-5">${displayValue}</td>
            </tr>
        `);
    });
    
    $('#ledgerTotal').text(totalSynced.toLocaleString('zh-CN', { maximumFractionDigits: 0 }));
    
    new bootstrap.Modal(document.getElementById('ledgerModal')).show();
}

function determineAssetType(cat1, symbol) {
    if (cat1 === '现金类') return 'cash';
    if (cat1 === '权益类' || cat1 === '固收类' || cat1 === '商品类') {
        // Simple guess based on symbol
        if (symbol.startsWith('1') || symbol.startsWith('5')) return 'etf';
        if (symbol.length === 6 && (symbol.startsWith('6') || symbol.startsWith('0') || symbol.startsWith('3') || symbol.startsWith('8') || symbol.startsWith('4'))) return 'stock';
        return 'fund'; // Default to fund/other
    }
    return 'other';
}

function refreshAccountOptions() {
    // Load accounts for select
    $.get('/api/portfolio/accounts', function(res) {
        console.log("Accounts loaded:", res); 
        allAccounts = res;
        
        // Populate Filter Select
        const filterSelect = $('#filterAccount');
        console.log("Filter select found:", filterSelect.length); // Debug
        
        const filterVal = filterSelect.val();
        filterSelect.empty();
        filterSelect.append('<option value="">全部</option>'); 
        
        if (res && res.length > 0) {
            res.forEach(acc => {
                filterSelect.append(`<option value="${acc.name}">${acc.name}</option>`);
            });
        }
        
        // Populate other selects (Asset Modal, Batch Import)
        // ... (keep logic for assetName and batchAccount)
        const assetSelect = $('#accountName');
        const batchSelect = $('#batchAccount');
        // ... (rest of logic)
        
        const currentVal = assetSelect.val();
        const batchVal = batchSelect.val();
        
        assetSelect.empty();
        batchSelect.empty();
        
        if (!res || res.length === 0) {
             assetSelect.append('<option value="">无账户，请先创建</option>');
             batchSelect.append('<option value="">无账户，请先创建</option>');
        } else {
             res.forEach(acc => {
                 assetSelect.append(`<option value="${acc.name}">${acc.name}</option>`);
                 batchSelect.append(`<option value="${acc.name}">${acc.name} (${acc.type || '-'})</option>`);
             });
        }

        if (currentVal) assetSelect.val(currentVal);
        if (batchVal) batchSelect.val(batchVal);
        if (filterVal) filterSelect.val(filterVal);
    });
}

// Duplicate initChart removed

function refreshPrices() {
    const btn = $('#btnRefreshPrices');
    const originalContent = btn.html();
    btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> 更新中...');
    
    $.ajax({
        url: '/api/portfolio/refresh_prices',
        type: 'POST',
        success: function(res) {
            alert(`行情更新完成！\n成功更新了 ${res.updated_count} 个资产的价格。`);
            refreshData(); // Reload data from DB
        },
        error: function(err) {
            alert('更新失败: ' + (err.responseJSON ? err.responseJSON.message : err.statusText));
        },
        complete: function() {
            btn.prop('disabled', false).html(originalContent);
        }
    });
}

function refreshData() {
    $.get('/api/portfolio/data', function(res) {
        portfolioData = res;
        updateDashboard();
        sortAndRenderTable();
        updateChart();
        if (typeof updateTrendChart === 'function') updateTrendChart();
        if (typeof updateTopMovers === 'function') updateTopMovers();
        updateDatalists();
    }).fail(function(err) {
        console.error("Load data failed", err);
        $('#totalAssets, #totalPnL, #totalCost').text('加载失败');
    });
}

function updateTopMovers() {
    if (!portfolioData || !portfolioData.assets) return;
    
    // Sort by PnL Percent (Exclude infinity)
    const sorted = [...portfolioData.assets]
        .filter(a => a.pnl_percent < 999999)
        .sort((a, b) => b.pnl_percent - a.pnl_percent);
    
    const top3 = sorted.slice(0, 3);
    const bottom3 = sorted.slice(-3).reverse();
    
    const list = $('#topMoversList');
    list.empty();
    
    const createItem = (asset, type) => `
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
                <span class="badge ${type === 'win' ? 'bg-danger' : 'bg-success'} rounded-pill me-2">
                    ${type === 'win' ? 'Top' : 'Low'}
                </span>
                <small>${asset.name || asset.symbol}</small>
            </div>
            <span class="${type === 'win' ? 'text-danger' : 'text-success'} fw-bold">
                ${asset.pnl_percent >= 999999 ? '∞' : asset.pnl_percent.toFixed(2) + '%'}
            </span>
        </li>
    `;
    
    top3.forEach(a => list.append(createItem(a, 'win')));
    bottom3.forEach(a => list.append(createItem(a, 'loss')));
}

function sortAndRenderTable() {
    if (!portfolioData || !portfolioData.assets) return;
    
    let data = portfolioData.assets.filter(item => {
        for (const [col, filterVal] of Object.entries(currentFilters)) {
            if (!filterVal) continue;
            
            if (col === 'name') {
                const name = (item.name || '').toLowerCase();
                const symbol = (item.symbol || '').toLowerCase();
                if (!name.includes(filterVal) && !symbol.includes(filterVal)) return false;
            } else {
                const val = String(item[col] || '').toLowerCase();
                if (!val.includes(filterVal)) return false;
            }
        }
        return true;
    });
    
    const field = currentSort.field;
    const isAsc = currentSort.asc;
    
    data.sort((a, b) => {
        let valA = a[field];
        let valB = b[field];
        
        if (valA === null || valA === undefined) valA = '';
        if (valB === null || valB === undefined) valB = '';
        
        if (typeof valA === 'string') {
            return isAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
        }
        return isAsc ? valA - valB : valB - valA;
    });
    
    updateTable(data);
}

function updateDashboard() {
    if (!portfolioData) return;
    const sum = portfolioData.summary;
    
    if (isSensitiveHidden) {
        $('#totalAssets').text('******');
        $('#totalCost').text('******');
        $('#totalPnL').text('******');
    } else {
        $('#totalAssets').text(formatCurrency(sum.total_assets));
        $('#totalCost').text(formatCurrency(sum.total_cost));
        $('#totalPnL').text(formatCurrency(sum.total_pnl));
    }
    
    // Set color for PnL
    const pnlClass = sum.total_pnl >= 0 ? 'bg-danger' : 'bg-success';
    $('#totalPnL').parent().parent().removeClass('bg-success bg-danger').addClass(pnlClass);
}

function updateTable(data) {
    const tbody = $('#assetTable tbody');
    tbody.empty();
    
    // Reset selection state
    $('#selectAllAssets').prop('checked', false);
    toggleBatchDeleteBtn();
    
    const assets = data || (portfolioData ? portfolioData.assets : []);
    if (!assets || assets.length === 0) {
        tbody.html('<tr><td colspan="11" class="text-center text-muted">无数据</td></tr>');
        return;
    }
    
    assets.forEach(asset => {
        const pnlClass = asset.pnl >= 0 ? 'text-danger' : 'text-success';
        const row = `
            <tr>
                <td><input class="form-check-input asset-select" type="checkbox" value="${asset.id}"></td>
                <td>${asset.account_name}</td>
                <td>
                    <div>${asset.name || '-'}</div>
                    <small class="text-muted">${asset.symbol}</small>
                </td>
                <td>${asset.category_1 || '-'}</td>
                <td>${asset.category_2 || '-'}</td>
                <td>${asset.quantity}</td>
                <td>${formatNumber(asset.cost_price)}</td>
                <td>${formatNumber(asset.current_price)}</td>
                <td>${formatNumber(asset.market_value)}</td>
                <td class="${pnlClass}">
                    <div>${formatNumber(asset.pnl)}</div>
                    <small>(${asset.pnl_percent >= 999999 ? '∞' : asset.pnl_percent.toFixed(2) + '%'})</small>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick='editAsset(${JSON.stringify(asset)})'>
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.append(row);
    });
}

function updateChart() {
    if (!portfolioData) return;
    
    let data = [];
    let title = '';
    
    switch(currentChartType) {
        case 'category_1':
            data = portfolioData.summary.by_category_1;
            title = '按一级分类';
            break;
        case 'category_2':
            data = portfolioData.summary.by_category_2;
            title = '按二级分类';
            break;
        case 'account':
            data = portfolioData.summary.by_account;
            title = '按账户分布';
            break;
        case 'asset_type':
            data = portfolioData.summary.by_asset_type;
            title = '按资产形态';
            break;
    }
    
    const option = {
        title: {
            text: title,
            left: 'center'
        },
        tooltip: {
            trigger: 'item',
            formatter: function(params) {
                return `${params.name}<br/>市值: <b>¥${params.value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</b> (${params.percent}%)`;
            }
        },
        legend: {
            orient: 'vertical',
            left: 'left'
        },
        series: [
            {
                name: '资产分布',
                type: 'pie',
                radius: ['40%', '70%'],
                avoidLabelOverlap: false,
                itemStyle: {
                    borderRadius: 10,
                    borderColor: '#fff',
                    borderWidth: 2
                },
                label: {
                    show: false,
                    position: 'center'
                },
                emphasis: {
                    label: {
                        show: true,
                        fontSize: 20,
                        fontWeight: 'bold',
                        formatter: function(params) {
                            return `${params.name}\n¥${params.value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                        }
                    }
                },
                labelLine: {
                    show: false
                },
                data: data
            }
        ]
    };
    
    myChart.setOption(option);
}

function switchChart(type) {
    currentChartType = type;
    // Update button states
    $('.btn-group .btn').removeClass('active');
    $(`.btn-group .btn[onclick="switchChart('${type}')"]`).addClass('active');
    updateChart();
}

function saveAsset() {
    // Basic Validation
    const accountName = $('#accountName').val();
    const symbol = $('#symbol').val().trim();
    const quantity = $('#quantity').val();
    const costPrice = $('#costPrice').val();
    
    if (!accountName) return alert('请选择账户');
    // 如果是投顾 (自动生成代码)，symbol 可以为空，但 name 必须有
    // 但是 saveAsset 里有自动生成逻辑。
    // 我们检查：如果有 symbol 则 ok，如果没有 symbol 则必须有 name
    const name = $('#name').val().trim();
    
    if (!symbol && !name) return alert('请填写代码或名称');
    if (!quantity) return alert('请填写持有数量');
    if (!costPrice) return alert('请填写成本价');

    const cat1 = $('#category1').val();
    
    // Auto-generate symbol for investment advisors/others if missing
    if (!symbol && name) {
        const hash = name.split('').reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);
        symbol = 'TG_' + Math.abs(hash).toString(16).toUpperCase();
    }
    
    // Auto-determine asset type ONLY if value is missing (New mode)
    // In Edit mode, val() is populated by editAsset, so we keep it.
    let aType = $('#assetType').val();
    if (!aType) {
        aType = determineAssetType(cat1, symbol);
    }

    const data = {
        id: $('#assetId').val() || null,
        account_name: $('#accountName').val(),
        asset_type: aType,
        category_1: cat1,
        category_2: $('#category2').val(),
        symbol: symbol,
        name: name,
        quantity: parseFloat($('#quantity').val()),
        cost_price: parseFloat($('#costPrice').val()),
        last_price: parseFloat($('#currentPrice').val()) || 0
    };
    
    $.ajax({
        url: '/api/portfolio/asset',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(res) {
            $('#assetModal').modal('hide');
            refreshData();
            document.getElementById('assetForm').reset();
            $('#assetId').val(''); // Clear ID for next add
        },
        error: function(err) {
            alert('保存失败: ' + err.responseJSON.message);
        }
    });
}

function deleteAsset(id) {
    // 已废弃，保留作为单行删除的逻辑参考
    if (confirm('确定要删除这条资产记录吗？')) {
        $.ajax({
            url: `/api/portfolio/asset/${id}`,
            type: 'DELETE',
            success: function() {
                refreshData();
            },
            error: function() {
                alert('删除失败');
            }
        });
    }
}

function toggleBatchDeleteBtn() {
    const count = $('.asset-select:checked').length;
    const btn = $('#btnBatchDelete');
    if (count > 0) {
        btn.show().html(`<i class="fas fa-trash"></i> 批量删除 (${count})`);
    } else {
        btn.hide();
    }
}

function batchDeleteAssets() {
    const ids = [];
    $('.asset-select:checked').each(function() {
        ids.push($(this).val());
    });
    
    if (ids.length === 0) return;
    
    if (!confirm(`确定要删除选中的 ${ids.length} 条资产记录吗？此操作不可恢复。`)) return;
    
    const btn = $('#btnBatchDelete');
    btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> 删除中...');
    
    let completed = 0;
    let failed = 0;
    
    // 使用 Promise.allSettled 或简单计数
    const promises = ids.map(id => {
        return new Promise(resolve => {
            $.ajax({
                url: `/api/portfolio/asset/${id}`,
                type: 'DELETE',
                success: () => resolve(true),
                error: () => {
                    failed++;
                    resolve(false);
                }
            });
        });
    });
    
    Promise.all(promises).then(() => {
        btn.prop('disabled', false);
        if (failed > 0) {
            alert(`删除完成。成功: ${ids.length - failed}, 失败: ${failed}`);
        }
        refreshData();
    });
}

function editAsset(asset) {
    $('#modalTitle').text('编辑资产');
    $('#assetId').val(asset.id);
    $('#accountName').val(asset.account_name);
    $('#assetType').val(asset.asset_type);
    $('#category1').val(asset.category_1);
    $('#category2').val(asset.category_2);
    $('#symbol').val(asset.symbol);
    $('#name').val(asset.name);
    $('#quantity').val(asset.quantity);
    $('#costPrice').val(asset.cost_price);
    $('#currentPrice').val(asset.last_price || ''); 
    
    const modal = new bootstrap.Modal(document.getElementById('assetModal'));
    modal.show();
}

// Helper: Populate datalists for autocomplete
function updateDatalists() {
    if (!portfolioData) return;
    
    // Default options based on new classification
    const defaultCat2 = [
        // 权益类
        '宽基', '行业', '红利', '策略', 'QDII', '个股', '科技', '消费', '医药', '金融', '新能源',
        // 固收类
        '利率债', '信用债', '可转债', '理财',
        // 商品/另类
        '黄金', '原油', 'REITs', '豆粕',
        // 现金
        '货币', '存款'
    ];
    const cat2s = new Set(defaultCat2);
    
    portfolioData.assets.forEach(a => {
        if (a.category_2) cat2s.add(a.category_2);
    });
    
    populateDatalist('cat2List', cat2s);
}

function populateDatalist(id, set) {
    const list = $(`#${id}`);
    list.empty();
    set.forEach(val => {
        list.append(`<option value="${val}">`);
    });
}

// Helper: Formatting
function formatCurrency(num) {
    return new Intl.NumberFormat('zh-CN', { style: 'currency', currency: 'CNY' }).format(num);
}

function formatNumber(num) {
    return new Intl.NumberFormat('zh-CN', { maximumFractionDigits: 2 }).format(num);
}

// 截图上传逻辑
let ocrCurrentStep = 'name'; // name -> symbol -> qty -> cost

// uploadScreenshot removed

// renderOcrItems removed

function resetOcrForm() {
    // Only used to clear inputs, though inputs are now driven by markdown parsing
    // But we might need it if we keep manual add? No, manual add is removed from UI.
    // So this function is actually unused, but parseMarkdown calls it?
    // Wait, parseMarkdownInput calls appendAssetRow, which doesn't need reset.
    // Let's check parseMarkdownInput... it doesn't call resetOcrForm.
    // So we can remove all these.
}

// Removed: setOcrStep, focus listener, onChipClick, addOcrAssetToTable

function appendAssetRow(asset) {
    const index = Date.now() + Math.floor(Math.random() * 1000); // Ensure unique
    const row = `
        <tr id="ocr-row-${index}">
            <td><input type="text" class="form-control form-control-sm asset-name" value="${asset.name || ''}"></td>
            <td><input type="text" class="form-control form-control-sm asset-symbol" value="${asset.symbol || ''}"></td>
            <td><input type="text" class="form-control form-control-sm asset-cat2" value="${asset.cat2 || ''}" placeholder="二级分类" list="cat2List"></td>
            <td><input type="number" class="form-control form-control-sm asset-qty" value="${asset.qty || ''}"></td>
            <td><input type="number" class="form-control form-control-sm asset-cost" value="${asset.cost || ''}"></td>
            <td><input type="number" class="form-control form-control-sm asset-last-price" value="${asset.lastPrice || ''}"></td>
            <td>
                <button class="btn btn-sm btn-outline-danger border-0" onclick="$(this).closest('tr').remove()" title="删除">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        </tr>
    `;
    $('#ocrTable tbody').append(row);
}

function parseMarkdownInput() {
    const text = $('#mdInput').val().trim();
    if (!text) return alert('请粘贴 Markdown 表格内容');
    
    const lines = text.split('\n').filter(line => line.trim() && line.includes('|'));
    if (lines.length < 2) return alert('未识别到有效的 Markdown 表格');
    
    // 1. Parse Header
    const headerLine = lines[0];
    const headers = headerLine.split('|').map(h => h.trim()).filter(h => h);
    
    // Mapping: header text -> field key
    const mapping = {};
    headers.forEach((h, index) => {
        if (h.includes('代码') || h.includes('Symbol')) mapping[index] = 'symbol';
        else if (h.includes('名称') || h.includes('Name')) mapping[index] = 'name';
        else if (h.includes('数量') || h.includes('Qty') || h.includes('持仓')) mapping[index] = 'qty';
        else if (h.includes('成本') || h.includes('Cost')) mapping[index] = 'cost';
        else if (h.includes('现价') || h.includes('Price') || h.includes('最新')) mapping[index] = 'lastPrice';
        else if (h.includes('二级') || h.includes('分类') || h.includes('Type')) mapping[index] = 'cat2';
    });
    
    if (!Object.values(mapping).includes('symbol')) {
        alert('警告：未识别到“代码”列，请检查表头是否包含“代码”字样');
    }
    
    // 2. Parse Data Rows
    let addedCount = 0;
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (line.includes('---')) continue; // Skip separator line
        
        const cols = line.split('|').map(c => c.trim()).filter(c => c !== ''); // simple split, might need regex for escaped pipes
        // Note: .split('|') might produce empty strings at start/end if line starts/ends with |
        // Better way: remove leading/trailing |, then split
        
        const cleanLine = line.replace(/^\||\|$/g, '');
        const values = cleanLine.split('|').map(c => c.trim());
        
        if (values.length < headers.length) continue; // Skip incomplete lines
        
        const asset = {};
        let hasData = false;
        
        Object.keys(mapping).forEach(colIndex => {
            if (values[colIndex]) {
                // Remove currency symbols, commas for numeric fields
                let val = values[colIndex];
                const field = mapping[colIndex];
                
                if (['qty', 'cost', 'lastPrice'].includes(field)) {
                    val = val.replace(/[¥$,]/g, '');
                }
                
                asset[field] = val;
                hasData = true;
            }
        });
        
        if (hasData) {
            // 如果没有代码但有名称，生成虚拟代码 (投顾/理财)
            if (!asset.symbol && asset.name) {
                // Generate simple hash or timestamp
                const hash = asset.name.split('').reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);
                asset.symbol = 'TG_' + Math.abs(hash).toString(16).toUpperCase();
            }
            
            if (asset.symbol) {
                appendAssetRow(asset);
                addedCount++;
            }
        }
    }
    
    if (addedCount > 0) {
        alert(`🎉 成功解析并添加了 ${addedCount} 条资产记录！\n请在下方列表确认无误后，点击“全部导入”按钮保存。`);
        $('#mdInput').val(''); // Clear input
        $('#ocrResult').show(); // Ensure table is visible
        $('#markdownArea').collapse('hide');
    } else {
        alert('未解析到有效数据，请检查 Markdown 格式');
    }
}

function importAllAssets() {
    const rows = $('#ocrTable tbody tr');
    if (rows.length === 0) {
        return alert('列表为空，请先添加资产');
    }
    
    // 获取公共字段
    const accountName = $('#batchAccount').val(); // From select
    const cat1 = $('#batchCategory1').val();
    
    if (!accountName) {
        return alert('请先设置【归属账户】');
    }
    
    const assets = [];
    rows.each(function() {
        const row = $(this);
        const symbol = row.find('.asset-symbol').val().trim();
        const cat2 = row.find('.asset-cat2').val().trim();
        
        assets.push({
            account_name: accountName,
            category_1: cat1,
            category_2: cat2, // From row
            symbol: symbol,
            name: row.find('.asset-name').val().trim(),
            quantity: parseFloat(row.find('.asset-qty').val()) || 0,
            cost_price: parseFloat(row.find('.asset-cost').val()) || 0,
            last_price: parseFloat(row.find('.asset-last-price').val()) || 0,
            asset_type: determineAssetType(cat1, symbol)
        });
    });
    
    if (!confirm(`确认导入这 ${assets.length} 条资产到账户 [${accountName}] 吗？`)) return;
    
    const btn = $('button[onclick="importAllAssets()"]');
    const originalText = btn.html();
    btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> 正在导入...');
    
    // 串行提交（因为后端目前只支持单条添加）
    let successCount = 0;
    let failCount = 0;
    
    // 使用 Promise 链或 async/await
    // 这里简单用 reduce 来串行执行 Promise
    assets.reduce((promise, asset) => {
        return promise.then(() => {
            return new Promise((resolve) => {
                $.ajax({
                    url: '/api/portfolio/asset',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(asset),
                    success: function() {
                        successCount++;
                        resolve();
                    },
                    error: function() {
                        failCount++;
                        resolve(); // 继续下一个
                    }
                });
            });
        });
    }, Promise.resolve()).then(() => {
        btn.prop('disabled', false).html(originalText);
        alert(`导入完成！成功: ${successCount}, 失败: ${failCount}`);
        
        if (successCount > 0) {
            $('#importModal').modal('hide');
            refreshData(); // 刷新主列表
            
            // 清空表格
            $('#ocrTable tbody').empty();
        }
    });
}

// Reset form when modal closes
$('#assetModal').on('hidden.bs.modal', function () {
    $('#modalTitle').text('新增资产');
    $('#assetId').val('');
    $('#assetType').val(''); // Clear hidden field
    document.getElementById('assetForm').reset();
});
</script>
{% endblock %}
