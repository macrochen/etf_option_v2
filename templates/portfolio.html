{% extends "base.html" %}

{% block title %}资产全景仪表盘{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <h2>资产全景仪表盘</h2>
            <div>
                <button class="btn btn-info me-2 text-white" data-bs-toggle="modal" data-bs-target="#accountListModal">
                    <i class="fas fa-wallet"></i> 账户管理
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#assetModal">
                    <i class="fas fa-plus"></i> 新增资产
                </button>
                <button class="btn btn-secondary ms-2" onclick="refreshData()">
                    <i class="fas fa-sync"></i> 刷新数据
                </button>
            </div>
        </div>
    </div>

    <!-- 核心指标卡片 -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-white bg-primary mb-3">
                <div class="card-body">
                    <h5 class="card-title">总资产</h5>
                    <h3 class="card-text" id="totalAssets">Loading...</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-success mb-3">
                <div class="card-body">
                    <h5 class="card-title">总盈亏</h5>
                    <h3 class="card-text" id="totalPnL">Loading...</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-info mb-3">
                <div class="card-body">
                    <h5 class="card-title">总本金</h5>
                    <h3 class="card-text" id="totalCost">Loading...</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- 图表区域 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>资产分布</span>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary active" onclick="switchChart('category_1')">一级分类</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="switchChart('category_2')">二级分类</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="switchChart('account')">账户</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="switchChart('asset_type')">资产形态</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="portfolioChart" style="height: 400px; width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 资产明细表 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    资产明细
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="assetTable">
                            <thead>
                                <tr>
                                    <th>账户</th>
                                    <th>名称/代码</th>
                                    <th>一级分类</th>
                                    <th>二级分类</th>
                                    <th>持有数量</th>
                                    <th>成本价</th>
                                    <th>现价</th>
                                    <th>市值</th>
                                    <th>盈亏</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 新增/编辑资产模态框 -->
<div class="modal fade" id="assetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">新增资产</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assetForm">
                    <input type="hidden" id="assetId">
                    <div class="mb-3">
                        <label class="form-label">账户名称</label>
                        <input type="text" class="form-control" id="accountName" required list="accountList">
                        <datalist id="accountList"></datalist>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">资产类型</label>
                        <select class="form-select" id="assetType" required>
                            <option value="stock">股票</option>
                            <option value="etf">ETF</option>
                            <option value="fund">场外基金</option>
                            <option value="cash">现金</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">一级分类</label>
                            <select class="form-select" id="category1">
                                <option value="">请选择...</option>
                                <option value="股票">股票</option>
                                <option value="基金">基金</option>
                                <option value="债券">债券</option>
                                <option value="现金">现金</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">二级分类</label>
                            <input type="text" class="form-control" id="category2" list="cat2List">
                            <datalist id="cat2List"></datalist>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">代码</label>
                            <input type="text" class="form-control" id="symbol" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">名称</label>
                            <input type="text" class="form-control" id="name">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">持有数量</label>
                            <input type="number" step="any" class="form-control" id="quantity" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">成本价</label>
                            <input type="number" step="any" class="form-control" id="costPrice" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveAsset()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 账户列表管理模态框 -->
<div class="modal fade" id="accountListModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">账户管理</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <button class="btn btn-success btn-sm" onclick="showAddAccountModal()">
                        <i class="fas fa-plus"></i> 新增账户
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm" id="accountTable">
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>类型</th>
                                <th>描述</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Account list -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 新增/编辑账户模态框 -->
<div class="modal fade" id="accountEditModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="accountModalTitle">新增账户</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="accountForm">
                    <input type="hidden" id="accountId">
                    <div class="mb-3">
                        <label class="form-label">账户名称</label>
                        <input type="text" class="form-control" id="accName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">账户类型</label>
                        <select class="form-select" id="accType">
                            <option value="券商">券商</option>
                            <option value="银行卡">银行卡</option>
                            <option value="支付宝">支付宝</option>
                            <option value="微信">微信</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">描述</label>
                        <input type="text" class="form-control" id="accDesc">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveAccount()">保存</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let portfolioData = null;
let currentChartType = 'category_1';
let myChart = null;
let allAccounts = [];

$(document).ready(function() {
    refreshData();
    initChart();
    
    // Load accounts when modal is opened
    $('#accountListModal').on('show.bs.modal', function () {
        loadAccounts();
    });
    
    // Refresh account datalist when asset modal is opened
    $('#assetModal').on('show.bs.modal', function() {
        refreshAccountOptions();
    });
});

function loadAccounts() {
    $.get('/api/portfolio/accounts', function(res) {
        allAccounts = res;
        const tbody = $('#accountTable tbody');
        tbody.empty();
        
        res.forEach(acc => {
            const row = `
                <tr>
                    <td>${acc.name}</td>
                    <td>${acc.type || '-'}</td>
                    <td>${acc.description || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick='editAccount(${JSON.stringify(acc)})'>
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteAccount(${acc.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });
    });
}

function showAddAccountModal() {
    $('#accountModalTitle').text('新增账户');
    $('#accountId').val('');
    document.getElementById('accountForm').reset();
    $('#accountListModal').modal('hide');
    new bootstrap.Modal(document.getElementById('accountEditModal')).show();
}

function editAccount(acc) {
    $('#accountModalTitle').text('编辑账户');
    $('#accountId').val(acc.id);
    $('#accName').val(acc.name);
    $('#accType').val(acc.type);
    $('#accDesc').val(acc.description);
    
    $('#accountListModal').modal('hide');
    new bootstrap.Modal(document.getElementById('accountEditModal')).show();
}

function saveAccount() {
    const data = {
        id: $('#accountId').val() || null,
        name: $('#accName').val(),
        type: $('#accType').val(),
        description: $('#accDesc').val()
    };
    
    $.ajax({
        url: '/api/portfolio/account',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(res) {
            $('#accountEditModal').modal('hide');
            // Re-open list modal
            new bootstrap.Modal(document.getElementById('accountListModal')).show();
            loadAccounts(); // Reload list
        },
        error: function(err) {
            alert('保存失败: ' + err.responseJSON.message);
        }
    });
}

function deleteAccount(id) {
    if (confirm('确定要删除这个账户吗？')) {
        $.ajax({
            url: `/api/portfolio/account/${id}`,
            type: 'DELETE',
            success: function() {
                loadAccounts();
            },
            error: function() {
                alert('删除失败');
            }
        });
    }
}

function refreshAccountOptions() {
    // Load accounts for datalist
    $.get('/api/portfolio/accounts', function(res) {
        allAccounts = res;
        const datalist = $('#accountList');
        datalist.empty();
        res.forEach(acc => {
            datalist.append(`<option value="${acc.name}">`);
        });
    });
}

function initChart() {
    myChart = echarts.init(document.getElementById('portfolioChart'));
    window.addEventListener('resize', function() {
        myChart.resize();
    });
}

function refreshData() {
    $.get('/api/portfolio/data', function(res) {
        portfolioData = res;
        updateDashboard();
        updateTable();
        updateChart();
        updateDatalists();
    });
}

function updateDashboard() {
    const sum = portfolioData.summary;
    $('#totalAssets').text(formatCurrency(sum.total_assets));
    $('#totalCost').text(formatCurrency(sum.total_cost));
    $('#totalPnL').text(formatCurrency(sum.total_pnl));
    
    // Set color for PnL
    const pnlClass = sum.total_pnl >= 0 ? 'bg-success' : 'bg-danger';
    $('#totalPnL').parent().parent().removeClass('bg-success bg-danger').addClass(pnlClass);
}

function updateTable() {
    const tbody = $('#assetTable tbody');
    tbody.empty();
    
    portfolioData.assets.forEach(asset => {
        const pnlClass = asset.pnl >= 0 ? 'text-success' : 'text-danger';
        const row = `
            <tr>
                <td>${asset.account_name}</td>
                <td>
                    <div>${asset.name || '-'}</div>
                    <small class="text-muted">${asset.symbol}</small>
                </td>
                <td>${asset.category_1 || '-'}</td>
                <td>${asset.category_2 || '-'}</td>
                <td>${asset.quantity}</td>
                <td>${formatNumber(asset.cost_price)}</td>
                <td>${formatNumber(asset.current_price)}</td>
                <td>${formatNumber(asset.market_value)}</td>
                <td class="${pnlClass}">
                    <div>${formatNumber(asset.pnl)}</div>
                    <small>(${asset.pnl_percent.toFixed(2)}%)</small>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick='editAsset(${JSON.stringify(asset)})'>
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteAsset(${asset.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.append(row);
    });
}

function updateChart() {
    if (!portfolioData) return;
    
    let data = [];
    let title = '';
    
    switch(currentChartType) {
        case 'category_1':
            data = portfolioData.summary.by_category_1;
            title = '按一级分类';
            break;
        case 'category_2':
            data = portfolioData.summary.by_category_2;
            title = '按二级分类';
            break;
        case 'account':
            data = portfolioData.summary.by_account;
            title = '按账户分布';
            break;
        case 'asset_type':
            data = portfolioData.summary.by_asset_type;
            title = '按资产形态';
            break;
    }
    
    const option = {
        title: {
            text: title,
            left: 'center'
        },
        tooltip: {
            trigger: 'item',
            formatter: '{b}: {c} ({d}%)'
        },
        legend: {
            orient: 'vertical',
            left: 'left'
        },
        series: [
            {
                name: '资产分布',
                type: 'pie',
                radius: ['40%', '70%'],
                avoidLabelOverlap: false,
                itemStyle: {
                    borderRadius: 10,
                    borderColor: '#fff',
                    borderWidth: 2
                },
                label: {
                    show: false,
                    position: 'center'
                },
                emphasis: {
                    label: {
                        show: true,
                        fontSize: 20,
                        fontWeight: 'bold'
                    }
                },
                labelLine: {
                    show: false
                },
                data: data
            }
        ]
    };
    
    myChart.setOption(option);
}

function switchChart(type) {
    currentChartType = type;
    // Update button states
    $('.btn-group .btn').removeClass('active');
    $(`.btn-group .btn[onclick="switchChart('${type}')"]`).addClass('active');
    updateChart();
}

function saveAsset() {
    const data = {
        id: $('#assetId').val() || null,
        account_name: $('#accountName').val(),
        asset_type: $('#assetType').val(),
        category_1: $('#category1').val(),
        category_2: $('#category2').val(),
        symbol: $('#symbol').val(),
        name: $('#name').val(),
        quantity: parseFloat($('#quantity').val()),
        cost_price: parseFloat($('#costPrice').val())
    };
    
    $.ajax({
        url: '/api/portfolio/asset',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(res) {
            $('#assetModal').modal('hide');
            refreshData();
            document.getElementById('assetForm').reset();
            $('#assetId').val(''); // Clear ID for next add
        },
        error: function(err) {
            alert('保存失败: ' + err.responseJSON.message);
        }
    });
}

function deleteAsset(id) {
    if (confirm('确定要删除这条资产记录吗？')) {
        $.ajax({
            url: `/api/portfolio/asset/${id}`,
            type: 'DELETE',
            success: function() {
                refreshData();
            },
            error: function() {
                alert('删除失败');
            }
        });
    }
}

function editAsset(asset) {
    $('#modalTitle').text('编辑资产');
    $('#assetId').val(asset.id);
    $('#accountName').val(asset.account_name);
    $('#assetType').val(asset.asset_type);
    $('#category1').val(asset.category_1);
    $('#category2').val(asset.category_2);
    $('#symbol').val(asset.symbol);
    $('#name').val(asset.name);
    $('#quantity').val(asset.quantity);
    $('#costPrice').val(asset.cost_price);
    
    const modal = new bootstrap.Modal(document.getElementById('assetModal'));
    modal.show();
}

// Helper: Populate datalists for autocomplete
function updateDatalists() {
    if (!portfolioData) return;
    
    // Only update category 2 list from existing assets
    const cat2s = new Set();
    
    portfolioData.assets.forEach(a => {
        if (a.category_2) cat2s.add(a.category_2);
    });
    
    populateDatalist('cat2List', cat2s);
}

function populateDatalist(id, set) {
    const list = $(`#${id}`);
    list.empty();
    set.forEach(val => {
        list.append(`<option value="${val}">`);
    });
}

// Helper: Formatting
function formatCurrency(num) {
    return new Intl.NumberFormat('zh-CN', { style: 'currency', currency: 'CNY' }).format(num);
}

function formatNumber(num) {
    return new Intl.NumberFormat('zh-CN', { maximumFractionDigits: 2 }).format(num);
}

// Reset form when modal closes
$('#assetModal').on('hidden.bs.modal', function () {
    $('#modalTitle').text('新增资产');
    $('#assetId').val('');
    document.getElementById('assetForm').reset();
});
</script>
{% endblock %}
