{% extends "base.html" %}

{% block title %}å¨ç§‘å¤« Copilot - è¾…åŠ©äº¤æ˜“ç³»ç»Ÿ{% endblock %}

{% block head %}
<!-- ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script>
<style>
    .signal-Spring { border-left: 4px solid #28a745; background-color: #f0fff4; }
    .signal-UT { border-left: 4px solid #dc3545; background-color: #fff0f0; }
    
    #mainChart {
        width: 100%;
        height: 600px;
    }
    
    .plan-panel {
        background-color: #f8f9fa;
        border-top: 2px solid #dee2e6;
        padding: 20px;
        margin-top: 20px;
        display: none; 
    }

    /* CSS è±å½¢å›¾ä¾‹ */
    .legend-diamond {
        display: inline-block;
        width: 8px;
        height: 8px;
        transform: rotate(45deg);
        margin-right: 6px;
        margin-bottom: 2px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <h3 class="mb-0"><i class="fas fa-robot me-2"></i>å¨ç§‘å¤« Copilot <small class="text-muted fs-6">è¾…åŠ©å†³ç­–ç³»ç»Ÿ</small></h3>
            <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#glossaryModal">
                <i class="fas fa-book-open me-1"></i>æ ¸å¿ƒä¹°å–é€»è¾‘
            </button>
        </div>
    </div>
    
    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <ul class="nav nav-tabs card-header-tabs" id="wyckoffTabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-panel" type="button">å¿«é€Ÿæœç´¢åˆ†æ</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="cache-tab" data-bs-toggle="tab" data-bs-target="#cache-panel" type="button" onclick="loadCacheList()">æœ¬åœ°æ•°æ®ä»“åº“</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-panel" type="button">ä¸Šä¼ æœ¬åœ°æ–‡ä»¶</button>
                        </li>
                    </ul>
                </div>
                <div class="card-body tab-content" id="wyckoffTabContent">
                    <!-- Tab 1: æœç´¢ -->
                    <div class="tab-pane fade show active" id="search-panel">
                        <form id="searchForm" class="row g-3 align-items-center">
                            <div class="col-auto">
                                <input type="text" class="form-control" id="searchSymbol" placeholder="ä»£ç : 600519 / AAPL" required>
                            </div>
                            <div class="col-auto">
                                <select class="form-select" id="searchMarket">
                                    <option value="china_stock">Aè‚¡ä¸ªè‚¡</option>
                                    <option value="china_etf">Aè‚¡ETF</option>
                                    <option value="hk_stock">æ¸¯è‚¡</option>
                                    <option value="us_stock">ç¾è‚¡</option>
                                </select>
                            </div>
                            <div class="col-auto">
                                <button type="submit" class="btn btn-primary" id="searchBtn">ä¸‹è½½å¹¶è¯Šæ–­</button>
                            </div>
                            <div class="col-auto">
                                <span class="text-muted small">ç³»ç»Ÿå°†è‡ªåŠ¨ç¼“å­˜æ•°æ®ï¼Œé¿å…é‡å¤ä¸‹è½½</span>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Tab 2: ç¼“å­˜åˆ—è¡¨ -->
                    <div class="tab-pane fade" id="cache-panel">
                        <div class="table-responsive" style="max-height: 200px;">
                            <table class="table table-sm table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>æ–‡ä»¶å</th>
                                        <th>æ›´æ–°æ—¶é—´</th>
                                        <th>å¤§å°</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="cacheListBody">
                                    <tr><td colspan="4" class="text-center">æ­£åœ¨åŠ è½½ç¼“å­˜...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Tab 3: ä¸Šä¼  -->
                    <div class="tab-pane fade" id="upload-panel">
                        <form id="uploadForm" class="row g-3 align-items-center">
                            <div class="col-auto">
                                <input class="form-control" type="file" id="csvFile" accept=".csv" required>
                            </div>
                            <div class="col-auto">
                                <button type="submit" class="btn btn-secondary" id="analyzeBtn">åˆ†æä¸Šä¼ æ–‡ä»¶</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»å›¾è¡¨åŒºåŸŸ -->
    <div class="row">
        <!-- å›¾è¡¨åŒºåŸŸ - ç°åœ¨å æ®å…¨å®½ -->
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <div class="d-flex flex-column gap-2">
                        <!-- ç¬¬ä¸€è¡Œï¼šç»“æ„å›¾ä¾‹ -->
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Kçº¿ç»“æ„ä¸æ ¸å¿ƒè¡Œä¸º (Spring / SOS / UT / SOW)</h5>
                            <div class="d-flex gap-3">
                                <div class="d-flex align-items-center">
                                    <span style="display:inline-block;width:12px;height:12px;background-color:rgba(40, 167, 69, 0.4);border:1px dashed rgba(40, 167, 69, 0.8);margin-right:4px;"></span>
                                    <small>å¸ç­¹ / å†å¸ç­¹ç¡®è®¤</small>
                                </div>
                                <div class="d-flex align-items-center">
                                    <span style="display:inline-block;width:12px;height:12px;background-color:rgba(220, 53, 69, 0.4);border:1px dashed rgba(220, 53, 69, 0.8);margin-right:4px;"></span>
                                    <small>æ´¾å‘ / å†æ´¾å‘ç¡®è®¤</small>
                                </div>
                                <!-- ä¿¡å·å›¾ä¾‹ -->
                                <div class="d-flex align-items-center ms-3">
                                    <span class="legend-diamond" style="background-color:#28a745;"></span>
                                    <small class="text-muted">Spring(ä¹°ç‚¹)</small>
                                </div>
                                <div class="d-flex align-items-center">
                                    <span class="legend-diamond" style="background-color:#6f42c1;"></span>
                                    <small class="text-muted">SOS(çªç ´ä¹°)</small>
                                </div>
                                <div class="d-flex align-items-center">
                                    <span class="legend-diamond" style="background-color:#dc3545;"></span>
                                    <small class="text-muted">UT(ç¦»åœºç‚¹)</small>
                                </div>
                                <div class="d-flex align-items-center">
                                    <span class="legend-diamond" style="background-color:#fd7e14;"></span>
                                    <small class="text-muted">SOW(ç ´ä½ç¦»)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="mainChart"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- æœ€æ–°å®æˆ˜é¢„æ¡ˆé¢æ¿ -->
    <div id="planPanel" class="plan-panel rounded shadow-sm">
        <div class="row">
            <div class="col-md-8 border-end">
                <h4 class="mb-3" id="planTitle"><i class="fas fa-rocket me-2"></i>æœ€æ–°é¢„æ¡ˆ</h4>
                <div id="planContent"></div>
            </div>
            <div class="col-md-4 ps-4">
                <h5 id="stopLossTitle" class="text-danger"><i class="fas fa-shield-alt me-2"></i>é£æ§é˜²çº¿</h5>
                <div class="mt-3 p-3 bg-white border rounded">
                    <p class="mb-1 text-muted small" id="stopLossLabel">è§¦å‘ä½ï¼š</p>
                    <div id="planStopLoss" class="h3 mb-0 text-danger font-monospace">--</div>
                    <p class="mt-2 mb-0 text-muted x-small text-wrap" id="stopLossDesc"></p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æœ¯è¯­æŒ‡å— Modal -->
<div class="modal fade" id="glossaryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">å¨ç§‘å¤«å®æˆ˜é€»è¾‘</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>ğŸŸ¢ Spring (ä½ä½ä¹°å…¥)</h6>
                <p class="small">ä¸»åŠ›â€œæŒ–å‘â€æ´—ç›˜ã€‚æ“ä½œï¼šåˆ†æ‰¹å…¥åœºã€‚æ­¢æŸï¼šSpringæœ€ä½ç‚¹ä¸‹æ–¹ã€‚</p>
                <hr>
                <h6>ğŸŸ£ SOS (çªç ´ä¹°å…¥)</h6>
                <p class="small">â€œè·³ç¦»è·³æ¿â€ã€‚æ”¾é‡çªç ´é˜»åŠ›ä½ï¼Œç¡®è®¤è¶‹åŠ¿å¼€å¯ã€‚æ“ä½œï¼šè¶‹åŠ¿è¿›åœº/åŠ ä»“ã€‚</p>
                <hr>
                <h6>ğŸ”´ Upthrust (é«˜ä½ç¦»åœº)</h6>
                <p class="small">ä¸»åŠ›â€œè¯±å¤šâ€å‡ºè´§ã€‚æ“ä½œï¼šè·åˆ©ç¦»åœºã€‚çº é”™ï¼šå¦‚æœä»·æ ¼ç«™ä¸Šé«˜ç‚¹ä¸Šæ–¹ï¼Œéœ€ä¹°å›è·Ÿè¿›è¶‹åŠ¿ï¼ˆè¯´æ˜æ˜¯å†å¸ç­¹ï¼‰ã€‚</p>
                <hr>
                <h6>ğŸŸ  SOW (ç ´ä½ç¦»åœº)</h6>
                <p class="small">è¶‹åŠ¿åè½¬ã€‚æ”¾é‡è·Œç ´æ”¯æ’‘ä½ã€‚æ“ä½œï¼šåšå†³æ­¢æŸ/æ¸…ä»“ã€‚</p>
            </div>
        </div>
    </div>
</div>

<script>
    let myChart = echarts.init(document.getElementById('mainChart'));
    window.addEventListener('resize', () => myChart.resize());

    // è‡ªåŠ¨è¯†åˆ«ç¾è‚¡
    document.getElementById('searchSymbol').addEventListener('input', function() {
        if (/[a-zA-Z]/.test(this.value)) {
            document.getElementById('searchMarket').value = 'us_stock';
        }
    });

    // æœç´¢å¹¶åˆ†æ
    document.getElementById('searchForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const symbol = document.getElementById('searchSymbol').value.trim();
        const market = document.getElementById('searchMarket').value;
        const btn = document.getElementById('searchBtn');
        btn.disabled = true; btn.innerHTML = 'æ­£åœ¨ä¸‹è½½æ•°æ®...';

        try {
            const res = await fetch('/api/wyckoff/download_and_analyze', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ symbol, market_type: market })
            });
            const result = await res.json();
            if (res.ok) {
                renderChart(result.chart_data);
                showTradePlan(result.chart_data.latest_plan);
            } else { alert('æœç´¢å¤±è´¥: ' + result.error); }
        } catch (error) { console.error(error); }
        finally { btn.disabled = false; btn.innerHTML = 'ä¸‹è½½å¹¶è¯Šæ–­'; }
    });

    // åŠ è½½ç¼“å­˜åˆ—è¡¨
    async function loadCacheList() {
        try {
            const res = await fetch('/api/wyckoff/cache_list');
            const result = await res.json();
            const body = document.getElementById('cacheListBody');
            body.innerHTML = '';
            if (result.files.length === 0) {
                body.innerHTML = '<tr><td colspan="4" class="text-center">æš‚æ— ç¼“å­˜æ•°æ®</td></tr>';
                return;
            }
            result.files.forEach(f => {
                body.innerHTML += `
                    <tr>
                        <td class="small fw-bold">${f.filename}</td>
                        <td class="small text-muted">${f.mtime}</td>
                        <td class="small text-muted">${f.size}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-outline-primary btn-sm py-0" onclick="analyzeFile('${f.filename}')">åŠ è½½</button>
                                <button class="btn btn-outline-danger btn-sm py-0" onclick="deleteFile('${f.filename}')"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        } catch (error) { console.error(error); }
    }

    // åˆ é™¤ç¼“å­˜æ–‡ä»¶
    async function deleteFile(filename) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${filename} å—ï¼Ÿ`)) return;
        
        try {
            const res = await fetch('/api/wyckoff/delete_cache', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ filename })
            });
            const result = await res.json();
            if (res.ok) {
                loadCacheList(); // é‡æ–°åŠ è½½åˆ—è¡¨
            } else { alert(result.error); }
        } catch (error) { console.error(error); }
    }

    // åˆ†æç¼“å­˜æ–‡ä»¶
    async function analyzeFile(filename) {
        const btn = event.target;
        btn.disabled = true; btn.innerText = '...';
        try {
            const res = await fetch('/api/wyckoff/analyze_cached', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ filename })
            });
            const result = await res.json();
            if (res.ok) {
                renderChart(result.chart_data);
                showTradePlan(result.chart_data.latest_plan);
            } else { alert(result.error); }
        } catch (error) { console.error(error); }
        finally { btn.disabled = false; btn.innerText = 'åŠ è½½'; }
    }

    // ä¸Šä¼ åˆ†æ
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData();
        formData.append('file', document.getElementById('csvFile').files[0]);
        const btn = document.getElementById('analyzeBtn');
        btn.disabled = true; btn.innerHTML = 'å¤„ç†ä¸­...';

        try {
            const res = await fetch('/api/wyckoff/analyze_csv', { method: 'POST', body: formData });
            const result = await res.json();
            if (res.ok) {
                renderChart(result.chart_data);
                showTradePlan(result.chart_data.latest_plan);
            } else { alert('é”™è¯¯: ' + result.error); }
        } catch (error) { console.error(error); } 
        finally { btn.disabled = false; btn.innerHTML = 'åˆ†æä¸Šä¼ æ–‡ä»¶'; }
    });

    function showTradePlan(plan) {
        const panel = document.getElementById('planPanel');
        if (!panel || !plan) {
            if (panel) panel.style.display = 'none';
            return;
        }
        panel.style.display = 'block';
        
        const isBullish = plan.type === 'Bullish';
        const colorClass = isBullish ? 'text-success' : 'text-danger';
        const badgeClass = isBullish ? 'bg-success' : 'bg-danger';
        
        document.getElementById('planTitle').className = `mb-3 ${colorClass}`;
        document.getElementById('planTitle').innerHTML = isBullish ? 
            '<i class="fas fa-rocket me-2"></i>æœ€æ–°ä¹°å…¥é¢„æ¡ˆ' : 
            '<i class="fas fa-exclamation-triangle me-2"></i>æœ€æ–°ç¦»åœºé¢„æ¡ˆ';

        document.getElementById('planContent').innerHTML = `
            <div class="mb-3">
                <span class="badge ${badgeClass}">${plan.date}</span>
                <span class="h5 ms-2">${plan.display_name} (${plan.code})</span>
            </div>
            <p class="lead">${plan.logic}</p>
            <div class="mt-3">
                <span class="text-muted">å»ºè®®åŠ¨ä½œï¼š</span>
                <strong class="${colorClass}">${plan.action}</strong>
            </div>
        `;

        document.getElementById('stopLossLabel').innerText = plan.stop_loss_label + 'ï¼š';
        document.getElementById('planStopLoss').innerText = plan.stop_loss.toFixed(2);
        document.getElementById('stopLossDesc').innerText = isBullish ? 
            '* å¦‚æœè·Œç ´æ­¤ä½ï¼Œè¯´æ˜å¤šå¤´é€»è¾‘å¤±è´¥ï¼Œéœ€åšå†³æ­¢æŸç¦»åœºã€‚' : 
            '* å¦‚æœä»·æ ¼åæ‰‹ç«™ç¨³æ­¤ä½ä¸Šæ–¹ï¼Œè¯´æ˜ç ´ä½å¯èƒ½æ˜¯å‡åŠ¨ä½œï¼Œåº”è€ƒè™‘ä¹°å›ã€‚';
    }

    function renderChart(data) {
        const markPointData = [];
        const markLineData = []; 
        const markAreaData = [];

        // 1. å¤„ç†ä¿¡å·ç‚¹å’Œæ­¢æŸçº¿
        if (data.signals && data.signals.length > 0) {
            const latestSig = data.signals[data.signals.length - 1];
            
            // é¢œè‰²æ˜ å°„
            const colorMap = {
                'Spring': '#28a745', // ç»¿
                'SOS': '#6f42c1',    // ç´«
                'UT': '#dc3545',     // çº¢
                'SOW': '#fd7e14'     // æ©™
            };
            
            const color = colorMap[latestSig.code] || '#007bff';
            
            markPointData.push({
                coord: [latestSig.date, latestSig.price],
                itemStyle: { color: color },
                symbol: 'diamond', 
                symbolSize: 15,
                tooltip: { formatter: `<b>${latestSig.name}</b><br/>${latestSig.logic}` }
            });

            // åªä¿ç•™å”¯ä¸€çš„è­¦æˆ’ä½çº¢çº¿
            markLineData.push({
                yAxis: latestSig.stop_loss,
                lineStyle: { color: '#ff0000', type: 'dotted', width: 2 },
                label: { show: true, position: 'end', formatter: 'è­¦æˆ’ä½: {c}', color: '#ff0000' }
            });
        }

        // 2. å¤„ç†å‘¨æœŸç®±ä½“
        if (data.zones && data.zones.length > 0) {
            data.zones.forEach(zone => {
                const borderColor = zone.color.replace(/0\.\d+\)$/, '0.6)'); 
                markAreaData.push([
                    {
                        xAxis: zone.start,
                        yAxis: zone.resistance, 
                        itemStyle: { 
                            color: zone.color,
                            borderWidth: 1,
                            borderColor: borderColor, 
                            borderType: 'dashed'
                        },
                        label: { show: false }
                    },
                    {
                        xAxis: zone.end,
                        yAxis: zone.support 
                    }
                ]);
            });
        }

        myChart.setOption({
            tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
            legend: { data: ['Kçº¿', 'æˆäº¤é‡'] },
            grid: [ { left: '3%', right: '3%', height: '70%' }, { left: '3%', right: '3%', top: '82%', height: '12%' } ],
            xAxis: [ 
                { type: 'category', data: data.dates, scale: true, axisLine: { onZero: false } },
                { type: 'category', gridIndex: 1, data: data.dates, axisLabel: { show: false } }
            ],
            yAxis: [ { scale: true }, { scale: true, gridIndex: 1, axisLabel: { show: false } } ],
            dataZoom: [{ type: 'inside', start: 70, end: 100 }, { type: 'slider', start: 70, end: 100 }],
            series: [
                {
                    name: 'Kçº¿', type: 'candlestick', data: data.data,
                    markPoint: { data: markPointData },
                    markLine: { data: markLineData, symbol: 'none' },
                    markArea: { data: markAreaData, silent: true }
                },
                { name: 'æˆäº¤é‡', type: 'bar', xAxisIndex: 1, yAxisIndex: 1, data: data.volumes, itemStyle: { color: '#7fbe9e' } }
            ]
        }, true);
    }
</script>
{% endblock %}
