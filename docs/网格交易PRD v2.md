# 📝 模块需求文档：SmartGrid 策略生成器 (v2.1)

## 1. 模块概述 (Module Overview)
* **模块定位**：宿主交易系统中的“策略辅助决策”子模块。
* **核心功能**：基于日线行情数据（OHLC）和用户录入的估值数据，自动计算适配当前波动率的网格参数，并提供日线级别的策略回测验证。
* **输入对象**：A 股场内 ETF 代码（宿主系统提供）。
* **输出对象**：结构化的网格挂单表（JSON/CSV），包含买卖价格、数量序列。

---

## 2. 数据交互规范 (Data Interaction)

本模块不直接连接外部 API，所有数据通过宿主系统的 `DataService` 获取。

### 2.1 输入数据需求
模块运行时，需向宿主系统请求以下数据对象：

1.  **基础行情 (`MarketData`):**
    * `symbol`: 标的代码
    * `period`: 日线 (Daily)
    * `adjust`: **前复权 (Forward Adjusted)** [重要：必须复权，否则回测失效]
    * `start_date`: 默认为 T-365 (1年)，可配置 T-3年。
    * `fields`: `date`, `open`, `high`, `low`, `close`

2.  **人工补充数据 (`ManualInput`):**
    * *前端表单录入，非系统获取*
    * `current_pe_percentile`: 当前 PE 百分位 (0-100)
    * `current_pb_percentile`: 当前 PB 百分位 (0-100)
    * `total_capital`: 计划投入总资金
    * `base_position_ratio`: 底仓比例 (0.0 - 1.0)

---

## 3. 核心算法逻辑 (Core Algorithms)

此部分为开发核心，需严格按公式实现。

### 3.1 波动率计算 (Volatility Engine)
* **TR (True Range) 计算**:
    $$TR = Max(High - Low, |High - PreClose|, |Low - PreClose|)$$
* **ATR (Average True Range)**:
    $$ATR(N) = MA(TR, N)$$
    * *参数 N*: 默认 14。
* **布林带 (Bollinger Bands)**:
    * 中轨: $MA(Close, 20)$
    * 上轨: $Mean + 2 * StdDev$
    * 下轨: $Mean - 2 * StdDev$

### 3.2 策略模式判定 (Strategy Mode Selector)
根据用户输入的 `PE/PB 百分位` 和系统计算的 `ATR`，自动推荐模式：

| 判定条件 (逻辑与) | 推荐模式 | 参数特征 |
| :--- | :--- | :--- |
| 估值 < 20% | **潜伏积累 (Accumulate)** | 买入量 > 卖出量 (1.2:1)，宽底 |
| 20% ≤ 估值 ≤ 70% | **标准震荡 (Neutral)** | 买入量 = 卖出量，标准网格 |
| 估值 > 70% | **趋势/防卖飞 (Trend)** | 买入量 > 卖出量，或区间大幅上移 |

### 3.3 参数生成逻辑 (Parameter Generator)

#### A. 区间计算 (Range)
* **上限 ($P_{max}$)** = $min(布林上轨, 最近60日最高价)$
* **下限 ($P_{min}$)** = $max(布林下轨, 最近60日最低价)$
* *例外处理：* 若选择“天地单”模式，则取历史极值。

#### B. 步长计算 (Step) - **等比网格 (Geometric)**
* **基准步长比率 ($Ratio$)** = $ATR(14)$ / 当前价格
    * 若计算值过小，默认 1%。
* **格数 ($N_{grids}$)** = $log(P_{max} / P_{min}) / log(1 + Ratio)$
    * *约束：* 若 $N_{grids} < 10$，强制 $Ratio = (P_{max} / P_{min})^{(1/10)} - 1$ (保证至少切分10格)。
* **网格生成公式**: $Price_i = P_{min} \times (1 + Ratio)^i$

#### C. 单格资金分配 (Position Sizing)
* **可动用资金** = `total_capital` * (1 - `base_position_ratio`)
* **单格金额** = 可动用资金 / $N_{grids}$
* **单格股数 ($Vol_{per\_grid}$)** = 单格金额 / 当前价格 (向下取整到 100 股，若不足 100 则保底 100)

#### D. 买卖序列生成 (Order Book)
* $BuyVol_i$ 与 $SellVol_i$ 根据 **3.2 策略模式** 调整系数。
    * *Neutral:* Buy = Sell = $Vol_{per\_grid}$
    * *Accumulate/Trend:* Buy = $1.2 * Vol_{per\_grid}$, Sell = $0.8 * Vol_{per\_grid}$

### 3.4 波动率评分 (Volatility Score)
新增量化评分模块，辅助判断标的适格性 (0-100分)。
1.  **Beta 系数 (50分)**: 过去 90 天相对于沪深300的弹性。
    *   Beta > 1.2 (+40分), > 1.5 (+50分).
2.  **平均振幅 (50分)**: 过去 30 天日均振幅。
    *   振幅 > 2% (+50分), > 1.5% (+30分).

---

## 4. 回测引擎逻辑 (Backtest Engine - Daily)

**核心架构变更：策略生成与回测分离**
*   **策略建议**：基于**当前**最新数据生成，用于未来实盘。
*   **历史回测**：基于**回测开始日**（如1年前）的数据重新生成当时的网格参数，模拟“如果当时开始跑策略会怎样”。

### 4.1 撮合机制 (Path Simulation)
1.  **初始建仓 (Auto Base Position)**:
    *   回测开始时，根据开始价格在网格中的位置，**自动计算并买入底仓**。
    *   *逻辑*：假设价格处于网格 60% 分位，则买入下方 60% 网格对应的筹码，以便后续上涨时有货可卖。
2.  **路径假设**: Open -> Low/High -> Close (同前)。
3.  **网格状态机 (State Machine)**:
    *   **买入限制**: 仅当网格处于 `EMPTY` 状态时才买入，买入后标记为 `HOLDING`。
    *   **卖出限制**: 仅当**下方一格**处于 `HOLDING` 状态时才卖出，卖出后标记下方网格为 `EMPTY`。
    *   *目的*: 严格执行“买入-卖出”配对，防止单边重复交易。
4.  **触发修正**:
    *   **宽松触网**: 卖出条件改为 $High \ge GridPrice$ (取消 0.1% 穿透要求，适应低波标的)。

### 4.2 回测产出指标
* **绩效仪表盘**: 包含 总收益率、年化收益、最大回撤、夏普比率 (Sharpe Ratio)。
* **对比基准**: 自动计算 Buy & Hold 策略的同维度指标，并展示差异。
* **网格特有**: 网格利润、破网率、交易次数。

---

## 5. 前端功能交互 (UI/UX Logic)

### 5.1 配置面板
*   支持输入 PE/PB 百分位、资金、底仓比例。
*   **高级设置**: 折叠显示，包含强制模式选择。

### 5.2 结果面板
1.  **波动率评分卡片**: 展示 Beta、振幅及综合得分进度条。
2.  **策略建议方案 (默认折叠)**: 展示当前推荐的区间、等比步长、单格资金。
3.  **历史回测验证**:
    *   **绩效仪表盘**: 整合显示的表格，对比策略与基准。
    *   **策略收益曲线 (默认折叠)**: 策略净值 vs 基准净值曲线。
    *   **价格走势与网格区间**: 
        *   显示 K 线图 + 布林带 (上/中/下轨)。
        *   叠加历史回测时的网格线 (红绿虚线)。
        *   标记具体 **买入点 (B-蓝三角)** 和 **卖出点 (S-紫三角)**。
    *   **成交记录明细**: 逐笔交易列表，包含持仓、现金及总资产快照。

---

## 6. 开发注意事项 (Dev Notes)

1.  **复权陷阱**: 必须反复确认宿主系统传入的数据是**前复权**数据。不复权的数据会导致回测中因分红/拆股产生的巨大价格缺口，导致网格逻辑崩盘。
2.  **精度控制**: 价格计算保留 3 位小数 (ETF 最小变动 0.001)，股数向下取整到 100 的倍数。
3.  **性能**: 日线回测计算量极小，建议在该模块加载时**实时计算**，无需预处理存储。
4.  **状态保持**: 回测时需维护一个虚拟账户对象 `VirtualAccount`，包含 `cash`, `positions dict {price_level: volume}`，严禁使用“未来函数”。

---

## 7. 验收标准 (Acceptance Criteria)
1.  **数据准确性**: 能够正确读取宿主系统的 K 线数据，ATR 计算结果与主流软件（如通达信/同花顺）误差 < 1%。
2.  **逻辑自洽**: 在极端行情（如连续一字涨停/跌停）下，回测引擎不应报错，且不应产生错误的“穿透成交”。
3.  **参数合理**: 针对低波 ETF（如银行）生成的网格应当比高波 ETF（如券商）更密集。
4.  **输出可用**: 导出的 CSV 文件格式清晰，用户可直接理解并用于实盘挂单。