# 美股波动率分析设计文档

## 1. 项目概述

本项目旨在开发一个美股波动率分析工具，能够从数据库中获取指定美股的历史价格数据，计算并分析其波动率。该工具将支持生成不同时间周期的波动率统计数据，并将结果存储在数据库中。

## 2. 数据库设计

### 2.1 数据库文件

- 数据库路径：`db/us_stock.db`

### 2.2 数据表结构

#### 2.2.1 stock_prices 表

| 字段名       | 数据类型               | 约束          | 说明       |
|--------------|------------------------|---------------|------------|
| stock_code   | VARCHAR(10)            | NOT NULL      | 股票代码   |
| market_type  | VARCHAR(10)            | NOT NULL      | 市场类型（US:美股, HK:港股） |
| date         | DATE                   | NOT NULL      | 日期       |
| open_price   | REAL                   |               | 开盘价     |
| close_price  | REAL                   |               | 收盘价     |
| 主键         | (stock_code, market_type, date) |     |            |

#### 2.2.2 stock_volatility_stats 表

| 字段名       | 数据类型               | 约束          | 说明       |
|--------------|------------------------|---------------|------------|
| stock_code   | VARCHAR(10)            |               | 美股股票代码 |
| calc_date    | DATE                   |               | 计算日期   |
| monthly_stats | TEXT                  |               | 月波动统计数据（JSON格式） |
| weekly_stats  | TEXT                  |               | 周波动统计数据（JSON格式） |
| 主键         | (stock_code, calc_date)|               |            |

### 2.3 波动率数据结构

#### 2.3.1 月度和周度波动率统计

在 `stock_volatility_stats` 表中，波动率统计数据将以 JSON 格式存储，包含以下字段：

- **monthly_stats**: 
  - 包含不同时间周期的月波动率统计数据。
  - 示例结构：
    ```json
    {
      "1_month": {
        "max_gain": 0.05,
        "min_gain": 0.01,
        "avg_gain": 0.02,
        "median_gain": 0.03,
        "q1_gain": 0.01,
        "q2_gain": 0.03,
        "q3_gain": 0.04,
        "max_loss": -0.04,
        "min_loss": -0.01,
        "avg_loss": -0.02,
        "median_loss": -0.03,
        "q1_loss": -0.05,
        "q2_loss": -0.03,
        "q3_loss": -0.01
      },
      "3_months": { ... },
      "6_months": { ... },
      "12_months": { ... },
      "36_months": { ... },
      "60_months": { ... },
      "120_months": { ... }
    }
    ```

- **weekly_stats**: 
  - 包含不同时间周期的周波动率统计数据。
  - 示例结构：
    ```json
    {
      "1_month": {
        "max_gain": 0.03,
        "min_gain": 0.00,
        "avg_gain": 0.01,
        "median_gain": 0.02,
        "q1_gain": 0.00,
        "q2_gain": 0.02,
        "q3_gain": 0.02,
        "max_loss": -0.02,
        "min_loss": -0.01,
        "avg_loss": -0.01,
        "median_loss": -0.01,
        "q1_loss": -0.03,
        "q2_loss": -0.01,
        "q3_loss": 0.00
      },
      "3_months": { ... },
      "6_months": { ... },
      "12_months": { ... },
      "36_months": { ... },
      "60_months": { ... },
      "120_months": { ... }
    }
    ```

#### 2.3.2 内容说明

- **max_gain**: 在指定周期内的最大涨幅。
- **min_gain**: 在指定周期内的最小涨幅。
- **avg_gain**: 在指定周期内的平均涨幅。
- **median_gain**: 在指定周期内的涨幅中位数。
- **q1_gain**: 在指定周期内的涨幅第一四分位数。
- **q2_gain**: 在指定周期内的涨幅中位数（50%）。
- **q3_gain**: 在指定周期内的涨幅第三四分位数。
- **max_loss**: 在指定周期内的最大跌幅。
- **min_loss**: 在指定周期内的最小跌幅。
- **avg_loss**: 在指定周期内的平均跌幅。
- **median_loss**: 在指定周期内的跌幅中位数。
- **q1_loss**: 在指定周期内的跌幅第一四分位数。
- **q2_loss**: 在指定周期内的跌幅中位数（50%）。
- **q3_loss**: 在指定周期内的跌幅第三四分位数。

## 3. 功能设计

### 3.1 数据获取

- 使用 `yfinance` 库从 Yahoo Finance 下载指定股票的历史价格数据。
- 数据包括开盘价、收盘价等信息。

### 3.2 波动率计算

- 计算日收益率，并根据日收益率计算月度和周度波动率。
- 统计数据包括：
  - 整体波动率
  - 上行波动率（上涨时的波动率）
  - 下行波动率（下跌时的波动率）
  - 各个分位数的统计值（如25%、50%、75%、90%）

### 3.3 数据存储

- 将计算得到的波动率统计数据以 JSON 格式存储在 `stock_volatility_stats` 表中。
- 在插入数据之前，检查数据是否已存在，避免重复插入。

### 3.4 页面交互设计

#### 3.4.1 下载页面

- 提供输入框或选择框，允许用户输入或选择要下载的美股代码。
- 用户点击下载按钮后，系统将自动下载指定股票的历史价格数据，并存储到数据库中。

#### 3.4.2 列表管理页面

- 显示已下载的美股列表，包含以下栏目：
  - 股票代码
  - 下载时间
  - 波动率（如果已生成）
- 如果波动率已生成，显示"显示"按钮，点击后展示不同统计周期的月波动率和周波动率数据，使用箱线图展示，并在模态弹窗中显示。
- 如果波动率未生成，显示"生成"按钮，点击后执行生成操作，完成后将按钮替换为"显示"按钮。

## 4. 使用方法

1. 生成所有股票的波动率数据：
   ```bash
   python tools/volatility_data_generator.py
   ```

2. 生成指定股票的波动率数据：
   ```bash
   python tools/volatility_data_generator.py --etf 510050 510300
   ```

## 5. 依赖库

- `pandas`
- `numpy`
- `scipy`
- `yfinance`
- `flask` (用于API接口)
- `echarts` (用于图表展示)

## 6. 未来工作

- 增加前端展示功能，提供可视化的波动率分析结果。
- 扩展支持更多的股票数据源。
- 增加用户自定义参数的功能，以便用户可以选择不同的计算周期和统计指标。
