# A股资产全景管理系统需求文档 (PRD) v1.1

## 1. 项目背景
用户分散在多个交易渠道（券商账户、支付宝、银行卡等）持有不同类型的 A 股市场资产（股票、场内 ETF、场外基金、现金）。用户不仅需要按账户汇总，更需要**跨越市场类型（场内/场外），按照底层的投资策略（如“沪深300”、“红利策略”）进行统一的资产归类分析**。

本项目旨在构建一个自动化的个人资产全景仪表盘。

## 2. 核心功能需求

### 2.1 资产录入与管理 (CRUD)
用户需要一个界面来维护资产清单，核心在于支持**自定义策略分类**。

*   **字段定义**：
    1.  **账户名称 (`account_name`)**：资产所在位置，如“华泰证券”、“支付宝”。
    2.  **资产技术类型 (`asset_type`)**：**决定数据来源**。
        *   `stock`: 个股 (实时行情)
        *   `etf`: 场内ETF (实时行情)
        *   `fund`: 场外基金 (净值 T-1)
        *   `cash`: 现金 (固定值)
    3.  **两级分类管理**：**决定分析维度**。
        *   **一级分类 (`category_1`)**：大类资产划分。如：股票、债券、基金、现金。
        *   **二级分类 (`category_2`)**：细分策略或投资对象。
            *   *基金细分举例*：沪深 300、中证 500、红利、固收、纯债等。
            *   *场景举例*：场内的 510300 和场外的 000311 一级分类填“基金”，二级分类均可填“沪深 300”。
    4.  **标的代码 (`symbol`)**：`600519`, `000123` 等。
    5.  **标的名称 (`name`)**：自动回填/手动修改。
    6.  **持有份额 (`quantity`)**。
    7.  **持仓成本 (`cost_price`)**。

*   **交互要求**：
    *   `category_1` 应提供下拉选择（股票/债券/基金/现金/其他）。
    *   `category_2` 输入框应支持**自动补全**（根据已有的分类推荐），避免手误导致分类碎片化。

### 2.2 自动行情获取 (Akshare)
*   **股票/场内ETF**：调用实时接口（如 `stock_zh_a_spot_em`），获取 `current_price`。
*   **场外基金**：调用基金净值接口（如 `fund_open_fund_info_em`），获取 `net_value`。
    *   *注*：总资产计算采用混合模式（实时股价 + 昨晚基金净值）。
*   **现金**：价格恒定为 1。

### 2.3 资产全景仪表盘 (Dashboard)

#### A. 核心指标
*   总资产 (Total Assets)
*   总本金 (Total Cost)
*   总浮动盈亏 (Total P&L)

#### B. 多维可视化 (ECharts)
需要提供四个维度的饼图/环形图切换：
1.  **按一级分类 (By Category 1)** - **新增**
    *   展示：股票 (50%)、基金 (30%)、债券 (10%)、现金 (10%)。
2.  **按二级分类 (By Category 2)** - **核心视图**
    *   展示：沪深 300 (30%)、红利策略 (20%)、纯债 (10%)...
    *   逻辑：聚合具有相同 `category_2` 的所有资产市值。
3.  **按账户分布 (By Account)**
    *   展示：华泰证券 (60%)、支付宝 (40%)...
4.  **按资产形态 (By Asset Class)**
    *   展示：股票、ETF、场外基金、现金（技术类型维度）。

#### C. 持仓明细表
*   支持按上述维度进行**分组 (Group By)** 展示。
*   行数据：名称、代码、一级分类、二级分类、持有市值、盈亏、当日涨跌(仅场内品种)。

## 3. 技术实现方案

### 3.1 数据库设计 (SQLite)
修改表结构，增加两级分类字段。

**表名：`asset_holdings`**

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `id` | INTEGER | 主键 |
| `account_name` | TEXT | 账户 (如：华泰) |
| `asset_type` | TEXT | 技术类型 (stock/etf/fund/cash) |
| `category_1` | TEXT | **[新增] 一级分类 (股票/债券/基金等)** |
| `category_2` | TEXT | **[新增] 二级分类 (沪深300/红利等)** |
| `symbol` | TEXT | 代码 |
| `name` | TEXT | 名称 |
| `quantity` | REAL | 持有数量 |
| `cost_price` | REAL | 成本价 |
| `update_time` | DATETIME | 记录时间 |

### 3.2 接口与路由
*   `GET /portfolio`: 渲染主页。
*   `GET /api/portfolio/data`: 获取计算后的全量数据（包含现价、市值、分类汇总数据）。
*   `POST /api/portfolio/asset`: 新增/修改。
*   `DELETE /api/portfolio/asset/<id>`: 删除。
*   `POST /api/portfolio/refresh`: 强制刷新价格缓存。

## 4. 开发计划
1.  **DB层**：创建新表，编写 CRUD 函数。
2.  **Service层**：编写价格获取逻辑（区分 Stock/Fund）。
3.  **Web层**：
    *   实现数据录入 Modal（带分类联想）。
    *   实现 ECharts 动态切换逻辑（处理不同维度的 GroupBy）。