# ETF 均线乖离率分析系统需求文档 (PRD)

## 1. 项目背景
基于【广发策略】的研究报告《如何区分主线是调整还是终结？》，该报告提出了一种利用 **20日均线乖离率 (Deviation Rate)** 来判断市场主线趋势强弱、过热及见顶信号的方法。
用户希望在现有 ETF 交易系统中集成此功能，利用已有的网格交易数据源，实现对指定 ETF 的乖离率计算、可视化及交易信号提示。

## 2. 核心概念与公式

### 2.1 均线偏离度 (Deviation Rate)
虽然原文提到公式为 `(对数收盘价/20日EMA)-1`，但结合文中给出的阈值（如 2%、0.6%）以及通用技术分析惯例，我们建议采用标准百分比乖离率公式，以便于直观理解和计算：
*   **公式**：$Bias = \frac{Close - EMA_{20}}{EMA_{20}}$
*   **基准线**：EMA20 (20日指数移动平均线)

### 2.2 趋势与区间判定
根据报告，市场状态划分为以下四个区间：

| 区间名称 | 偏离度范围 | 市场含义 | 建议操作 |
| :--- | :--- | :--- | :--- |
| **过热区间 (Overheated)** | $> 2\%$ | 短期涨幅过大，容易回调 | **止盈/减仓**，不宜追高 |
| **良性/入场区间 (Safe)** | $0.6\% \sim 1.8\%$ | 趋势强劲且稳健 | **加仓/持有**，最佳入场点 |
| **转弱/观察区间 (Weak)** | $0\% \sim 0.6\%$ | 趋势放缓或震荡 | **观望/持有**，若跌破均线需警惕 |
| **危险区间 (Danger)** | $<-0.6\%$ | 趋势可能终结或深幅调整 | **止损/离场**，大幅跌穿均线 |

*注：区间 $-0.6\% \sim 0\%$ (刚刚跌破均线) 通常视为“假摔”或正常调整，建议坚守，除非继续下跌进入危险区间。*

## 3. 功能需求

### 3.1 数据源
*   **复用模块**：复用现有 `grid` 模块中的数据获取逻辑。
*   **数据库表**：`grid_trade` (包含 date, open, high, low, close, volume)。
*   **数据获取**：支持输入 ETF 代码，系统检查本地是否有数据，无数据则调用现有的下载接口获取。

### 3.2 界面设计 (UI/UX)
新建独立页面 `/etf_deviation`，包含以下模块：

1.  **控制栏**：
    *   输入框：输入 ETF 代码 (如 510300)。
    *   按钮：“分析趋势”。
    *   *可选：时间范围选择 (近半年、近一年)。*

2.  **核心指标看板**：
    *   显示当前最新日期的收盘价、EMA20 价格。
    *   **高亮显示当前偏离度** (例如：`1.35%`)。
    *   **当前状态标签**：根据偏离度数值，显示对应状态（如“🟢 良性区域 - 建议持仓”）。

3.  **交互式图表 (ECharts)**：
    *   **主图**：K线图 + EMA20 均线。
    *   **副图**：偏离度曲线 (Bias)。
        *   在副图中绘制四条水平参考线：2%, 1.8%, 0.6%, -0.6%。
        *   不同区间填充不同背景色以便区分。

4.  **策略指南 (Tips)**：
    *   在页面底部或侧边栏，摘录文档中的核心逻辑作为“决策辅助小贴士”。
    *   *文案示例*：“历史经验表明，当偏离度超过 2% 时，追高胜率显著下降；当回落至 0.6%-1.8% 区间时，往往是趋势延续的买点...”

### 3.3 后端逻辑
*   **计算逻辑**：
    1.  从 DB 读取历史 K 线数据。
    2.  计算 `EMA20` (pandas `ewm(span=20)`).
    3.  计算 `Bias = (Close - EMA20) / EMA20`.
    4.  生成最近 N 天的分析数据返回前端。

## 4. 开发计划
1.  **后端 API 开发**：实现数据读取、指标计算接口。
2.  **前端页面开发**：搭建页面框架，集成 ECharts 图表。
3.  **联调与验证**：使用几个典型 ETF (如纳指、沪深300) 验证计算结果与区间判断的准确性。

## 5. 待确认事项
*   **公式确认**：是否同意使用 `(Close - EMA20) / EMA20` 作为标准公式？(原文档 "对数收盘价" 可能为笔误或特定量化处理，但在 ETF 交易中百分比乖离率更通用)。
*   **数据频次**：默认使用**日线**数据进行分析。

---
请确认以上需求文档，确认无误后我们将开始编码。
