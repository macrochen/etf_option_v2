# 需求文档：A 股 ETF 网格交易回测与分析系统 (Grid-X System)

| 文档版本 | V1.3 |
| --- | --- |
| **设计者** | Claude Shannon |
| **核心理念** | 波动率捕获、几何级数增长、鲁棒性优先 |
| **适用市场** | A 股 ETF（T+1 制度，无印花税，低佣金） |

---

## 1. 产品背景与目标

* **背景**：大多数网格策略死于参数过拟合和对极端行情的忽视。
* **目标**：
1. **验证性**：通过高精度（1min）回测，验证特定 ETF 在特定参数下的夏普比率是否优于“买入持有”。
2. **指导性**：通过“参数热力图”寻找参数的“鲁棒高原”，而非单一的最优解，指导实盘参数设置。

---

## 2. 核心逻辑设定（后端 Python）

### 2.1 账户与费率模型

这是系统的物理法则，必须严格硬编码。

* **交易费率 (银河证券)**：
    *   **买入**：`Amount * 0.00006` (万分之 0.6，无最低 5 元限制)。
    *   **卖出**：`Amount * 0.00006` (万分之 0.6，无印花税，无最低 5 元限制)。
    *   *备注：高频低费率环境对于网格交易极其有利。*

* **T+1 库存管理（核心难点）**：
    *   系统需维护两个库存变量：`free_shares`（可用持仓）和 `frozen_shares`（当日买入冻结）。
    *   **规则**：当日 `frozen_shares` 不能卖出。收盘后，`frozen_shares` 转入 `free_shares`。

### 2.2 网格算法引擎

* **网格类型**：**等比数列 (Geometric Sequence)**。
    *   *拒绝等差网格，确保每一格的资金效率恒定。*

* **非对称设计（独立挂单制 Independent Orders）**：
    *   **买入动作**与**卖出动作**严格解耦。
    *   **网格线 (Grid Lines)**：仅充当**捕鱼网的刻度**。当价格触碰网格线时，触发买入信号。
    *   **卖出单 (Sell Orders)**：每一笔成交的买单 ($P_{buy}$)，都会立即生成一个携带基因的卖单 ($P_{sell} = P_{buy} \times (1 + \text{sell\_gap})$)。
    *   **LIFO 原则**：若价格在震荡，优先卖出**最近买入**的那一笔，以提高资金周转率。

* **触发机制**：
    *   基于 `1min` 数据的 `Close` 价判断成交。
    *   *高阶修正*：如果 1 分钟内的 `Low` < 买单价 < `High`，视为成交。

* **复利模式**：
    *   **单利模式 (Simple Interest)**：赚取的网格利润保留在现金池中，不自动投入下一次买入。防止在下跌过程中因复利导致破产风险指数级上升。

### 2.3 资产配置模型 (V1.3 核心升级)

采用**正交化**的顶层资金分配，彻底解耦长线与短线逻辑。

* **信仰仓 (Faith Position)**：
    *   **定义**：打死不卖的压舱石，享受长期国运 Beta。
    *   **配置**：`Total_Capital * Faith_Ratio` (如 20%)。
    *   **逻辑**：T=0 买入后锁死，不参与 LIFO 栈卖出。

* **网格仓 (Grid Inventory)**：
    *   **定义**：预置的初始货架，用于在未来上涨中分批变现。
    *   **配置**：`Total_Capital * Grid_Ratio` (如 30%)。
    *   **逻辑**：
        1.  T=0 买入。
        2.  **阶梯切分**：将总份额切分为 $N$ 个标准格。
        3.  **虚拟成本**：赋予阶梯状成本 $P_{0}, P_{0}(1+g), \dots$，**倒序压入 LIFO 栈**。
        4.  **效果**：栈顶为最低价筹码。一旦价格上涨，立即开始逐格止盈。

* **现金池 (Cash Buffer)**：
    *   剩余资金 (如 50%)，用于应对未来的网格下跌买入。

---

## 3. 功能需求详情

### 3.1 模块一：数据输入与清洗

* **输入**：
    *   ETF 代码 (如 `510300`)
    *   时间范围 (`Start_Date` ~ `End_Date`)
    *   初始本金 (`Initial_Capital`)

* **数据源**：
    *   **纯真实数据模式**：严格读取本地 SQLite 中的 1 分钟线数据。
    *   **下载与更新**：提供独立接口 `/api/shannon/download_data` 支持手动预热数据。
    *   **数据修复**：自动检测并修复 `Open=0` 的脏数据（用 `Close` 填充）。

* **除权除息处理**：必须使用**前复权**数据，否则分红造成的缺口会误触发网格买入。

### 3.2 模块二：高精度回测引擎 (Backtest Engine)

这是系统的“大脑”。

* **输入参数**：
    *   网格密度 (`Grid_Density`)：例如 1.5%
    *   区间下限 (`Lower_Limit`)：例如 0.800
    *   区间上限 (`Upper_Limit`)：例如 1.500
    *   单格买入金额 (`Position_Per_Grid`)：固定金额。
    *   **信仰仓占比** (`Faith_Ratio`)：百分比。
    *   **网格仓占比** (`Grid_Ratio`)：百分比。

* **输出数据流**：
    *   每日净值曲线 (Equity Curve)。
    *   每日现金历史 (Cash History) -> 用于计算资金利用率。
    *   交易明细表（含 Total Shares 和 Total Equity）。

### 3.3 模块三：参数热力图 (The Heatmap)

* **逻辑**：
    *   遍历 `Grid_Density` (X轴)：从 0.5% 到 5.0%，步长 0.1%。
    *   遍历 `Sell_Gap` (Y轴)：从 0.5% 到 5.0%。
    *   **Z 轴 (颜色)**：**总收益率 (Total Return)**。
    *   **性能优化**：通过 `Numba` JIT 编译技术加速回测核心循环，确保在数秒内完成数百次全量历史数据的回测。

### 3.4 模块四：评估指标看板

* **绝对收益**：`Total_Return` (%) (含基准对比)
* **风险收益比**：`Sharpe_Ratio`
* **最大回撤**：`Max_Drawdown` (%) (含基准对比)
* **套牢时长**：`Max_Underwater_Days` (净值创新高所需最长天数)。
* **资金效率**：`Avg_Cash_Utilization` (平均仓位占比)。

---

## 4. 前端交互界面 (UI/UX) 建议

### 4.1 布局逻辑 (上下结构)

1.  **Top Block (控制台)**：
    *   紧凑排布参数，支持折叠。
    *   集成数据加载、日期选择、参数配置。
    *   **智能填充**：选择日期后，自动根据 $P_{start}$ 推荐上下限 (0.7/1.3)。

2.  **Bottom Block (结果展示)**：
    *   **Row 1**: 核心指标看板 + 参数热力图。
    *   **Row 2**: 价格走势复盘图 (日K线 + 买卖点 + 战场边界线)。
    *   **Row 3**: 交易明细列表 (时间正序，字段详尽)。

---

## 5. 异常边界情况处理 (Edge Cases)

1.  **穿仓保护**：
    *   如果 $P < Lower\_Limit$，程序**停止买入**，保留现金。

2.  **卖飞处理**：
    *   如果 $P > Upper\_Limit$，程序**清空网格仓位** (Free + Frozen)，**仅保留信仰底仓**。
    *   系统进入“休眠”状态，直到价格跌回。

3.  **资金不足**：
    *   当触发买入信号但现金不足时，记录为 Missed Trade，不执行操作。

---
